{% extends 'gestion/base.html' %}
{% load dietetica_tags %}

{% block title %}Dashboard | LINO SYS{% endblock %}

{% block header %}
<div class="lino-page-header">
    <div class="lino-page-header__content">
        <h1 class="lino-page-header__title">Dashboard</h1>
        <p class="lino-page-header__subtitle">Panel de control general del sistema</p>
    </div>
</div>
{% endblock %}

{% block content %}

<!-- Banner de Alertas Cr칤ticas usando nuevo sistema -->
{% if productos_sin_stock > 0 or materias_stock_critico > 0 %}
<div class="lino-alert lino-alert--warning mb-4" role="alert">
    <div class="lino-alert__content">
        <i class="bi bi-exclamation-triangle-fill lino-alert__icon"></i>
        <div class="lino-alert__text">
            <strong>춰Atenci칩n!</strong> 
            {% if productos_sin_stock > 0 %}{{ productos_sin_stock }} producto(s) sin stock{% endif %}
            {% if productos_sin_stock > 0 and materias_stock_critico > 0 %} y {% endif %}
            {% if materias_stock_critico > 0 %}{{ materias_stock_critico }} materia(s) prima(s) en stock cr칤tico{% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- KPIs Principales usando nuevo sistema LINO Design System V3 -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="lino-kpi-card lino-kpi-card--success">
            <div class="lino-kpi-card__header">
                <h3 class="lino-kpi-card__title">Ingresos del Mes</h3>
                <div class="lino-kpi-card__icon">
                    <i class="bi bi-cash-stack"></i>
                </div>
            </div>
            <div class="lino-kpi-card__content">
                <div class="lino-kpi-card__value">{{ ingresos_mes|floatformat:0|default:"0" }}</div>
                <div class="lino-kpi-card__currency">ARS $</div>
                <div class="lino-kpi-card__trend lino-kpi-card__trend--up">
                    <i class="bi bi-arrow-up"></i>
                    <span>{{ tendencia_ingresos|default:"0" }}%</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="lino-kpi-card lino-kpi-card--primary">
            <div class="lino-kpi-card__header">
                <h3 class="lino-kpi-card__title">Productos en Stock</h3>
                <div class="lino-kpi-card__icon">
                    <i class="bi bi-boxes"></i>
                </div>
            </div>
            <div class="lino-kpi-card__content">
                <div class="lino-kpi-card__value">{{ total_productos|default:"0" }}</div>
                <div class="lino-kpi-card__subtitle">
                    {% if productos_stock_bajo_count > 0 %}
                        <span class="text-warning">{{ productos_stock_bajo_count }} con stock bajo</span>
                    {% else %}
                        <span class="text-success">Stock normal</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="lino-kpi-card lino-kpi-card--danger">
            <div class="lino-kpi-card__header">
                <h3 class="lino-kpi-card__title">Productos Cr칤ticos</h3>
                <div class="lino-kpi-card__icon">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                </div>
            </div>
            <div class="lino-kpi-card__content">
                <div class="lino-kpi-card__value">{{ materias_stock_critico|default:"0" }}</div>
                <div class="lino-kpi-card__subtitle">
                    {% if materias_stock_critico > 0 %}
                        <span class="text-danger">Reposici칩n urgente</span>
                    {% else %}
                        <span class="text-success">Todo en orden</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="lino-kpi-card lino-kpi-card--info">
            <div class="lino-kpi-card__header">
                <h3 class="lino-kpi-card__title">Margen Mensual</h3>
                <div class="lino-kpi-card__icon">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
            </div>
            <div class="lino-kpi-card__content">
                <div class="lino-kpi-card__value">{{ porcentaje_margen|default:"0" }}</div>
                <div class="lino-kpi-card__currency">%</div>
                <div class="lino-kpi-card__trend lino-kpi-card__trend--up">
                    <i class="bi bi-arrow-up"></i>
                    <span>+{{ tendencia_ingresos|default:"0" }}%</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gr치ficos y Transacciones -->
<div class="row g-4 mb-5">
    <div class="col-lg-8">
        <div class="lino-card">
            <div class="lino-card__body">
                <div class="lino-card__header">
                    <h3 class="lino-card__title">Ventas de los 칔ltimos 7 D칤as</h3>
                    <p class="lino-card__subtitle">Seguimiento de rendimiento diario</p>
                    <a href="{% url 'gestion:lista_ventas' %}" class="lino-card__action">Ver detalle</a>
                </div>
                
                <div class="lino-card__content">
                    {% if ventas_data %}
                        <canvas id="ventasChart"></canvas>
                    {% else %}
                        <div class="lino-empty-state">
                            <i class="bi bi-graph-up lino-empty-state__icon"></i>
                            <h6 class="lino-empty-state__title">Sin datos de ventas</h6>
                            <p class="lino-empty-state__text">Los datos aparecer치n cuando realices ventas</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="row g-4">
            <!-- Acciones R치pidas con nuevo sistema -->
            <div class="col-12">
                <div class="lino-card">
                    <div class="lino-card__body">
                        <h6 class="lino-card__title">
                            <i class="bi bi-lightning-charge text-warning me-2"></i>
                            Acciones R치pidas
                        </h6>
                        <div class="lino-action-grid">
                            <a href="{% url 'gestion:crear_venta' %}" class="lino-action-btn lino-action-btn--success">
                                <i class="bi bi-plus-circle lino-action-btn__icon"></i>
                                <span class="lino-action-btn__text">Nueva Venta</span>
                            </a>
                            
                            <a href="{% url 'gestion:crear_producto' %}" class="lino-action-btn lino-action-btn--orange">
                                <i class="bi bi-box lino-action-btn__icon"></i>
                                <span class="lino-action-btn__text">Agregar Producto</span>
                            </a>
                            
                            <a href="{% url 'gestion:reportes' %}" class="lino-action-btn lino-action-btn--olive">
                                <i class="bi bi-graph-up lino-action-btn__icon"></i>
                                <span class="lino-action-btn__text">Generar Reporte</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Alertas y Notificaciones -->
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-3">
                        <h6 class="card-title mb-3 fw-bold d-flex align-items-center">
                            <i class="bi bi-bell text-warning me-2"></i>
                            Alertas y Notificaciones
                        </h6>
                        
                        <div class="d-grid gap-2">
                            {% if productos_sin_stock > 0 %}
                            <div class="alert alert-danger border-0 p-3 mb-0" style="border-left: 4px solid #dc3545 !important;">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-exclamation-triangle-fill text-danger me-2 mt-1"></i>
                                    <div class="flex-grow-1">
                                        <h6 class="alert-heading mb-1" style="font-size: 0.9rem;">Stock Cr칤tico</h6>
                                        <p class="mb-2" style="font-size: 0.85rem;">{{ productos_sin_stock }} producto(s) sin stock</p>
                                        <button class="btn btn-danger btn-sm">Reponer ahora</button>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if materias_stock_critico > 0 %}
                            <div class="alert alert-warning border-0 p-3 mb-0" style="border-left: 4px solid #ffc107 !important;">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-exclamation-circle-fill text-warning me-2 mt-1"></i>
                                    <div class="flex-grow-1">
                                        <h6 class="alert-heading mb-1" style="font-size: 0.9rem;">Materia Prima Baja</h6>
                                        <p class="mb-2" style="font-size: 0.85rem;">{{ materias_stock_critico }} materia(s) prima(s) en stock cr칤tico</p>
                                        <button class="btn btn-warning btn-sm">Ver detalles</button>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if productos_sin_stock == 0 and materias_stock_critico == 0 %}
                            <div class="text-center py-3">
                                <i class="bi bi-check-circle text-success mb-2" style="font-size: 2rem;"></i>
                                <p class="text-muted mb-0" style="font-size: 0.9rem;">Todo en orden</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transacciones Recientes -->
<div class="row g-4 mb-5">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-body p-4">
                {% lino_card_header "Transacciones Recientes" "" "Ver todas" "gestion:lista_ventas" %}
                
                <div class="mt-3">
                    <div class="row g-3">
                        {% for venta in ultimas_ventas %}
                        <div class="col-md-4">
                            <div class="d-flex align-items-center p-3 border rounded">
                                <div class="icon-circle bg-success me-3">
                                    <i class="bi bi-plus text-white"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-medium">Venta #{{ venta.id }}</div>
                                    <div class="text-muted small">{{ venta.fecha|timesince }}</div>
                                    <div class="fw-bold text-success">{{ venta.total|money_format }}</div>
                                    <div class="small text-muted">{{ venta.cliente|default:"Cliente general" }}</div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-4">
                            <i class="bi bi-receipt text-muted mb-2" style="font-size: 2rem;"></i>
                            <p class="text-muted mb-0">No hay transacciones recientes</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<!-- 游 FORCE LINO V3 STYLING -->
<style>
/* 游 KPI Cards V3 - ULTRA MODERN STYLING */
.lino-kpi-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
    border-radius: 16px !important;
    padding: 28px !important;
    box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 10px -6px rgba(0, 0, 0, 0.1) !important;
    border: 1px solid rgba(255, 255, 255, 0.8) !important;
    position: relative !important;
    overflow: hidden !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    backdrop-filter: blur(10px) !important;
}

.lino-kpi-card:hover {
    transform: translateY(-8px) scale(1.02) !important;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 8px 16px -8px rgba(0, 0, 0, 0.1) !important;
}

.lino-kpi-card::before {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 4px !important;
    background: linear-gradient(90deg, #2563eb, #60a5fa) !important;
}

.lino-kpi-card--success::before {
    background: linear-gradient(90deg, #10b981, #059669) !important;
}

.lino-kpi-card--primary::before {
    background: linear-gradient(90deg, #2563eb, #60a5fa) !important;
}

.lino-kpi-card--danger::before {
    background: linear-gradient(90deg, #ef4444, #dc2626) !important;
}

.lino-kpi-card--info::before {
    background: linear-gradient(90deg, #06b6d4, #0891b2) !important;
}

.lino-kpi-card__header {
    display: flex !important;
    justify-content: space-between !important;
    align-items: flex-start !important;
    margin-bottom: 16px !important;
}

.lino-kpi-card__title {
    font-size: 14px !important;
    font-weight: 600 !important;
    color: #64748b !important;
    margin: 0 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
}

.lino-kpi-card__icon {
    width: 56px !important;
    height: 56px !important;
    border-radius: 16px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 28px !important;
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.15), rgba(37, 99, 235, 0.05)) !important;
    color: #2563eb !important;
    box-shadow: 0 8px 16px rgba(37, 99, 235, 0.2) !important;
    transition: all 0.3s ease !important;
}

.lino-kpi-card--success .lino-kpi-card__icon {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.05)) !important;
    color: #10b981 !important;
    box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3) !important;
}

.lino-kpi-card--danger .lino-kpi-card__icon {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.05)) !important;
    color: #ef4444 !important;
    box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3) !important;
}

.lino-kpi-card--info .lino-kpi-card__icon {
    background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(6, 182, 212, 0.05)) !important;
    color: #06b6d4 !important;
    box-shadow: 0 8px 16px rgba(6, 182, 212, 0.3) !important;
}

.lino-kpi-card__value {
    font-size: 30px !important;
    font-weight: 700 !important;
    color: #111827 !important;
    margin: 0 0 8px 0 !important;
    line-height: 1.2 !important;
}

.lino-kpi-card__currency {
    font-size: 14px !important;
    color: #64748b !important;
    font-weight: 500 !important;
    margin-bottom: 8px !important;
}

.lino-kpi-card__trend {
    display: flex !important;
    align-items: center !important;
    gap: 4px !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    margin-top: 8px !important;
}

.lino-kpi-card__trend--up {
    color: #10b981 !important;
}

.lino-kpi-card__trend--down {
    color: #ef4444 !important;
}

.lino-kpi-card__subtitle {
    font-size: 14px !important;
    color: #64748b !important;
    margin-top: 8px !important;
}

/* Alert styles */
.lino-alert {
    background: #fef3c7 !important;
    border: 1px solid #f59e0b !important;
    border-radius: 8px !important;
    padding: 16px !important;
    margin-bottom: 24px !important;
}

.lino-alert--warning {
    background: #fef3c7 !important;
    border-color: #f59e0b !important;
    color: #92400e !important;
}

.lino-alert__content {
    display: flex !important;
    align-items: flex-start !important;
    gap: 12px !important;
}

.lino-alert__icon {
    color: #f59e0b !important;
    font-size: 20px !important;
    margin-top: 2px !important;
}

.lino-alert__text {
    flex: 1 !important;
}
</style>

<style>
/* Estilos para botones de acciones r치pidas */
.action-btn {
    display: block;
    text-decoration: none;
    border-radius: 8px;
    border: 2px solid transparent;
    background: #f8f9fa;
    color: #6c757d;
    font-weight: 500;
    min-height: 45px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    text-decoration: none;
}

.action-btn-success {
    border-color: #e8f5e8;
}

.action-btn-success:hover {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-color: #28a745;
}

.action-btn-orange {
    border-color: #fff3e0;
}

.action-btn-orange:hover {
    background: linear-gradient(135deg, #ff7b25, #ff8f42);
    color: white;
    border-color: #ff7b25;
}

.action-btn-olive {
    border-color: #f0f2e8;
}

.action-btn-olive:hover {
    background: linear-gradient(135deg, #8c9c6c, #a4b574);
    color: white;
    border-color: #8c9c6c;
}

.action-btn i {
    transition: transform 0.3s ease;
}

.action-btn:hover i {
    transform: scale(1.1);
}

/* Efecto de ripple al hacer click */
.action-btn::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.4s, height 0.4s;
}

.action-btn:active::after {
    width: 100%;
    height: 100%;
}

/* Estilos para alertas compactas */
.alert {
    border-radius: 8px;
}

.icon-circle {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuraci칩n del gr치fico de ventas
    const canvas = document.getElementById('ventasChart');
    if (!canvas) {
        console.log('Canvas ventasChart no encontrado - probablemente no hay datos de ventas');
        return;
    }
    
    var ctx = canvas.getContext('2d');
    
    // Colores del tema LINO
    var primaryColor = '#8c9c6c';  // Verde oliva
    var darkColor = '#344c39';     // Verde oscuro
    
    var ventasChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ ventas_labels|safe }},
            datasets: [{
                label: 'Ventas ($)',
                data: {{ ventas_data|safe }},
                borderColor: primaryColor,
                backgroundColor: 'rgba(140, 156, 108, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: primaryColor,
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8,
                pointHoverBackgroundColor: darkColor,
                pointHoverBorderColor: '#ffffff',
                pointHoverBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(52,76,57,0.95)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: primaryColor,
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return 'Ventas: $' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#64748b',
                        font: {
                            size: 12
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(148,163,184,0.1)',
                        borderDash: [5, 5]
                    },
                    ticks: {
                        color: '#64748b',
                        font: {
                            size: 12
                        },
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            },
            elements: {
                line: {
                    tension: 0.4
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });

    // Animaciones de n칰meros en KPIs
    function animateNumber(target, finalValue, duration = 1500) {
        const element = document.querySelector(`[data-target="${target}"]`);
        if (!element) return;
        
        const startValue = 0;
        const increment = finalValue / (duration / 16);
        let currentValue = startValue;
        
        const timer = setInterval(() => {
            currentValue += increment;
            if (currentValue >= finalValue) {
                currentValue = finalValue;
                clearInterval(timer);
            }
            
            // Formatear n칰mero
            if (target === 'ingresos') {
                element.textContent = '$' + Math.floor(currentValue).toLocaleString();
            } else if (target === 'margen') {
                element.textContent = Math.floor(currentValue) + '%';
            } else {
                element.textContent = Math.floor(currentValue).toLocaleString();
            }
        }, 16);
    }
    
    // Iniciar animaciones con delay escalonado
    setTimeout(() => {
        animateNumber('ingresos', {{ ingresos_mes|default:0 }});
    }, 200);
    
    setTimeout(() => {
        animateNumber('productos', {{ total_productos|default:0 }});
    }, 400);
    
    setTimeout(() => {
        animateNumber('criticos', {{ materias_stock_critico|default:0 }});
    }, 600);
    
    setTimeout(() => {
        animateNumber('margen', {{ porcentaje_margen|default:0 }});
    }, 800);
});
</script>
{% endblock %}
