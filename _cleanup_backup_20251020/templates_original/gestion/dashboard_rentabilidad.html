{% extends 'gestion/base.html' %}
{% load static %}
{% load dietetica_tags %}

{% block title %}Control de Rentabilidad - LINO Saludable{% endblock %}

{% block header %}
<div class="lino-page-header">
    <div class="lino-page-header__content">
        <div class="lino-page-header__text">
            <h1 class="lino-page-header__title">
                <i class="bi bi-graph-up-arrow lino-page-header__icon"></i>
                Control de Rentabilidad
            </h1>
            <p class="lino-page-header__subtitle">Análisis de costos vs precios y márgenes de ganancia</p>
        </div>
        <div class="lino-page-header__actions">
            <button class="lino-btn lino-btn--primary" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise"></i>
                Actualizar
            </button>
            <a href="{% url 'gestion:panel_control' %}" class="lino-btn lino-btn--secondary">
                <i class="bi bi-arrow-left"></i>
                Volver
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1 text-gray-800">
                        <i class="fas fa-chart-line text-primary"></i>
                        Control de Rentabilidad
                    </h1>
                    <p class="text-muted">Análisis de costos vs precios y márgenes de ganancia</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                    <a href="{% url 'gestion:panel_control' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

<!-- KPIs Principales con LINO Design System V3 -->
<div class="lino-kpi-grid mb-4">
    <div class="lino-kpi-card lino-kpi-card--primary">
        <div class="lino-kpi-card__header">
            <h3 class="lino-kpi-card__title">Total Productos</h3>
            <div class="lino-kpi-card__icon">
                <i class="bi bi-boxes"></i>
            </div>
        </div>
        <div class="lino-kpi-card__content">
            <div class="lino-kpi-card__value">{{ analytics.kpis.total_productos|default:"0" }}</div>
            <div class="lino-kpi-card__subtitle">En el sistema</div>
        </div>
    </div>

    <div class="lino-kpi-card lino-kpi-card--success">
        <div class="lino-kpi-card__header">
            <h3 class="lino-kpi-card__title">Productos Rentables</h3>
            <div class="lino-kpi-card__icon">
                <i class="bi bi-graph-up-arrow"></i>
            </div>
        </div>
        <div class="lino-kpi-card__content">
            <div class="lino-kpi-card__value">{{ analytics.kpis.porcentaje_rentables|default:"0" }}</div>
            <div class="lino-kpi-card__currency">%</div>
            <div class="lino-kpi-card__subtitle">{{ analytics.kpis.productos_rentables|default:"0" }} productos</div>
        </div>
    </div>

    <div class="lino-kpi-card lino-kpi-card--danger">
        <div class="lino-kpi-card__header">
            <h3 class="lino-kpi-card__title">Productos en Pérdida</h3>
            <div class="lino-kpi-card__icon">
                <i class="bi bi-exclamation-triangle-fill"></i>
            </div>
        </div>
        <div class="lino-kpi-card__content">
            <div class="lino-kpi-card__value">{{ analytics.kpis.porcentaje_perdida|default:"0" }}</div>
            <div class="lino-kpi-card__currency">%</div>
            <div class="lino-kpi-card__subtitle">{{ analytics.kpis.productos_en_perdida|default:"0" }} productos</div>
        </div>
    </div>

    <div class="lino-kpi-card lino-kpi-card--warning">
        <div class="lino-kpi-card__header">
            <h3 class="lino-kpi-card__title">Margen Promedio</h3>
            <div class="lino-kpi-card__icon">
                <i class="bi bi-percent"></i>
            </div>
        </div>
        <div class="lino-kpi-card__content">
            <div class="lino-kpi-card__value">{{ analytics.kpis.margen_promedio_ponderado|default:"0" }}</div>
            <div class="lino-kpi-card__currency">%</div>
            <div class="lino-kpi-card__subtitle">Ponderado por ventas</div>
        </div>
    </div>
</div>

<!-- Alertas Críticas con LINO Design System V3 -->
{% if analytics.alertas %}
<div class="mb-4">
    <div class="lino-card">
        <div class="lino-card__header lino-card__header--danger">
            <h3 class="lino-card__title">
                <i class="bi bi-exclamation-triangle-fill"></i>
                Alertas Críticas ({{ total_alertas }})
            </h3>
        </div>
        <div class="lino-card__body">
            {% for alerta in analytics.alertas %}
            <div class="lino-alert lino-alert--{% if alerta.severidad == 'critica' %}danger{% elif alerta.severidad == 'alta' %}warning{% elif alerta.severidad == 'media' %}info{% else %}success{% endif %} mb-3">
                <div class="lino-alert__content">
                    <i class="bi {% if alerta.severidad == 'critica' %}bi-exclamation-triangle-fill{% elif alerta.severidad == 'alta' %}bi-exclamation-circle-fill{% else %}bi-info-circle-fill{% endif %} lino-alert__icon"></i>
                    <div class="lino-alert__text">
                        <strong>{{ alerta.tipo|title }}</strong>: {{ alerta.mensaje }}
                        {% if alerta.producto %}
                        <div class="mt-2">
                            <span class="badge bg-secondary">{{ alerta.producto }}</span>
                            {% if alerta.valor_actual %}
                            <span class="badge bg-light text-dark">Actual: {{ alerta.valor_actual }}</span>
                            {% endif %}
                            {% if alerta.recomendacion %}
                            <span class="badge bg-primary">Recomendado: {{ alerta.recomendacion }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Sección de Alertas Detalladas -->
{% if analytics.alertas %}
<div class="col-12 mb-4">
    <div class="lino-card">
        <div class="lino-card__header">
            <h3 class="lino-card__title mb-0">
                <i class="bi bi-list-ul"></i>
                Detalle de Alertas
            </h3>
        </div>
        <div class="lino-card__body">
            {% for alerta in analytics.alertas %}
            <div class="lino-alert lino-alert--{% if alerta.severidad == 'critica' %}danger{% elif alerta.severidad == 'alta' %}warning{% elif alerta.severidad == 'media' %}info{% else %}success{% endif %} mb-3">
                <div class="lino-alert__content">
                    <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="font-weight-bold mb-1">{{ alerta.titulo }}</h6>
                                <p class="mb-2">{{ alerta.descripcion }}</p>
                                <small class="text-muted">
                                    <strong>Acción recomendada:</strong> {{ alerta.accion }}
                                </small>
                            </div>
                            <div class="ml-3">
                                {% if alerta.tipo == 'perdida' %}
                                    <i class="fas fa-exclamation-circle text-danger fa-2x"></i>
                                {% elif alerta.tipo == 'margen_bajo' %}
                                    <i class="fas fa-exclamation-triangle text-warning fa-2x"></i>
                                {% else %}
                                    <i class="fas fa-info-circle text-info fa-2x"></i>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Productos afectados -->
                        {% if alerta.productos %}
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse" data-target="#productos-{{ forloop.counter }}">
                                Ver productos afectados ({{ alerta.productos|length }})
                            </button>
                            <div class="collapse mt-2" id="productos-{{ forloop.counter }}">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Producto</th>
                                                <th>Precio Actual</th>
                                                <th>Costo</th>
                                                <th>Margen</th>
                                                <th>Acción</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for producto_data in alerta.productos %}
                                            <tr>
                                                <td>{{ producto_data.producto.nombre }}</td>
                                                <td>${{ producto_data.precio_actual|floatformat:2 }}</td>
                                                <td>${{ producto_data.costo_actual|floatformat:2 }}</td>
                                                <td class="{% if producto_data.en_perdida %}margen-critico{% elif producto_data.margen_porcentaje < 10 %}margen-bajo{% endif %}">
                                                    {{ producto_data.margen_porcentaje|floatformat:1 }}%
                                                </td>
                                                <td>
                                                    {% if producto_data.producto.id %}
                                                    <a href="{% url 'gestion:detalle_rentabilidad_producto' producto_data.producto.id %}" 
                                                       class="btn btn-sm btn-primary">
                                                        <i class="fas fa-chart-line"></i> Analizar
                                                    </a>
                                                    {% else %}
                                                    <span class="text-muted">N/A</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>
</div>
{% endif %}

    <!-- Gráficos de Análisis -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <h6 class="font-weight-bold mb-3">Distribución de Márgenes</h6>
                <canvas id="chartMargenes" style="max-height: 300px;"></canvas>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <h6 class="font-weight-bold mb-3">Top 10 Productos por Margen</h6>
                <canvas id="chartTopMargenes" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>

    <!-- Recomendaciones de Precios -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-lightbulb"></i>
                        Recomendaciones de Ajuste de Precios
                    </h6>
                </div>
                <div class="card-body">
                    <div id="recomendaciones-container">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Productos por Rentabilidad -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h6 class="m-0 font-weight-bold">Top Productos por Margen</h6>
                </div>
                <div class="card-body">
                    {% for producto in analytics.kpis.productos_top_margen %}
                    <div class="producto-rentabilidad d-flex justify-content-between align-items-center p-2 mb-2">
                        <div>
                            <strong>{{ producto.producto.nombre }}</strong>
                            <br>
                            <small class="text-muted">Costo: ${{ producto.costo_actual|floatformat:2 }}</small>
                        </div>
                        <div class="text-right">
                            <div class="margen-optimo h6 mb-0">{{ producto.margen_porcentaje|floatformat:1 }}%</div>
                            <small class="text-muted">${{ producto.precio_actual|floatformat:2 }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h6 class="m-0 font-weight-bold">Top Productos por Ingresos</h6>
                </div>
                <div class="card-body">
                    {% for producto in analytics.kpis.productos_top_ingresos %}
                    <div class="producto-rentabilidad d-flex justify-content-between align-items-center p-2 mb-2">
                        <div>
                            <strong>{{ producto.producto.nombre }}</strong>
                            <br>
                            <small class="text-muted">{{ producto.cantidad_vendida }} vendidos</small>
                        </div>
                        <div class="text-right">
                            <div class="h6 mb-0">${{ producto.ingresos_mes|floatformat:0 }}</div>
                            <small class="text-muted {% if producto.margen_porcentaje < 10 %}margen-critico{% elif producto.margen_porcentaje < 20 %}margen-bajo{% elif producto.margen_porcentaje < 30 %}margen-aceptable{% else %}margen-optimo{% endif %}">
                                {{ producto.margen_porcentaje|floatformat:1 }}% margen
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Configuración de gráficos
const chartColors = {
    perdida: '#dc3545',
    critico: '#fd7e14', 
    bajo: '#ffc107',
    aceptable: '#20c997',
    optimo: '#28a745'
};

// Gráfico de distribución de márgenes
const ctxMargenes = document.getElementById('chartMargenes').getContext('2d');
new Chart(ctxMargenes, {
    type: 'doughnut',
    data: {
        labels: {{ margenes_labels|safe }},
        datasets: [{
            data: {{ margenes_data|safe }},
            backgroundColor: [
                chartColors.perdida,
                chartColors.critico,
                chartColors.bajo,
                chartColors.aceptable,
                chartColors.optimo
            ],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
            position: 'bottom'
        },
        tooltips: {
            callbacks: {
                label: function(tooltipItem, data) {
                    const label = data.labels[tooltipItem.index];
                    const value = data.datasets[0].data[tooltipItem.index];
                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value} productos (${percentage}%)`;
                }
            }
        }
    }
});

// Gráfico de top productos por margen
const ctxTopMargenes = document.getElementById('chartTopMargenes').getContext('2d');
new Chart(ctxTopMargenes, {
    type: 'horizontalBar',
    data: {
        labels: {{ top_margenes_labels|safe }},
        datasets: [{
            label: 'Margen (%)',
            data: {{ top_margenes_data|safe }},
            backgroundColor: function(context) {
                const value = context.parsed.x;
                if (value < 10) return chartColors.critico;
                if (value < 20) return chartColors.bajo;
                if (value < 30) return chartColors.aceptable;
                return chartColors.optimo;
            },
            borderColor: '#fff',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
            display: false
        },
        scales: {
            x: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Margen (%)'
                }
            }
        },
        tooltips: {
            callbacks: {
                label: function(tooltipItem) {
                    return `Margen: ${tooltipItem.value}%`;
                }
            }
        }
    }
});

// Cargar recomendaciones vía AJAX
function cargarRecomendaciones() {
    fetch('{% url "gestion:recomendaciones_precios_ajax" %}')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('recomendaciones-container');
            
            if (data.success && data.recomendaciones.length > 0) {
                let html = '<div class="table-responsive"><table class="table table-hover">';
                html += '<thead><tr>';
                html += '<th>Producto</th>';
                html += '<th>Problema</th>';
                html += '<th>Precio Actual</th>';
                html += '<th>Precio Sugerido</th>';
                html += '<th>Incremento</th>';
                html += '<th>Acción</th>';
                html += '</tr></thead><tbody>';
                
                data.recomendaciones.forEach(rec => {
                    const tipoClass = rec.tipo === 'urgente' ? 'table-danger' : 'table-warning';
                    html += `<tr class="${tipoClass}">`;
                    html += `<td><strong>${rec.producto_nombre}</strong></td>`;
                    html += `<td>${rec.problema}</td>`;
                    html += `<td>$${rec.precio_actual}</td>`;
                    html += `<td>$${rec.precio_sugerido}</td>`;
                    html += `<td>+${rec.incremento_porcentaje}%</td>`;
                    html += `<td>
                        <button class="btn btn-sm btn-primary" onclick="aplicarPrecio(${rec.producto_id}, ${rec.precio_sugerido})">
                            <i class="fas fa-check"></i> Aplicar
                        </button>
                    </td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-check-circle fa-3x mb-3"></i><br>No hay recomendaciones de ajuste de precios en este momento.</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('recomendaciones-container').innerHTML = 
                '<div class="alert alert-danger">Error al cargar recomendaciones</div>';
        });
}

// Aplicar precio sugerido
function aplicarPrecio(productoId, nuevoPrecio) {
    if (confirm(`¿Confirma aplicar el nuevo precio de $${nuevoPrecio}?`)) {
        const formData = new FormData();
        formData.append('nuevo_precio', nuevoPrecio);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch(`/gestion/api/aplicar-precio/${productoId}/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload(); // Recargar para mostrar datos actualizados
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al aplicar el precio');
        });
    }
}

// Actualizar todos los datos
function refreshData() {
    location.reload();
}

// Cargar recomendaciones al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    cargarRecomendaciones();
});
</script>
{% endblock %}
