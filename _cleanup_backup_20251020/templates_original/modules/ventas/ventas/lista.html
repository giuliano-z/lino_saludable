{% extends 'gestion/base.html' %}
{% load dietetica_tags %}

{% block title %}Ventas - LINO SYS{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block header %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h4 class="mb-1">Gestión de Ventas</h4>
        <div class="page-subheader">Control de ventas • Facturación • Reportes</div>
    </div>
    {% lino_badge "MIGRADO - SIN CSS DUPLICADO" "success" "lg" "bi-check-circle" %}
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- KPIs Cards usando componentes Lino - ¡CERO CSS inline! -->
    <div class="lino-grid lino-grid--4-col mb-4">
        {% lino_kpi_card "Total Ventas" total_ventas|default:0 "Ventas realizadas" "bi-cart-check" "olive" %}
        {% lino_kpi_card "Ventas del Mes" ventas_mes|default:0 "Agosto 2025" "bi-calendar-week" "brown" %}
        {% lino_kpi_card "Ingresos del Mes" ingresos_mes|default:"$0" "Ingresos totales" "bi-currency-dollar" "green" %}
        {% lino_kpi_card "Ventas de Hoy" ventas_hoy|default:0 "Ventas diarias" "bi-clock" "earth" %}
    </div>

    <!-- Filtros y Acciones -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="lino-card">
                {% lino_card_header "Filtros de Búsqueda" "bi-funnel" "olive" %}
                
                <div class="lino-card-content">
                    <form method="get" id="filtrosForm">
                        <div class="lino-grid lino-grid--3-col">
                            <div>
                                <label for="q" class="form-label fw-medium">Buscar venta</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-end-0">
                                        {% lino_icon "bi-search" "text-muted" %}
                                    </span>
                                    <input type="text" class="form-control border-start-0" id="q" name="q" 
                                           value="{{ query|default:'' }}" placeholder="Cliente, producto...">
                                </div>
                            </div>
                            <div>
                                <label for="fecha_desde" class="form-label fw-medium">Fecha desde</label>
                                <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" 
                                       value="{{ fecha_desde|default:'' }}">
                            </div>
                            <div>
                                <label for="fecha_hasta" class="form-label fw-medium">Fecha hasta</label>
                                <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta" 
                                       value="{{ fecha_hasta|default:'' }}">
                            </div>
                        </div>
                        <div class="d-flex gap-2 mt-4">
                            {% lino_btn "Aplicar Filtros" "#" "primary" "md" "bi-funnel" %}
                            {% lino_btn "Limpiar" "{% url 'gestion:lista_ventas' %}" "outline" "md" "bi-arrow-clockwise" %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="lino-card">
                {% lino_card_header "Acciones Rápidas" "bi-lightning" "green" %}
                
                <div class="lino-card-content">
                    <div class="d-grid gap-3">
                        {% lino_btn "Nueva Venta" "{% url 'gestion:crear_venta' %}" "primary" "lg" "bi-plus-circle" %}
                        {% lino_btn "Exportar Ventas" "{% url 'gestion:exportar_ventas' %}" "success" "md" "bi-download" %}
                        {% lino_btn "Ver Reportes" "{% url 'gestion:reportes' %}" "warning" "md" "bi-graph-up" %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Información de filtros activos -->
    {% if query or fecha_desde or fecha_hasta %}
    <div class="lino-card mb-4">
        <div class="lino-card-content">
            <div class="d-flex align-items-center">
                {% lino_icon "bi-funnel-fill" "text-info me-2" %}
                <div>
                    <strong>Filtros activos:</strong>
                    {% if query %}Búsqueda: "{{ query }}"{% endif %}
                    {% if fecha_desde %}{% if query %} • {% endif %}Desde: {{ fecha_desde }}{% endif %}
                    {% if fecha_hasta %}{% if query or fecha_desde %} • {% endif %}Hasta: {{ fecha_hasta }}{% endif %}
                    {% lino_badge ventas|length|add:" resultado"|add:ventas|length|pluralize "info" "md" %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Lista de Ventas -->
    <div class="lino-card">
        {% lino_card_header "Lista de Ventas" "bi-list-ul" "brown" %}
        
        <div class="lino-card-content">
            {% if ventas %}
                <div class="table-responsive">
                    <table class="lino-table">
                        <thead>
                            <tr>
                                <th>{% lino_icon "bi-hash" "me-1" %}ID</th>
                                <th>{% lino_icon "bi-calendar" "me-1" %}Fecha</th>
                                <th>{% lino_icon "bi-person" "me-1" %}Cliente</th>
                                <th>{% lino_icon "bi-basket" "me-1" %}Productos</th>
                                <th>{% lino_icon "bi-currency-dollar" "me-1" %}Total</th>
                                <th>{% lino_icon "bi-person-badge" "me-1" %}Vendedor</th>
                                <th>{% lino_icon "bi-tools" "me-1" %}Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for venta in ventas %}
                            <tr>
                                <td>
                                    {% lino_badge venta.id "olive" "md" "bi-receipt" %}
                                </td>
                                <td>
                                    <div class="small">
                                        <div class="fw-medium">{{ venta.fecha|date:"d/m/Y" }}</div>
                                        <div class="text-muted">{{ venta.fecha|date:"H:i" }}</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% lino_icon "bi-person-circle" "text-muted me-2" %}
                                        <div>
                                            <div class="fw-medium">{{ venta.cliente|default:"Cliente general" }}</div>
                                            {% if venta.cliente %}
                                                <div class="small text-muted">Cliente registrado</div>
                                            {% else %}
                                                <div class="small text-muted">Venta directa</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="small">
                                        <div class="fw-medium">{{ venta.ventadetalle_set.count }} productos</div>
                                        <div class="text-muted">{{ venta.ventadetalle_set.all|total_cantidad }} unidades</div>
                                    </div>
                                </td>
                                <td>
                                    {% lino_value_box "$"|add:venta.total "Total" "success" "sm" %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% lino_icon "bi-person-badge" "text-primary me-1" %}
                                        <small>{{ venta.usuario.get_full_name|default:venta.usuario.username }}</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex gap-1">
                                        {% lino_btn "Ver" "{% url 'gestion:detalle_venta' venta.id %}" "primary" "sm" "bi-eye" %}
                                        {% lino_btn "Eliminar" "#" "danger" "sm" "bi-trash" "onclick='confirmarEliminacion({{ venta.id }}, \"{{ venta.cliente|default:\"Venta general\"|escapejs }}\", \"{{ venta.total }}\"); return false;'" %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Paginación si es necesaria -->
                {% if ventas.has_other_pages %}
                <div class="d-flex justify-content-center mt-4">
                    <nav aria-label="Page navigation">
                        <ul class="pagination">
                            {% if ventas.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ ventas.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">Anterior</a>
                                </li>
                            {% endif %}
                            
                            {% for num in ventas.paginator.page_range %}
                                {% if ventas.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > ventas.number|add:'-3' and num < ventas.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if ventas.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ ventas.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if fecha_desde %}&fecha_desde={{ fecha_desde }}{% endif %}{% if fecha_hasta %}&fecha_hasta={{ fecha_hasta }}{% endif %}">Siguiente</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
                
            {% else %}
                <div class="text-center py-5">
                    {% if query or fecha_desde or fecha_hasta %}
                        {% lino_icon "bi-search" "text-muted opacity-50 mb-3" "display-4" %}
                        <h5 class="text-muted">No se encontraron ventas</h5>
                        <p class="text-muted mb-4">No hay ventas que coincidan con los filtros aplicados</p>
                        {% lino_btn "Ver todas las ventas" "{% url 'gestion:lista_ventas' %}" "outline" "md" "bi-arrow-clockwise" %}
                    {% else %}
                        {% lino_icon "bi-cart-x" "text-muted opacity-50 mb-3" "display-4" %}
                        <h5 class="text-muted">No hay ventas registradas</h5>
                        <p class="text-muted mb-4">Registra tu primera venta</p>
                        {% lino_btn "Nueva Venta" "{% url 'gestion:crear_venta' %}" "primary" "lg" "bi-plus-circle" %}
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>

</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="eliminarModal" tabindex="-1" aria-labelledby="eliminarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="eliminarModalLabel">
                    {% lino_icon "bi-trash3" "me-2" %} Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    {% lino_icon "bi-exclamation-triangle" "text-warning" "display-4" %}
                </div>
                
                <h5 class="text-danger mb-2" id="ventaInfo"></h5>
                <p class="text-muted mb-3" id="ventaDetalles"></p>
                
                <div class="alert alert-warning">
                    {% lino_icon "bi-exclamation-triangle" "me-2" %}
                    Esta acción no se puede deshacer
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmarEliminacion">
                    <label class="form-check-label" for="confirmarEliminacion">
                        Confirmo que deseo eliminar esta venta
                    </label>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                {% lino_btn "Cancelar" "#" "outline" "md" "" "data-bs-dismiss='modal'" %}
                <form id="eliminarForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="lino-btn lino-btn--danger" id="btnEliminar" disabled>
                        {% lino_icon "bi-trash3" "me-2" %} Eliminar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Envío automático de formularios
    document.getElementById('filtrosForm').addEventListener('submit', function(e) {
        e.preventDefault();
        this.submit();
    });
});

// Función para confirmar eliminación
function confirmarEliminacion(id, cliente, total) {
    const modal = new bootstrap.Modal(document.getElementById('eliminarModal'));
    
    document.getElementById('ventaInfo').textContent = `Venta #${id}`;
    document.getElementById('ventaDetalles').innerHTML = 
        `<strong>Cliente:</strong> ${cliente}<br>
         <strong>Total:</strong> $${total}`;
    
    // Configurar formulario
    document.getElementById('eliminarForm').action = `{% url 'gestion:eliminar_venta' 0 %}`.replace('0', id);
    
    // Reset checkbox
    const checkbox = document.getElementById('confirmarEliminacion');
    const btnEliminar = document.getElementById('btnEliminar');
    checkbox.checked = false;
    btnEliminar.disabled = true;
    
    // Habilitar botón cuando se marque checkbox
    checkbox.addEventListener('change', function() {
        btnEliminar.disabled = !this.checked;
    });
    
    modal.show();
}

// Confirmación adicional antes de enviar
document.getElementById('eliminarForm').addEventListener('submit', function(e) {
    if (!confirm('¿Estás absolutamente seguro? Esta acción no se puede deshacer.')) {
        e.preventDefault();
    }
});
</script>
{% endblock %}
