{% extends 'gestion/base.html' %}
{% block title %}{{ producto.nombre }} - LINO SYS{% endblock %}
{% block header %}Detalle de Producto{% endblock %}
{% block content %}

<nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-white px-3 py-2 rounded shadow-sm">
        <li class="breadcrumb-item"><a href="{% url 'gestion:panel_control' %}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{% url 'gestion:lista_productos' %}">Productos</a></li>
        <li class="breadcrumb-item active">{{ producto.nombre }}</li>
    </ol>
</nav>

<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
        <i class="fas fa-box"></i> {{ producto.nombre }}
    </h1>
    <div class="d-flex gap-2">
        <a href="{% url 'gestion:editar_producto' producto.id %}" class="btn btn-outline-success">
            <i class="bi bi-pencil"></i> Editar
        </a>
        <a href="{% url 'gestion:lista_productos' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold">Información del Producto</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Nombre:</strong> {{ producto.nombre }}</p>
                        <p><strong>Categoría:</strong> {{ producto.categoria }}</p>
                        <p><strong>Precio de Venta:</strong> <span class="badge bg-success-subtle text-success-emphasis">${{ producto.precio_venta|floatformat:2 }}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Stock Actual:</strong> 
                            <span class="badge badge-{% if producto.stock <= producto.stock_minimo %}danger{% elif producto.stock <= producto.stock_minimo|add:5 %}warning{% else %}success{% endif %}">
                                {{ producto.stock }} {{ producto.unidad_medida }}
                            </span>
                        </p>
                        <p><strong>Stock Mínimo:</strong> {{ producto.stock_minimo }} {{ producto.unidad_medida }}</p>
                        <p><strong>Unidad de Medida:</strong> {{ producto.unidad_medida }}</p>
                    </div>
                </div>
                
                {% if producto.descripcion %}
                <div class="mt-3">
                    <p><strong>Descripción:</strong></p>
                    <p class="text-muted">{{ producto.descripcion }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold">Recetas Asociadas</h6>
            </div>
            <div class="card-body">
                {% if recetas %}
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Receta</th>
                                    <th>Cantidad Producida</th>
                                    <th>Costo de Producción</th>
                                    <th>Margen</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for receta in recetas %}
                                <tr>
                                    <td>{{ receta.descripcion|default:"Receta Principal" }}</td>
                                    <td>{{ receta.cantidad_producida }} {{ producto.unidad_medida }}</td>
                                    <td>${{ receta.costo_total|floatformat:2 }}</td>
                                    <td>
                                        {% with margen=producto.precio_venta|sub:receta.costo_unitario %}
                                            <span class="{% if margen > 0 %}text-success{% else %}text-danger{% endif %}">
                                                ${{ margen|floatformat:2 }}
                                            </span>
                                        {% endwith %}
                                    </td>
                                    <td>
                                        <a href="{% url 'gestion:detalle_receta' receta.id %}" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-eye"></i> Ver
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay recetas asociadas</h5>
                        <p class="text-muted">Crea una receta para este producto.</p>
                        <a href="{% url 'gestion:crear_receta' %}?producto={{ producto.id }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Crear Receta
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold">Historial de Ventas</h6>
            </div>
            <div class="card-body">
                {% if ventas_recientes %}
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for venta in ventas_recientes %}
                                <tr>
                                    <td>{{ venta.fecha|date:"d/m/Y" }}</td>
                                    <td>{{ venta.cliente.nombre }}</td>
                                    <td>{{ venta.cantidad }} {{ producto.unidad_medida }}</td>
                                    <td>${{ venta.precio_unitario|floatformat:2 }}</td>
                                    <td>${{ venta.total|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-center">
                        <a href="{% url 'gestion:lista_ventas' %}?producto={{ producto.id }}" class="btn btn-outline-success">
                            Ver todas las ventas
                        </a>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay ventas registradas</h5>
                        <p class="text-muted">Este producto aún no se ha vendido.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold">Estado del Stock</h6>
            </div>
            <div class="card-body text-center">
                {% if producto.stock <= producto.stock_minimo %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Stock Crítico</strong><br>
                        Es necesario producir más unidades.
                    </div>
                {% elif producto.stock <= producto.stock_minimo|add:5 %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Stock Bajo</strong><br>
                        Considere producir más unidades pronto.
                    </div>
                {% else %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <strong>Stock Normal</strong><br>
                        El stock está en niveles adecuados.
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold">Estadísticas</h6>
            </div>
            <div class="card-body">
                <p><strong>Valor Total en Stock:</strong><br>
                    <span class="h5 text-success">
                        ${{ valor_total_stock|floatformat:2 }}
                    </span>
                </p>
                
                <p><strong>Ventas Último Mes:</strong><br>
                    <span class="h6">{{ ventas_ultimo_mes }} {{ producto.unidad_medida }}</span>
                </p>
                
                <p><strong>Ingresos Último Mes:</strong><br>
                    <span class="h6 text-success">${{ ingresos_ultimo_mes|floatformat:2 }}</span>
                </p>
                
                <p><strong>Rotación de Stock:</strong><br>
                    <span class="h6">{{ rotacion_stock }} días</span>
                </p>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold">Acciones Rápidas</h6>
            </div>
            <div class="card-body">
                <a href="{% url 'gestion:crear_venta' %}?producto={{ producto.id }}" class="btn btn-success btn-block mb-2">
                    <i class="fas fa-shopping-cart"></i> Registrar Venta
                </a>
                <a href="{% url 'gestion:crear_receta' %}?producto={{ producto.id }}" class="btn btn-info btn-block mb-2">
                    <i class="fas fa-clipboard-list"></i> Crear Receta
                </a>
                <a href="{% url 'gestion:editar_producto' producto.id %}" class="btn btn-primary btn-block mb-2">
                    <i class="fas fa-edit"></i> Editar Producto
                </a>
                <button class="btn btn-warning btn-block" data-toggle="modal" data-target="#ajusteStockModal">
                    <i class="fas fa-balance-scale"></i> Ajustar Stock
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ajusteStockModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning-subtle">
                <h5 class="modal-title"><i class="bi bi-arrow-repeat"></i> Ajustar Stock - {{ producto.nombre }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form method="post" action="{% url 'gestion:ajustar_stock_producto' producto.id %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Stock Actual:</label>
                        <input type="text" class="form-control" value="{{ producto.stock }} {{ producto.unidad_medida }}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="nuevo_stock" class="form-label">Nuevo Stock:</label>
                        <input type="number" class="form-control" id="nuevo_stock" name="nuevo_stock" 
                               step="0.01" min="0" value="{{ producto.stock }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="motivo" class="form-label">Motivo del Ajuste:</label>
                        <textarea class="form-control" id="motivo" name="motivo" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Ajustar Stock</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}