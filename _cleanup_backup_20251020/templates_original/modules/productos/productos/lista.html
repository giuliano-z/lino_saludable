{% extends 'gestion/base.html' %}
{% load dietetica_tags %}

{% block title %}Inventario - LINO SYS{% endblock %}

{% block header %}
<div class="page-header d-flex justify-content-between align-items-center">
    <span>Inventario - Migrado al Sistema Lino</span>
    <div class="d-flex gap-2">
        {% lino_badge "MIGRADO" "success" "lg" "bi-check-circle" %}
        {% url 'gestion:lista_productos' as url_lista_productos %}
        {% lino_btn "Ver Original" url_lista_productos "outline" "sm" "bi-arrow-left" %}
    </div>
</div>
{% endblock %}

{% block content %}

<!-- KPIs de Inventario usando componentes Lino -->
<div class="lino-grid lino-grid--4-col mb-5">
    {% lino_kpi_card "Total Productos" productos|length "Activos en inventario" "bi-box-seam" "olive" %}
    
    <!-- KPI con ID para JavaScript -->
    <div id="stock-critico-kpi">
        {% lino_kpi_card "Stock Cr√≠tico" "0" "Requieren atenci√≥n" "bi-exclamation-triangle" "warning" %}
    </div>
    
    <!-- KPI con ID para JavaScript -->
    <div id="agotados-kpi">
        {% lino_kpi_card "Productos Agotados" "0" "Sin stock disponible" "bi-x-circle" "danger" %}
    </div>
    
    <!-- KPI con ID para JavaScript -->
    <div id="valor-inventario-kpi">
        {% lino_kpi_card "Valor del Inventario" "$0" "Valor total en stock" "bi-currency-dollar" "success" %}
    </div>
</div>

<!-- Filtros modernos usando card header Lino -->
<div class="row g-4 mb-5">
    <div class="col-lg-8">
        <div class="lino-card">
            {% lino_card_header "Filtros de B√∫squeda" "bi-funnel" "olive" %}
            
            <div class="lino-card-content">
                <form method="get" id="filtrosForm">
                    <div class="lino-grid lino-grid--3-col">
                        <div>
                            <label for="q" class="form-label fw-medium">Buscar producto</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    {% lino_icon "bi-search" "text-muted" %}
                                </span>
                                <input type="text" class="form-control border-start-0" id="q" name="q" 
                                       value="{{ query|default:'' }}" placeholder="Nombre del producto...">
                            </div>
                        </div>
                        <div>
                            <label for="categoria" class="form-label fw-medium">Categor√≠a</label>
                            <select class="form-select" id="categoria" name="categoria">
                                <option value="">Todas las categor√≠as</option>
                                <option value="suplementos" {% if categoria_seleccionada == 'suplementos' %}selected{% endif %}>Suplementos Nutricionales</option>
                                <option value="cereales" {% if categoria_seleccionada == 'cereales' %}selected{% endif %}>Cereales y Granos</option>
                                <option value="frutos_secos" {% if categoria_seleccionada == 'frutos_secos' %}selected{% endif %}>Frutos Secos y Semillas</option>
                                <option value="tes_infusiones" {% if categoria_seleccionada == 'tes_infusiones' %}selected{% endif %}>T√©s e Infusiones</option>
                                <option value="harinas_especiales" {% if categoria_seleccionada == 'harinas_especiales' %}selected{% endif %}>Harinas Especiales</option>
                                <option value="endulzantes" {% if categoria_seleccionada == 'endulzantes' %}selected{% endif %}>Endulzantes Naturales</option>
                                <option value="aceites_vinagres" {% if categoria_seleccionada == 'aceites_vinagres' %}selected{% endif %}>Aceites y Vinagres</option>
                                <option value="conservas" {% if categoria_seleccionada == 'conservas' %}selected{% endif %}>Conservas y Preservados</option>
                                <option value="productos_veganos" {% if categoria_seleccionada == 'productos_veganos' %}selected{% endif %}>Productos Veganos</option>
                                <option value="sin_tacc" {% if categoria_seleccionada == 'sin_tacc' %}selected{% endif %}>Sin TACC</option>
                                <option value="organicos" {% if categoria_seleccionada == 'organicos' %}selected{% endif %}>Productos Org√°nicos</option>
                                <option value="especias" {% if categoria_seleccionada == 'especias' %}selected{% endif %}>Especias y Condimentos</option>
                                <option value="bebidas" {% if categoria_seleccionada == 'bebidas' %}selected{% endif %}>Bebidas Naturales</option>
                                <option value="otros" {% if categoria_seleccionada == 'otros' %}selected{% endif %}>Otros</option>
                            </select>
                        </div>
                        <div>
                            <label for="estado_stock" class="form-label fw-medium">Estado del Stock</label>
                            <select class="form-select" id="estado_stock" name="estado_stock">
                                <option value="">Todos los estados</option>
                                <option value="agotado" {% if estado_stock == 'agotado' %}selected{% endif %}>üî¥ Agotado</option>
                                <option value="critico" {% if estado_stock == 'critico' %}selected{% endif %}>üü° Cr√≠tico</option>
                                <option value="bajo" {% if estado_stock == 'bajo' %}selected{% endif %}>üîµ Bajo</option>
                                <option value="normal" {% if estado_stock == 'normal' %}selected{% endif %}>üü¢ Normal</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-4">
                    {% lino_btn "Aplicar Filtros" "#" "primary" "md" "bi-funnel" %}
                    {% url 'gestion:lista_productos' as url_limpiar %}
                    {% lino_btn "Limpiar" url_limpiar "outline" "md" "bi-arrow-clockwise" %}
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="lino-card">
            {% lino_card_header "Acciones R√°pidas" "bi-lightning" "green" %}
            
            <div class="lino-card-content">
                <div class="d-grid gap-3">
                    {% url 'gestion:crear_producto' as url_crear %}
                    {% lino_btn "Nuevo Producto" url_crear "primary" "lg" "bi-plus-circle" %}
                    {% url 'gestion:exportar_productos' as url_exportar %}
                    {% lino_btn "Exportar Lista" url_exportar "success" "md" "bi-download" %}
                    {% url 'gestion:alertas_stock' as url_alertas %}
                    {% lino_btn "Alertas de Stock" url_alertas "warning" "md" "bi-exclamation-triangle" %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Informaci√≥n de filtros activos -->
{% if query or categoria_seleccionada or estado_stock %}
<div class="lino-card mb-4">
    <div class="lino-card-content">
        <div class="d-flex align-items-center">
            {% lino_icon "bi-funnel-fill" "text-info me-2" %}
            <div>
                <strong>Filtros activos:</strong>
                {% if query %}Texto: "{{ query }}"{% endif %}
                {% if categoria_seleccionada %}{% if query %} ‚Ä¢ {% endif %}Categor√≠a: "{{ categoria_seleccionada|title }}"{% endif %}
                {% if estado_stock %}{% if query or categoria_seleccionada %} ‚Ä¢ {% endif %}Estado: "{{ estado_stock|title }}"{% endif %}
                {% lino_badge productos|length|add:" resultado"|add:productos|length|pluralize "info" "md" %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Productos en formato de tarjetas usando componentes Lino -->
<div class="lino-grid lino-grid--3-col mb-4" id="productos-container">
    {% for producto in productos %}
    <div class="lino-card hover-card">
        <!-- Header del producto usando componente -->
        {% lino_card_header producto.nombre "bi-box-seam" "olive" %}
        
        <div class="lino-card-content">
            {% if producto.descripcion %}
                <p class="text-muted small mb-3">{{ producto.descripcion|truncatechars:60 }}</p>
            {% endif %}
            
            <!-- Informaci√≥n principal usando value boxes -->
            <div class="row g-3 mb-3">
                <div class="col-6">
                    {% lino_value_box "$"|add:producto.precio "Precio" "success" "sm" %}
                </div>
                <div class="col-6">
                    {% lino_value_box producto.stock "Stock actual" "primary" "sm" %}
                </div>
            </div>
            
            <!-- Estado del stock usando badge -->
            <div class="mb-3">
                {% if producto.get_estado_stock == 'normal' %}
                    {% lino_badge producto.get_estado_stock_display "success" "lg" "bi-check-circle" %}
                {% elif producto.get_estado_stock == 'critico' %}
                    {% lino_badge producto.get_estado_stock_display|add:" (M√≠n: "|add:producto.stock_minimo|add:")" "warning" "lg" "bi-exclamation-triangle" %}
                {% elif producto.get_estado_stock == 'agotado' %}
                    {% lino_badge producto.get_estado_stock_display "danger" "lg" "bi-x-circle" %}
                {% else %}
                    {% lino_badge producto.get_estado_stock_display "olive" "lg" "bi-info-circle" %}
                {% endif %}
            </div>
            
            <!-- Categor√≠a usando info section -->
            {% lino_info_section "Categor√≠a" "bi-tag" "earth" %}
            <div class="lino-info-section__content">
                {% lino_badge producto.get_categoria_display "olive" "md" "bi-tag" %}
            </div>
            
            <!-- Atributos diet√©ticos -->
            {% if producto.atributos_dieteticos %}
            {% lino_info_section "Atributos" "bi-award" "green" %}
            <div class="lino-info-section__content">
                <div class="d-flex flex-wrap gap-1">
                    {% for attr in producto.atributos_dieteticos|split:',' %}
                        {% if attr.strip %}
                            {% if attr.strip == 'organico' %}
                                {% lino_badge "Org√°nico" "success" "sm" "bi-flower1" %}
                            {% elif attr.strip == 'vegano' %}
                                {% lino_badge "Vegano" "success" "sm" "bi-leaf" %}
                            {% elif attr.strip == 'sin_tacc' %}
                                {% lino_badge "Sin TACC" "success" "sm" "bi-shield-check" %}
                            {% elif attr.strip == 'sin_azucar' %}
                                {% lino_badge "Sin Az√∫car" "success" "sm" "bi-droplet-half" %}
                            {% elif attr.strip == 'integral' %}
                                {% lino_badge "Integral" "success" "sm" "bi-grain" %}
                            {% elif attr.strip == 'natural' %}
                                {% lino_badge "Natural" "success" "sm" "bi-flower2" %}
                            {% else %}
                                {% lino_badge attr.strip|title "success" "sm" %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Marca y origen -->
            {% if producto.marca or producto.origen %}
            {% lino_info_section "Informaci√≥n Adicional" "bi-info-circle" "brown" %}
            <div class="lino-info-section__content">
                {% if producto.marca %}
                    <div class="text-muted small">Marca: <span class="text-dark fw-medium">{{ producto.marca }}</span></div>
                {% endif %}
                {% if producto.origen %}
                    <div class="text-muted small">Origen: <span class="text-dark fw-medium">{{ producto.origen }}</span></div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Acciones -->
            <div class="border-top pt-3 mt-3">
                <div class="d-flex gap-2">
                    {% lino_btn "Editar" "{% url 'gestion:editar_producto' producto.id %}" "primary" "sm" "bi-pencil" %}
                    {% lino_btn "Eliminar" "#" "danger" "sm" "bi-trash" "onclick='confirmarEliminacion({{ producto.id }}, \"{{ producto.nombre|escapejs }}\", {{ producto.precio|default:0 }}, {{ producto.stock|default:0 }}, \"{{ producto.get_categoria_display|escapejs }}\"); return false;'" %}
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="lino-card text-center py-5">
            {% if query or categoria_seleccionada or estado_stock %}
                {% lino_icon "bi-search" "text-muted opacity-50 mb-3" "display-4" %}
                <h5 class="text-muted">No se encontraron productos</h5>
                <p class="text-muted mb-4">No hay productos que coincidan con los filtros aplicados</p>
                {% lino_btn "Ver todos los productos" "{% url 'gestion:lista_productos' %}" "outline" "md" "bi-arrow-clockwise" %}
            {% else %}
                {% lino_icon "bi-box-seam" "text-muted opacity-50 mb-3" "display-4" %}
                <h5 class="text-muted">No hay productos registrados</h5>
                <p class="text-muted mb-4">Agrega tu primer producto al inventario</p>
                {% lino_btn "Agregar Producto" "{% url 'gestion:crear_producto' %}" "primary" "lg" "bi-plus-circle" %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Paginaci√≥n si es necesaria -->
{% if productos.has_other_pages %}
<div class="d-flex justify-content-center">
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if productos.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ productos.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if categoria_seleccionada %}&categoria={{ categoria_seleccionada }}{% endif %}{% if estado_stock %}&estado_stock={{ estado_stock }}{% endif %}">Anterior</a>
                </li>
            {% endif %}
            
            {% for num in productos.paginator.page_range %}
                {% if productos.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                {% elif num > productos.number|add:'-3' and num < productos.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if categoria_seleccionada %}&categoria={{ categoria_seleccionada }}{% endif %}{% if estado_stock %}&estado_stock={{ estado_stock }}{% endif %}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if productos.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ productos.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if categoria_seleccionada %}&categoria={{ categoria_seleccionada }}{% endif %}{% if estado_stock %}&estado_stock={{ estado_stock }}{% endif %}">Siguiente</a>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// Calcular KPIs din√°micamente
document.addEventListener('DOMContentLoaded', function() {
    // Contar productos por estado
    let stockCritico = 0;
    let productosAgotados = 0;
    let valorTotal = 0;
    
    {% for producto in productos %}
        {% if producto.get_estado_stock == 'critico' %}
            stockCritico++;
        {% elif producto.get_estado_stock == 'agotado' %}
            productosAgotados++;
        {% endif %}
        valorTotal += {{ producto.precio|default:0 }} * {{ producto.stock|default:0 }};
    {% endfor %}
    
    // Actualizar KPI cards
    const stockCriticoKpi = document.querySelector('#stock-critico-kpi .lino-kpi-card__value');
    const agotadosKpi = document.querySelector('#agotados-kpi .lino-kpi-card__value');
    const valorInventarioKpi = document.querySelector('#valor-inventario-kpi .lino-kpi-card__value');
    
    if (stockCriticoKpi) stockCriticoKpi.textContent = stockCritico;
    if (agotadosKpi) agotadosKpi.textContent = productosAgotados;
    if (valorInventarioKpi) valorInventarioKpi.textContent = '$' + valorTotal.toLocaleString();
    
    // Env√≠o autom√°tico de formularios
    document.getElementById('filtrosForm').addEventListener('submit', function(e) {
        e.preventDefault();
        this.submit();
    });
});

// Funci√≥n para confirmar eliminaci√≥n
function confirmarEliminacion(id, nombre, precio, stock, categoria) {
    const modal = new bootstrap.Modal(document.getElementById('eliminarModal'));
    
    document.getElementById('productoNombre').textContent = nombre;
    document.getElementById('productoInfo').innerHTML = 
        `<strong>Categor√≠a:</strong> ${categoria}<br>
         <strong>Precio:</strong> $${precio}<br>
         <strong>Stock:</strong> ${stock} unidades`;
    
    // Configurar formulario
    document.getElementById('eliminarForm').action = `{% url 'gestion:eliminar_producto' 0 %}`.replace('0', id);
    
    // Reset checkbox
    const checkbox = document.getElementById('confirmarEliminacion');
    const btnEliminar = document.getElementById('btnEliminar');
    checkbox.checked = false;
    btnEliminar.disabled = true;
    
    // Habilitar bot√≥n cuando se marque checkbox
    checkbox.addEventListener('change', function() {
        btnEliminar.disabled = !this.checked;
    });
    
    modal.show();
}

// Confirmaci√≥n adicional antes de enviar
document.getElementById('eliminarForm').addEventListener('submit', function(e) {
    if (!confirm('¬øEst√°s absolutamente seguro? Esta acci√≥n no se puede deshacer.')) {
        e.preventDefault();
    }
});
</script>

<!-- Modal de Confirmaci√≥n de Eliminaci√≥n usando componentes Lino -->
<div class="modal fade" id="eliminarModal" tabindex="-1" aria-labelledby="eliminarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="eliminarModalLabel">
                    {% lino_icon "bi-trash3" "me-2" %} Confirmar Eliminaci√≥n
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    {% lino_icon "bi-exclamation-triangle" "text-warning" "display-4" %}
                </div>
                
                <h5 class="text-danger mb-2" id="productoNombre"></h5>
                <p class="text-muted mb-3" id="productoInfo"></p>
                
                <div class="alert alert-warning">
                    {% lino_icon "bi-exclamation-triangle" "me-2" %}
                    Esta acci√≥n no se puede deshacer
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmarEliminacion">
                    <label class="form-check-label" for="confirmarEliminacion">
                        Confirmo que deseo eliminar este producto
                    </label>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                {% lino_btn "Cancelar" "#" "outline" "md" "" "data-bs-dismiss='modal'" %}
                <form id="eliminarForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="lino-btn lino-btn--danger" id="btnEliminar" disabled>
                        {% lino_icon "bi-trash3" "me-2" %} Eliminar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
