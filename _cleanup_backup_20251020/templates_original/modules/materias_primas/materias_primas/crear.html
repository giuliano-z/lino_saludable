{% extends 'gestion/base.html' %}
{% load dietetica_tags %}

{% block title %}Crear Materia Prima - LINO SYS{% endblock %}

{% block header %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1">Nueva Materia Prima</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="{% url 'gestion:panel_control' %}" class="text-decoration-none">
                        {% lino_icon "bi-house-door" "me-1" %}Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'gestion:lista_materias_primas_migrado' %}" class="text-decoration-none">
                        {% lino_icon "bi-box2" "me-1" %}Materias Primas
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    {% lino_icon "bi-plus-circle" "me-1" %}Nueva
                </li>
            </ol>
        </nav>
    </div>
    {% lino_badge "FORMULARIO MIGRADO - LINO" "success" "lg" "bi-check-circle" %}
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            
            <form method="post" novalidate>
                {% csrf_token %}
                
                <!-- Informaci칩n B치sica usando lino_info_section -->
                {% lino_info_section "Informaci칩n B치sica" "bi-box2" "green" %}
                <div class="lino-info-section__content">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="{{ form.nombre.id_for_label }}" class="form-label fw-medium">
                                {{ form.nombre.label }}
                                <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    {% lino_icon "bi-box2" "text-muted" %}
                                </span>
                                {{ form.nombre }}
                            </div>
                            {% if form.nombre.errors %}
                                <div class="text-danger small mt-1">{{ form.nombre.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.categoria.id_for_label }}" class="form-label fw-medium">
                                {{ form.categoria.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    {% lino_icon "bi-tag" "text-muted" %}
                                </span>
                                {{ form.categoria }}
                            </div>
                            {% if form.categoria.errors %}
                                <div class="text-danger small mt-1">{{ form.categoria.errors.0 }}</div>
                            {% endif %}
                        </div>

                        {% if form.descripcion %}
                        <div class="col-12">
                            <label for="{{ form.descripcion.id_for_label }}" class="form-label fw-medium">
                                {{ form.descripcion.label }}
                            </label>
                            {{ form.descripcion }}
                            {% if form.descripcion.errors %}
                                <div class="text-danger small mt-1">{{ form.descripcion.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">Descripci칩n detallada de la materia prima</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Stock y Unidades usando lino_info_section -->
                {% lino_info_section "Stock y Unidades" "bi-boxes" "olive" %}
                <div class="lino-info-section__content">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="{{ form.stock_actual.id_for_label }}" class="form-label fw-medium">
                                {{ form.stock_actual.label|default:"Stock Inicial" }}
                                <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    {% lino_icon "bi-boxes" "text-muted" %}
                                </span>
                                {{ form.stock_actual|default:form.stock }}
                            </div>
                            <div class="form-text">Cantidad inicial de stock</div>
                            {% if form.stock_actual.errors %}
                                <div class="text-danger small mt-1">{{ form.stock_actual.errors.0 }}</div>
                            {% elif form.stock.errors %}
                                <div class="text-danger small mt-1">{{ form.stock.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.unidad.id_for_label }}" class="form-label fw-medium">
                                {{ form.unidad.label }}
                                <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    {% lino_icon "bi-rulers" "text-muted" %}
                                </span>
                                {{ form.unidad }}
                            </div>
                            <div class="form-text">Unidad de medida (kg, gr, lt, etc.)</div>
                            {% if form.unidad.errors %}
                                <div class="text-danger small mt-1">{{ form.unidad.errors.0 }}</div>
                            {% endif %}
                        </div>

                        {% if form.costo_unitario %}
                        <div class="col-md-6">
                            <label for="{{ form.costo_unitario.id_for_label }}" class="form-label fw-medium">
                                {{ form.costo_unitario.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    {% lino_icon "bi-currency-dollar" "text-muted" %}
                                </span>
                                {{ form.costo_unitario }}
                            </div>
                            <div class="form-text">Costo por unidad</div>
                            {% if form.costo_unitario.errors %}
                                <div class="text-danger small mt-1">{{ form.costo_unitario.errors.0 }}</div>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if form.stock_minimo %}
                        <div class="col-md-6">
                            <label for="{{ form.stock_minimo.id_for_label }}" class="form-label fw-medium">
                                {{ form.stock_minimo.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    {% lino_icon "bi-exclamation-triangle" "text-muted" %}
                                </span>
                                {{ form.stock_minimo }}
                            </div>
                            <div class="form-text">Cantidad m칤nima para alertas</div>
                            {% if form.stock_minimo.errors %}
                                <div class="text-danger small mt-1">{{ form.stock_minimo.errors.0 }}</div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Informaci칩n del Proveedor usando lino_info_section -->
                {% lino_info_section "Informaci칩n del Proveedor" "bi-building" "brown" %}
                <div class="lino-info-section__content">
                    <div class="row g-3">
                        {% if form.proveedor %}
                        <div class="col-md-6">
                            <label for="{{ form.proveedor.id_for_label }}" class="form-label fw-medium">
                                {{ form.proveedor.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    {% lino_icon "bi-building" "text-muted" %}
                                </span>
                                {{ form.proveedor }}
                            </div>
                            <div class="form-text">Nombre del proveedor principal</div>
                            {% if form.proveedor.errors %}
                                <div class="text-danger small mt-1">{{ form.proveedor.errors.0 }}</div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="col-md-6">
                            <div class="alert alert-info border-0">
                                <div class="d-flex align-items-start">
                                    {% lino_icon "bi-info-circle" "text-info me-2 mt-1" %}
                                    <div>
                                        <div class="fw-medium small">Opcional</div>
                                        <div class="small">Puedes agregar informaci칩n del proveedor para un mejor control</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Errores generales del formulario -->
                {% if form.non_field_errors %}
                    <div class="alert alert-danger border-0 shadow-sm mb-4">
                        {% lino_icon "bi-exclamation-triangle" "me-2" %}
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                <!-- Botones de acci칩n usando lino_btn -->
                <div class="lino-card mt-4">
                    <div class="lino-card-content bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            {% lino_btn "Cancelar" "{% url 'gestion:lista_materias_primas_migrado' %}" "outline" "lg" "bi-arrow-left" %}
                            {% lino_btn "Crear Materia Prima" "#" "primary" "lg" "bi-check-circle" "type='submit'" %}
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Panel de ayuda usando lino_card -->
        <div class="col-lg-4">
            <div class="lino-card">
                {% lino_card_header "Consejos" "bi-lightbulb" "warning" %}
                <div class="lino-card-content">
                    
                    {% lino_info_section "Inventario" "bi-archive" "success" %}
                    <div class="lino-info-section__content">
                        <p class="small text-muted mb-0">
                            Registra el stock inicial de tu materia prima. Esto te ayudar치 a controlar tu inventario desde el principio.
                        </p>
                    </div>
                    
                    {% lino_info_section "Unidades" "bi-rulers" "earth" %}
                    <div class="lino-info-section__content">
                        <p class="small text-muted mb-2">
                            Usa unidades est치ndar como:
                        </p>
                        <div class="d-flex flex-wrap gap-1">
                            {% lino_badge "kg" "olive" "sm" %}
                            {% lino_badge "gr" "olive" "sm" %}
                            {% lino_badge "lt" "olive" "sm" %}
                            {% lino_badge "ml" "olive" "sm" %}
                            {% lino_badge "unidad" "olive" "sm" %}
                        </div>
                    </div>
                    
                    {% lino_info_section "Categor칤as" "bi-tags" "brown" %}
                    <div class="lino-info-section__content">
                        <p class="small text-muted mb-0">
                            Las categor칤as te ayudan a organizar mejor tu inventario para b칰squedas y reportes.
                        </p>
                    </div>
                    
                    <div class="alert alert-info border-0 shadow-sm mt-3">
                        <div class="d-flex align-items-start">
                            {% lino_icon "bi-lightbulb" "text-info me-2 mt-1" %}
                            <div>
                                <div class="fw-medium small">游눠 Tip</div>
                                <div class="small">Una vez creada la materia prima, podr치s registrar compras para mantener actualizado el stock autom치ticamente.</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Atajos r치pidos -->
                    <div class="mt-4">
                        <h6 class="small fw-bold text-muted mb-2">ACCIONES R츼PIDAS</h6>
                        <div class="d-grid gap-2">
                            {% lino_btn "Ver Lista" "{% url 'gestion:lista_materias_primas_migrado' %}" "outline" "sm" "bi-list" %}
                            {% lino_btn "Reportes" "{% url 'gestion:reporte_stock_materias_primas' %}" "earth" "sm" "bi-graph-up" %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview din치mico del valor calculado -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const stockInput = document.querySelector('input[name="{{ form.stock_actual.name }}"], input[name="{{ form.stock.name }}"]');
    const costoInput = document.querySelector('input[name="{{ form.costo_unitario.name }}"]');
    
    function calcularValorTotal() {
        if (stockInput && costoInput) {
            const stock = parseFloat(stockInput.value) || 0;
            const costo = parseFloat(costoInput.value) || 0;
            const valorTotal = stock * costo;
            
            // Actualizar valor en tiempo real si existe un elemento para mostrarlo
            const valorDisplay = document.getElementById('valor-total-preview');
            if (valorDisplay) {
                valorDisplay.textContent = `$${valorTotal.toFixed(2)}`;
            }
        }
    }
    
    if (stockInput) stockInput.addEventListener('input', calcularValorTotal);
    if (costoInput) costoInput.addEventListener('input', calcularValorTotal);
    
    // Calcular inicial
    calcularValorTotal();
});
</script>
{% endblock %}
