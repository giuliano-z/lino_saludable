{% extends 'gestion/base.html' %}
{% load dietetica_tags %}

{% block title %}Dashboard - LINO SYS{% endblock %}

{% block header %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1">Dashboard</h1>
        <p class="text-muted mb-0">Panel de control general del sistema</p>
    </div>
    {% lino_badge "SISTEMA ACTIVO" "success" "lg" "bi-circle-fill" %}
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Banner de Alertas Críticas -->
    {% if productos_sin_stock > 0 or materias_stock_critico > 0 %}
    <div class="alert alert-warning border-0 shadow-sm mb-4" role="alert">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
            <div>
                <strong>¡Atención!</strong> 
                {% if productos_sin_stock > 0 %}{{ productos_sin_stock }} producto(s) sin stock{% endif %}
                {% if productos_sin_stock > 0 and materias_stock_critico > 0 %} y {% endif %}
                {% if materias_stock_critico > 0 %}{{ materias_stock_critico }} materia(s) prima(s) en stock crítico{% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- KPIs Principales con animaciones -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="lino-card modern-kpi-card">
                <div class="lino-card-content p-4 position-relative">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small mb-2">Ingresos del Mes</div>
                            <div class="h3 mb-1 fw-bold text-dark animated-number" data-value="{{ ingresos_mes|floatformat:0|default:'0' }}">$0</div>
                            <div class="d-flex align-items-center">
                                {% if tendencia_ingresos >= 0 %}
                                    <i class="bi bi-arrow-up text-success me-1"></i>
                                    <span class="text-success small fw-medium">+{{ tendencia_ingresos|floatformat:1 }}% vs mes anterior</span>
                                {% else %}
                                    <i class="bi bi-arrow-down text-danger me-1"></i>
                                    <span class="text-danger small fw-medium">{{ tendencia_ingresos|floatformat:1 }}% vs mes anterior</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="kpi-icon-corner bg-success">
                            <i class="bi bi-currency-dollar text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="lino-card modern-kpi-card">
                <div class="lino-card-content p-4 position-relative">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small mb-2">Productos en Stock</div>
                            <div class="h3 mb-1 fw-bold text-dark animated-number" data-value="{{ total_productos|default:'0' }}">0</div>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                                <span class="text-warning small fw-medium">{{ productos_stock_bajo_count|default:"0" }} por agotarse</span>
                            </div>
                        </div>
                        <div class="kpi-icon-corner bg-primary">
                            <i class="bi bi-box-seam text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="lino-card modern-kpi-card">
                <div class="lino-card-content p-4 position-relative">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small mb-2">Materias Críticas</div>
                            <div class="h3 mb-1 fw-bold text-dark animated-number" data-value="{{ materias_stock_critico|default:'0' }}">0</div>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-arrow-down text-danger me-1"></i>
                                <span class="text-danger small fw-medium">Requieren reposición</span>
                            </div>
                        </div>
                        <div class="kpi-icon-corner bg-danger">
                            <i class="bi bi-exclamation-circle text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="lino-card modern-kpi-card">
                <div class="lino-card-content p-4 position-relative">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="text-muted small mb-2">Margen Mensual</div>
                            <div class="h3 mb-1 fw-bold text-dark animated-number" data-value="{{ porcentaje_margen|default:'0' }}">0%</div>
                            <div class="d-flex align-items-center">
                                {% if tendencia_ingresos >= 0 %}
                                    <i class="bi bi-arrow-up text-success me-1"></i>
                                    <span class="text-success small fw-medium">+{{ tendencia_ingresos }}% vs mes anterior</span>
                                {% else %}
                                    <i class="bi bi-arrow-down text-danger me-1"></i>
                                    <span class="text-danger small fw-medium">{{ tendencia_ingresos }}% vs mes anterior</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="kpi-icon-corner bg-info">
                            <i class="bi bi-percent text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos y Actividades -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="lino-card">
                {% lino_card_header "Tendencia de Ventas - Últimos 7 Días" "bi-graph-up" "brown" %}
                <div class="lino-card-content">
                    <div style="height: 300px; position: relative;">
                        <canvas id="ventasChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="lino-card modern-transactions-card">
                <div class="lino-card-content p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0 fw-bold">Transacciones Recientes</h5>
                        {% lino_btn "Ver todas" "{% url 'gestion:lista_ventas' %}" "outline" "sm" "bi-list" %}
                    </div>
                    <div class="transactions-list">
                        {% for venta in ultimas_ventas %}
                        <div class="transaction-item d-flex align-items-center py-3 {% if not forloop.last %}border-bottom{% endif %}">
                            <div class="transaction-icon-modern bg-success d-flex align-items-center justify-content-center me-3">
                                <i class="bi bi-plus text-white fw-bold"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-medium">Venta #{{ venta.id }}</div>
                                <div class="text-muted small">{{ venta.fecha|timesince }}</div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-success">+${{ venta.total }}</div>
                                <div class="small text-muted">{{ venta.cliente|default:"Cliente general" }}</div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            <i class="bi bi-receipt text-muted mb-2" style="font-size: 2rem;"></i>
                            <p class="text-muted mb-0">No hay transacciones recientes</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones Rápidas -->
    <div class="row g-4 mb-5">
        <div class="col-lg-6">
            <div class="lino-card modern-actions-card">
                {% lino_card_header "Acciones Rápidas" "bi-lightning-charge" "warning" %}
                <div class="lino-card-content">
                    <div class="d-grid gap-3">
                        {% lino_btn "Nueva Venta" "{% url 'gestion:crear_venta' %}" "primary" "lg" "bi-cart-plus" "class='d-flex align-items-center justify-content-start p-3'" %}
                        {% lino_btn "Agregar Producto" "{% url 'gestion:crear_producto' %}" "earth" "lg" "bi-box-seam" "class='d-flex align-items-center justify-content-start p-3'" %}
                        {% lino_btn "Generar Reporte" "{% url 'gestion:reportes' %}" "olive" "lg" "bi-graph-up" "class='d-flex align-items-center justify-content-start p-3'" %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="lino-card modern-alerts-card">
                {% lino_card_header "Alertas y Notificaciones" "bi-bell" "warning" %}
                <div class="lino-card-content">
                    <div class="alerts-list">
                        {% for producto in productos_stock_bajo %}
                        <div class="alert-modern alert-danger-modern mb-3 p-3 rounded bg-danger-subtle border border-danger-subtle">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-exclamation-triangle text-danger me-3 mt-1"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-medium">Stock Crítico</div>
                                    <div class="small text-muted mb-2">{{ producto.nombre }} tiene solo {{ producto.stock }} unidades restantes</div>
                                    {% lino_btn "Reponer ahora" "{% url 'gestion:lista_productos' %}" "danger" "sm" "bi-arrow-up-circle" %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-4">
                            {% lino_icon "bi-check-circle" "text-success mb-2 fs-1" %}
                            <p class="text-success mb-0 fw-medium">¡Todo está en orden!</p>
                            <small class="text-muted">No hay alertas críticas</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuración del gráfico con colores LINO
    const ctx = document.getElementById('ventasChart').getContext('2d');
    const primaryGreen = getComputedStyle(document.documentElement).getPropertyValue('--lino-brown') || '#8B4513';
    
    const ventasChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ labels_7_dias|safe }},
            datasets: [{
                label: 'Ventas',
                data: {{ ventas_ultimos_7_dias|safe }},
                borderColor: primaryGreen,
                backgroundColor: primaryGreen + '20',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: primaryGreen,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8,
                pointHoverBackgroundColor: primaryGreen,
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(52,76,57,0.95)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: primaryGreen,
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return 'Ventas: $' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#64748b',
                        font: {
                            size: 12
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(148,163,184,0.1)',
                        borderDash: [5, 5]
                    },
                    ticks: {
                        color: '#64748b',
                        font: {
                            size: 12
                        },
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            },
            elements: {
                line: {
                    tension: 0.4
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });

    // SAGE - Efecto de números animados mejorado
    function animateNumber(element, start, end, duration, prefix = '', suffix = '') {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const current = Math.floor(progress * (end - start) + start);
            element.innerHTML = prefix + current.toLocaleString() + suffix;
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    // Animar los números de los KPIs al cargar la página
    document.querySelectorAll('.animated-number').forEach(el => {
        const value = el.getAttribute('data-value');
        const cleanValue = value.replace(/[^\d]/g, '');
        
        if (cleanValue && !isNaN(cleanValue)) {
            const number = parseInt(cleanValue);
            if (number > 0) {
                // Detectar prefijo y sufijo
                const prefix = value.includes('$') ? '$' : '';
                const suffix = value.includes('%') ? '%' : '';
                
                el.textContent = prefix + '0' + suffix;
                setTimeout(() => {
                    animateNumber(el, 0, number, 1500, prefix, suffix);
                }, 200);
            }
        }
    });
});
</script>

<style>
/* SAGE - Estilos mejorados para KPI cards */
.modern-kpi-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.modern-kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

.kpi-icon-corner {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.transaction-icon-modern {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 0.9rem;
}

.animated-number {
    transition: all 0.3s ease;
}

/* Alertas modernas */
.alert-modern {
    border-radius: 12px;
    border: none;
}

.alert-danger-modern {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== ANIMACIONES DE NÚMEROS SAGE =====
    function animateNumber(element, start, end, duration = 2000) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const current = Math.floor(progress * (end - start) + start);
            
            // Mantener formato original (con $ o %)
            const formatted = element.getAttribute('data-formatted');
            if (formatted && formatted.includes('$')) {
                element.innerHTML = '$' + current.toLocaleString();
            } else if (formatted && formatted.includes('%')) {
                element.innerHTML = current + '%';
            } else {
                element.innerHTML = current.toLocaleString();
            }
            
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    // Animar números KPI al cargar
    document.querySelectorAll('.lino-animated-number').forEach(el => {
        const target = el.getAttribute('data-target');
        if (target && !isNaN(target)) {
            const number = parseInt(target);
            if (number > 0) {
                el.innerHTML = '0';
                setTimeout(() => {
                    animateNumber(el, 0, number, 2000);
                }, 500 + Math.random() * 500); // Stagger animations
            }
        }
    });

    // ===== GRÁFICO DE VENTAS =====
    const ctx = document.getElementById('ventasChart');
    if (ctx) {
        const ventasChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [{% for dia in ventas_ultimos_7_dias %}'{{ dia.fecha }}'{% if not forloop.last %},{% endif %}{% endfor %}],
                datasets: [{
                    label: 'Ventas ($)',
                    data: [{% for dia in ventas_ultimos_7_dias %}{{ dia.total }}{% if not forloop.last %},{% endif %}{% endfor %}],
                    borderColor: 'var(--lino-earth)',
                    backgroundColor: 'var(--lino-earth-light)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: 'var(--lino-brown)',
                    pointBorderColor: 'var(--lino-earth)',
                    pointBorderWidth: 2,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(148,163,184,0.1)',
                            borderDash: [5, 5]
                        },
                        ticks: {
                            color: '#64748b',
                            font: {
                                size: 12
                            },
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(148,163,184,0.1)',
                            borderDash: [5, 5]
                        },
                        ticks: {
                            color: '#64748b',
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                elements: {
                    line: {
                        tension: 0.4
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });

        // === ANIMACIÓN DE NÚMEROS ORIGINALES ===
        function animateNumber(element, start, end, duration, suffix = '') {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const current = Math.floor(progress * (end - start) + start);
                element.innerHTML = current.toLocaleString() + suffix;
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // Animar números de KPIs con detección inteligente
        document.querySelectorAll('.lino-animated-number').forEach((el, index) => {
            const target = el.getAttribute('data-target');
            if (target && !isNaN(target)) {
                const number = parseInt(target);
                const hasPercent = el.textContent.includes('%');
                const suffix = hasPercent ? '%' : '';
                
                // Resetear a 0
                el.textContent = '0' + suffix;
                
                // Animar con delay escalonado
                setTimeout(() => {
                    animateNumber(el, 0, number, 1500, suffix);
                }, index * 200 + 300);
            }
        });

        // También animar números con clase .animated-number (compatibilidad)
        document.querySelectorAll('.animated-number').forEach((el, index) => {
            const value = el.getAttribute('data-value');
            if (value && !isNaN(value)) {
                const number = parseInt(value);
                const hasPercent = el.textContent.includes('%');
                const suffix = hasPercent ? '%' : '';
                
                el.textContent = '0' + suffix;
                setTimeout(() => {
                    animateNumber(el, 0, number, 1500, suffix);
                }, index * 200 + 300);
            }
        });
    }
});
</script>
{% endblock %}