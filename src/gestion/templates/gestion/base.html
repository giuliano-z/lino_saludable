{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}LINO Diet√©tica{% endblock %}</title>
    
    <!-- Favicon LINO -->
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}">
    <link rel="alternate icon" href="{% static 'favicon.svg' %}" type="image/svg+xml">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <!-- üåø LINO DESIGN SYSTEM - PALETA NATURAL VERDE OLIVA -->
    <link rel="stylesheet" href="{% static 'css/lino-main.css' %}?v=20241105c">
    <!-- <link rel="stylesheet" href="{% static 'css/lino-enterprise-components.css' %}?v=20241031"> -->
    
    <!-- FASE 3: Sistema de Alertas UI -->
    <link rel="stylesheet" href="{% static 'css/lino-alertas.css' %}?v=20241104">`
    
    <!-- Chart.js para gr√°ficos inteligentes -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- üåø SIDEBAR ESPECTACULAR LINO -->
    <nav class="lino-sidebar">
        <div class="lino-sidebar__brand">
            <div class="lino-sidebar__brand-icon">
                <i class="bi bi-heart-pulse"></i>
            </div>
            <div class="lino-sidebar__brand-content">
                <h1 class="lino-sidebar__brand-text">LINO</h1>
                <div class="lino-sidebar__brand-subtitle">üå± DIET√âTICA NATURAL</div>
            </div>
        </div>
        
        <div class="lino-sidebar__nav">
            <!-- üè† PRINCIPAL -->
            <div class="lino-sidebar__nav-section">
                <div class="lino-sidebar__nav-title">
                    <i class="bi bi-house-heart me-2"></i>Principal
                </div>
                <a class="lino-sidebar__nav-link {% if request.resolver_match.url_name == 'panel_control' %}lino-sidebar__nav-link--active{% endif %}" 
                   href="{% url 'gestion:panel_control' %}">
                    <i class="bi bi-grid-1x2 lino-sidebar__nav-icon"></i>
                    <span>Dashboard</span>
                    <div class="lino-sidebar__nav-indicator"></div>
                </a>
                <a class="lino-sidebar__nav-link {% if 'producto' in request.resolver_match.url_name %}lino-sidebar__nav-link--active{% endif %}" 
                   href="{% url 'gestion:lista_productos' %}">
                    <i class="bi bi-basket3 lino-sidebar__nav-icon"></i>
                    <span>Productos Naturales</span>
                    <div class="lino-sidebar__nav-indicator"></div>
                </a>
                <a class="lino-sidebar__nav-link {% if 'inventario' in request.resolver_match.url_name or 'materias_primas' in request.resolver_match.url_name %}lino-sidebar__nav-link--active{% endif %}" 
                   href="{% url 'gestion:lista_inventario' %}">
                    <i class="bi bi-boxes lino-sidebar__nav-icon"></i>
                    <span>Inventario</span>
                    <div class="lino-sidebar__nav-indicator"></div>
                </a>
            </div>
            
            <!-- OPERACIONES -->
            <div class="lino-sidebar__nav-section">
                <div class="lino-sidebar__nav-title">Operaciones</div>
                <a class="lino-sidebar__nav-link {% if 'compra' in request.resolver_match.url_name %}lino-sidebar__nav-link--active{% endif %}" 
                   href="{% url 'gestion:lista_compras' %}">
                    <i class="bi bi-truck lino-sidebar__nav-icon"></i>
                    Compras
                </a>
                <a class="lino-sidebar__nav-link {% if 'venta' in request.resolver_match.url_name %}lino-sidebar__nav-link--active{% endif %}" 
                   href="{% url 'gestion:lista_ventas' %}">
                    <i class="bi bi-cart-check lino-sidebar__nav-icon"></i>
                    Ventas
                </a>
                <a class="lino-sidebar__nav-link {% if 'receta' in request.resolver_match.url_name %}lino-sidebar__nav-link--active{% endif %}" 
                   href="{% url 'gestion:lista_recetas' %}">
                    <i class="bi bi-journal-bookmark lino-sidebar__nav-icon"></i>
                    Recetas
                </a>
            </div>
            
            <!-- AN√ÅLISIS -->
            <div class="lino-sidebar__nav-section">
                <div class="lino-sidebar__nav-title">An√°lisis</div>
                <a class="lino-sidebar__nav-link {% if 'rentabilidad' in request.resolver_match.url_name %}lino-sidebar__nav-link--active{% endif %}" 
                   href="{% url 'gestion:dashboard_rentabilidad' %}">
                    <i class="bi bi-graph-up-arrow lino-sidebar__nav-icon"></i>
                    Rentabilidad
                </a>
                <a class="lino-sidebar__nav-link {% if 'reporte' in request.resolver_match.url_name %}lino-sidebar__nav-link--active{% endif %}" 
                   href="{% url 'gestion:reportes' %}">
                    <i class="bi bi-bar-chart lino-sidebar__nav-icon"></i>
                    Reportes
                </a>
            </div>
            
            <!-- SISTEMA -->
            <div class="lino-sidebar__nav-section">
                <div class="lino-sidebar__nav-title">Sistema</div>
                <a class="lino-sidebar__nav-link {% if 'usuario' in request.resolver_match.url_name %}lino-sidebar__nav-link--active{% endif %}" 
                   href="{% url 'gestion:usuarios' %}">
                    <i class="bi bi-people lino-sidebar__nav-icon"></i>
                    Usuarios
                </a>
                <a class="lino-sidebar__nav-link {% if request.resolver_match.url_name == 'configuracion_negocio' %}lino-sidebar__nav-link--active{% endif %}" 
                   href="{% url 'gestion:configuracion_negocio' %}">
                    <i class="bi bi-sliders lino-sidebar__nav-icon"></i>
                    Objetivos de Negocio
                </a>
                <a class="lino-sidebar__nav-link {% if request.resolver_match.url_name == 'configuracion' %}lino-sidebar__nav-link--active{% endif %}" 
                   href="{% url 'gestion:configuracion' %}">
                    <i class="bi bi-gear lino-sidebar__nav-icon"></i>
                    Configuraci√≥n
                </a>
                <a class="lino-sidebar__nav-link" href="{% url 'logout' %}">
                    <i class="bi bi-box-arrow-right lino-sidebar__nav-icon"></i>
                    Salir
                </a>
            </div>
        </div>
    </nav>
    
    <!-- üè† √ÅREA PRINCIPAL -->
    <div class="lino-main">
        <div class="lino-main__header">
            <h1 class="lino-main__title">{% block header %}Dashboard{% endblock %}</h1>
            <div class="lino-main__user">
                <!-- Alertas Bell Icon -->
                <div class="position-relative me-3">
                    <a href="#" 
                       id="alertas-bell" 
                       onclick="toggleAlertasPanel(event)" 
                       title="Notificaciones">
                        <i class="bi bi-bell fs-5"></i>
                        <span id="alertas-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" 
                              style="display: none;">
                            0
                        </span>
                    </a>
                </div>
                
                <span class="lino-main__user-name">{{ user.get_full_name|default:user.username }}</span>
                <div class="lino-main__user-avatar">
                    {{ user.username|first|upper }}
                </div>
            </div>
        </div>
        
        <div class="lino-main__content">
            {% if messages %}
                {% for message in messages %}
                    <div class="lino-alert {% if message.tags == 'success' %}lino-alert--success{% elif message.tags == 'error' %}lino-alert--danger{% endif %}">
                        <div class="lino-alert__content">
                            <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %} lino-alert__icon"></i>
                            <div class="lino-alert__text">{{ message }}</div>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
            
            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- üîî CONTENEDOR DE NOTIFICACIONES -->
    <div id="lino-notifications-container" class="lino-notifications-container"></div>

    <!-- FASE 3: Alertas Panel (Slide-in) -->
    {% include 'components/alertas_panel.html' %}

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- LINO JS Core -->
    <script src="{% static 'js/lino-theme.js' %}"></script>
    <script src="{% static 'js/lino-inteligencia.js' %}"></script>
    
    <!-- FASE 3: Sistema de Alertas UI -->
    <script src="{% static 'js/lino-alertas.js' %}?v=20241104"></script>
    
    <!-- üîî SISTEMA DE NOTIFICACIONES LINO V3 -->
    <script>
    class LinoNotifications {
        constructor() {
            this.container = document.getElementById('lino-notifications-container');
            this.notifications = new Map();
            this.idCounter = 0;
        }

        show(type, title, message, options = {}) {
            const id = ++this.idCounter;
            const autoClose = options.autoClose !== false;
            const duration = options.duration || 5000;
            const actions = options.actions || [];

            const notification = this.createNotification(id, type, title, message, actions, autoClose);
            this.container.appendChild(notification);
            this.notifications.set(id, notification);

            // Mostrar con animaci√≥n
            setTimeout(() => notification.classList.add('active'), 100);

            // Auto-cerrar
            if (autoClose) {
                setTimeout(() => this.remove(id), duration);
            }

            return id;
        }

        createNotification(id, type, title, message, actions, autoClose) {
            const notification = document.createElement('div');
            notification.className = `lino-notification lino-notification--${type}`;
            notification.dataset.id = id;

            const icons = {
                success: '‚úÖ',
                warning: '‚ö†Ô∏è',
                error: '‚ùå',
                info: '‚ÑπÔ∏è'
            };

            const actionsHTML = actions.length > 0 ? `
                <div class="lino-notification-actions">
                    ${actions.map(action => `
                        <button class="lino-notification-btn lino-notification-btn--${action.type || 'secondary'}" 
                                onclick="${action.onclick}">
                            ${action.text}
                        </button>
                    `).join('')}
                </div>
            ` : '';

            notification.innerHTML = `
                <div class="lino-notification-header">
                    <div class="lino-notification-icon">
                        ${icons[type] || '‚ÑπÔ∏è'}
                    </div>
                    <div class="lino-notification-content">
                        <h6 class="lino-notification-title">${title}</h6>
                        <p class="lino-notification-message">${message}</p>
                    </div>
                    <button class="lino-notification-close" onclick="window.linoNotifications.remove(${id})">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                ${actionsHTML}
                ${autoClose ? '<div class="lino-notification-progress"></div>' : ''}
            `;

            return notification;
        }

        remove(id) {
            const notification = this.notifications.get(id);
            if (notification) {
                notification.classList.add('exiting');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                    this.notifications.delete(id);
                }, 400);
            }
        }

        success(title, message, options = {}) {
            return this.show('success', title, message, options);
        }

        warning(title, message, options = {}) {
            return this.show('warning', title, message, options);
        }

        error(title, message, options = {}) {
            return this.show('error', title, message, options);
        }

        info(title, message, options = {}) {
            return this.show('info', title, message, options);
        }

        clear() {
            this.notifications.forEach((notification, id) => {
                this.remove(id);
            });
        }
    }

    // Inicializar sistema de notificaciones
    window.linoNotifications = new LinoNotifications();

    // Funciones globales para f√°cil acceso
    window.showNotification = (type, title, message, options) => {
        return window.linoNotifications.show(type, title, message, options);
    };

    window.showSuccess = (title, message, options) => {
        return window.linoNotifications.success(title, message, options);
    };

    window.showWarning = (title, message, options) => {
        return window.linoNotifications.warning(title, message, options);
    };

    window.showError = (title, message, options) => {
        return window.linoNotifications.error(title, message, options);
    };

    window.showInfo = (title, message, options) => {
        return window.linoNotifications.info(title, message, options);
    };
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
