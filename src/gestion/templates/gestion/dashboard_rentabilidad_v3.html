{% extends 'gestion/base.html' %}
{% load static %}
{% load dietetica_tags %}

{% block title %}Control de Rentabilidad - LINO Saludable{% endblock %}

{% block extra_head %}
<style>
body {
    background-color: #fafaf9 !important;
}

/* KPI Cards con Paleta LINO */
.rentabilidad-kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.rentabilidad-kpi-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 2px 12px rgba(74, 92, 58, 0.08);
    border-top: 4px solid var(--card-color);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.rentabilidad-kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 120px;
    height: 120px;
    background: var(--card-color);
    opacity: 0.05;
    border-radius: 50%;
    transform: translate(30%, -30%);
}

.rentabilidad-kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(74, 92, 58, 0.15);
}

.rentabilidad-kpi-card--primary { --card-color: #4a5c3a; }
.rentabilidad-kpi-card--success { --card-color: #4a5c3a; }
.rentabilidad-kpi-card--danger { --card-color: #dc2626; }
.rentabilidad-kpi-card--warning { --card-color: #f59e0b; }

.kpi-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
}

.kpi-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    color: white;
    background: var(--card-color);
    box-shadow: 0 4px 12px rgba(var(--card-color-rgb), 0.3);
}

.kpi-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0;
}

.kpi-value {
    font-size: 2.75rem;
    font-weight: 700;
    color: #111827;
    line-height: 1;
    margin-bottom: 0.5rem;
}

.kpi-subtitle {
    font-size: 0.875rem;
    color: #9ca3af;
}

/* Alertas Compactas */
.alertas-section {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 2px 12px rgba(74, 92, 58, 0.08);
    margin-bottom: 2rem;
}

.alerta-item {
    display: flex;
    align-items: flex-start;
    padding: 1rem;
    border-left: 4px solid var(--alert-color);
    background: var(--alert-bg);
    border-radius: 8px;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
}

.alerta-item:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.alerta-item--critica { --alert-color: #dc2626; --alert-bg: #fef2f2; }
.alerta-item--alta { --alert-color: #f59e0b; --alert-bg: #fffbeb; }
.alerta-item--media { --alert-color: #3b82f6; --alert-bg: #eff6ff; }

.alerta-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: var(--alert-color);
    background: white;
    flex-shrink: 0;
    margin-right: 1rem;
}

.alerta-content {
    flex: 1;
}

.alerta-title {
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.25rem;
    font-size: 0.9375rem;
}

.alerta-message {
    color: #6b7280;
    font-size: 0.875rem;
    margin: 0;
}

.alerta-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-right: 0.5rem;
    margin-top: 0.5rem;
}

.badge-producto { background: #e5e7eb; color: #374151; }
.badge-valor { background: #fef3c7; color: #92400e; }
.badge-recomendacion { background: rgba(74, 92, 58, 0.1); color: #4a5c3a; }

/* Top Productos */
.top-productos-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 2px 12px rgba(74, 92, 58, 0.08);
}

.producto-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 0.75rem;
    background: #f9fafb;
    transition: all 0.2s ease;
}

.producto-item:hover {
    background: rgba(74, 92, 58, 0.05);
    transform: translateX(4px);
}

.producto-rank {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1rem;
    margin-right: 1rem;
    flex-shrink: 0;
}

.rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #92400e; }
.rank-2 { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); color: #374151; }
.rank-3 { background: linear-gradient(135deg, #cd7f32, #e9a55c); color: #78350f; }
.rank-other { background: #e5e7eb; color: #6b7280; }

.producto-info {
    flex: 1;
}

.producto-nombre {
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.25rem;
    font-size: 0.9375rem;
}

.producto-margen {
    font-size: 1.5rem;
    font-weight: 700;
    color: #4a5c3a;
}

/* Section Header */
.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.section-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: rgba(74, 92, 58, 0.1);
    color: #4a5c3a;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.btn-expand {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: 2px solid #e5e7eb;
    background: white;
    color: #6b7280;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-expand:hover {
    border-color: #4a5c3a;
    color: #4a5c3a;
    background: rgba(74, 92, 58, 0.05);
}

@media (max-width: 768px) {
    .kpi-value {
        font-size: 2rem;
    }
    
    .rentabilidad-kpi-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block header %}
<div class="page-header d-flex justify-content-between align-items-center" style="margin-bottom: 2rem;">
    <div>
        <h1 class="h3 mb-1" style="color: #111827; font-weight: 700;">
            <i class="bi bi-graph-up-arrow" style="color: #4a5c3a;"></i>
            Control de Rentabilidad
        </h1>
        <p class="text-muted mb-0">An√°lisis de costos, precios y m√°rgenes de ganancia</p>
    </div>
    <div class="d-flex gap-2">
        <button class="lino-btn lino-btn-ghost" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise"></i> Actualizar
        </button>
        <a href="{% url 'gestion:panel_control' %}" class="lino-btn lino-btn-ghost">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 0 1rem 2rem;">

    <!-- KPIs Principales -->
    <div class="rentabilidad-kpi-grid">
        <!-- Total Productos -->
        <div class="rentabilidad-kpi-card rentabilidad-kpi-card--primary">
            <div class="kpi-header">
                <div>
                    <p class="kpi-title">Total Productos</p>
                </div>
                <div class="kpi-icon">
                    <i class="bi bi-boxes"></i>
                </div>
            </div>
            <div class="kpi-value">{{ analytics.kpis.total_productos|default:"0" }}</div>
            <p class="kpi-subtitle">En el sistema</p>
        </div>

        <!-- Productos Rentables -->
        <div class="rentabilidad-kpi-card rentabilidad-kpi-card--success">
            <div class="kpi-header">
                <div>
                    <p class="kpi-title">Rentables</p>
                </div>
                <div class="kpi-icon">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
            </div>
            <div class="kpi-value">{{ analytics.kpis.porcentaje_rentables|default:"0" }}<span style="font-size: 1.5rem; color: #6b7280;">%</span></div>
            <p class="kpi-subtitle">{{ analytics.kpis.productos_rentables|default:"0" }} productos</p>
        </div>

        <!-- Productos en P√©rdida -->
        <div class="rentabilidad-kpi-card rentabilidad-kpi-card--danger">
            <div class="kpi-header">
                <div>
                    <p class="kpi-title">En P√©rdida</p>
                </div>
                <div class="kpi-icon">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                </div>
            </div>
            <div class="kpi-value">{{ analytics.kpis.porcentaje_perdida|default:"0" }}<span style="font-size: 1.5rem; color: #6b7280;">%</span></div>
            <p class="kpi-subtitle">{{ analytics.kpis.productos_en_perdida|default:"0" }} productos</p>
        </div>

        <!-- Margen Promedio -->
        <div class="rentabilidad-kpi-card rentabilidad-kpi-card--warning">
            <div class="kpi-header">
                <div>
                    <p class="kpi-title">Margen Promedio</p>
                </div>
                <div class="kpi-icon">
                    <i class="bi bi-percent"></i>
                </div>
            </div>
            <div class="kpi-value">{{ analytics.kpis.margen_promedio_ponderado|default:"0" }}<span style="font-size: 1.5rem; color: #6b7280;">%</span></div>
            <p class="kpi-subtitle">Ponderado por ventas</p>
        </div>
    </div>

    <!-- Layout de 2 Columnas -->
    <div class="row g-4">
        <!-- Columna Izquierda: Alertas -->
        <div class="col-lg-7">
            {% if analytics.alertas %}
            <div class="alertas-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="section-icon">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                        </span>
                        Alertas Cr√≠ticas
                    </h2>
                    <span class="badge" style="background: rgba(220, 38, 38, 0.1); color: #dc2626; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600;">
                        {{ analytics.alertas|length }} alertas
                    </span>
                </div>

                <!-- Mostrar solo las primeras 5 alertas -->
                {% for alerta in analytics.alertas|slice:":5" %}
                <div class="alerta-item alerta-item--{% if alerta.severidad == 'critica' %}critica{% elif alerta.severidad == 'alta' %}alta{% else %}media{% endif %}">
                    <div class="alerta-icon">
                        <i class="bi {% if alerta.severidad == 'critica' %}bi-exclamation-triangle-fill{% elif alerta.severidad == 'alta' %}bi-exclamation-circle-fill{% else %}bi-info-circle-fill{% endif %}"></i>
                    </div>
                    <div class="alerta-content">
                        <h6 class="alerta-title">{{ alerta.tipo|title }}</h6>
                        <p class="alerta-message">{{ alerta.mensaje }}</p>
                        {% if alerta.producto %}
                        <div>
                            <span class="alerta-badge badge-producto">{{ alerta.producto }}</span>
                            {% if alerta.valor_actual %}
                            <span class="alerta-badge badge-valor">Actual: {{ alerta.valor_actual }}</span>
                            {% endif %}
                            {% if alerta.recomendacion %}
                            <span class="alerta-badge badge-recomendacion">üí° {{ alerta.recomendacion }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                {% if analytics.alertas|length > 5 %}
                <div class="text-center mt-3">
                    <button class="btn-expand" onclick="alert('Funcionalidad de ver todas las alertas pr√≥ximamente')">
                        Ver todas las alertas ({{ analytics.alertas|length }})
                    </button>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="alertas-section text-center">
                <div style="padding: 3rem 1rem;">
                    <i class="bi bi-check-circle-fill" style="font-size: 4rem; color: #4a5c3a; opacity: 0.3;"></i>
                    <h5 style="color: #6b7280; margin-top: 1rem;">No hay alertas cr√≠ticas</h5>
                    <p style="color: #9ca3af; font-size: 0.875rem;">Todos los productos tienen m√°rgenes saludables</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Columna Derecha: Top Productos -->
        <div class="col-lg-5">
            <div class="top-productos-card">
                <div class="section-header">
                    <h2 class="section-title" style="font-size: 1.125rem;">
                        <span class="section-icon" style="width: 36px; height: 36px; font-size: 1rem;">
                            <i class="bi bi-trophy-fill"></i>
                        </span>
                        Top 5 Rentables
                    </h2>
                </div>

                {% if analytics.top_rentables %}
                    {% for item in analytics.top_rentables|slice:":5" %}
                    <div class="producto-item">
                        <div class="producto-rank {% if forloop.counter == 1 %}rank-1{% elif forloop.counter == 2 %}rank-2{% elif forloop.counter == 3 %}rank-3{% else %}rank-other{% endif %}">
                            {{ forloop.counter }}
                        </div>
                        <div class="producto-info">
                            <h6 class="producto-nombre">{{ item.producto.nombre }}</h6>
                            <small style="color: #6b7280;">Precio: ${{ item.precio|floatformat:2 }} | Costo: ${{ item.costo|floatformat:2 }}</small>
                        </div>
                        <div class="producto-margen">
                            {{ item.margen|floatformat:1 }}%
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center" style="padding: 2rem 1rem; color: #9ca3af;">
                    <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p style="margin-top: 1rem;">No hay datos disponibles</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

</div>

<script>
function refreshData() {
    location.reload();
}
</script>
{% endblock %}
