{% extends 'gestion/base.html' %}
{% load dietetica_tags %}

{% block title %}Ventas - LINO Saludable{% endblock %}

{% block extra_css %}
<style>
    .ventas-header {
        background: linear-gradient(135deg, var(--lino-success) 0%, var(--lino-olive) 100%);
    }
    
    .venta-card {
        transition: all var(--lino-transition-base);
        border-left: 4px solid var(--lino-success);
    }
    
    .venta-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--lino-shadow-lg);
        border-left-color: var(--lino-olive);
    }
    
    .venta-total {
        font-size: var(--lino-text-lg);
        font-weight: 700;
        color: var(--lino-success);
    }
    
    .venta-fecha {
        color: var(--lino-gray-600);
        font-size: var(--lino-text-sm);
    }
    
    .venta-status {
        position: absolute;
        top: 1rem;
        right: 1rem;
    }
    
    .filtros-ventas {
        background: var(--lino-gray-50);
        border-radius: var(--lino-border-radius-lg);
        padding: var(--lino-spacing-lg);
        margin-bottom: var(--lino-spacing-lg);
    }
    
    .productos-venta {
        max-height: 120px;
        overflow-y: auto;
        border-top: 1px solid var(--lino-gray-200);
        margin-top: var(--lino-spacing-sm);
        padding-top: var(--lino-spacing-sm);
    }
    
    .producto-venta-item {
        display: flex;
        justify-content: space-between;
        padding: var(--lino-spacing-xs) 0;
        font-size: var(--lino-text-sm);
    }
</style>
{% endblock %}

{% block content %}
<!-- Header de ventas -->
<div class="lino-page-header ventas-header">
    <div class="lino-page-header-content">
        <div>
            <h1 class="lino-page-title">Gestión de Ventas</h1>
            <p class="lino-page-subtitle">Control completo de transacciones y facturación</p>
        </div>
        <div class="lino-page-actions">
            <a href="{% url 'crear_venta' %}" class="lino-action-btn lino-action-btn--primary">
                <i class="fas fa-plus"></i>
                Nueva Venta
            </a>
            <button class="lino-action-btn lino-action-btn--success" onclick="exportarVentas()">
                <i class="fas fa-file-excel"></i>
                Exportar
            </button>
            <button class="lino-action-btn lino-action-btn--info" onclick="imprimirReporte()">
                <i class="fas fa-print"></i>
                Reporte
            </button>
        </div>
    </div>
</div>

<div class="lino-container">
    <!-- KPIs de ventas -->
    <div class="lino-grid lino-grid--5-cols" style="margin-bottom: var(--lino-spacing-xl);">
        <div class="lino-kpi-card lino-kpi-card--success">
            <div class="lino-kpi-card-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="lino-kpi-card-content">
                <div class="lino-kpi-card-value">{{ ventas_hoy|default:0 }}</div>
                <div class="lino-kpi-card-label">Ventas Hoy</div>
                {% if crecimiento_hoy %}
                    <div class="lino-kpi-card-trend lino-kpi-card-trend--up">
                        <i class="fas fa-arrow-up"></i> {{ crecimiento_hoy|floatformat:1 }}%
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="lino-kpi-card lino-kpi-card--primary">
            <div class="lino-kpi-card-icon">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="lino-kpi-card-content">
                <div class="lino-kpi-card-value">${{ total_ventas_hoy|floatformat:0|default:0 }}</div>
                <div class="lino-kpi-card-label">Total Hoy</div>
            </div>
        </div>
        
        <div class="lino-kpi-card lino-kpi-card--info">
            <div class="lino-kpi-card-icon">
                <i class="fas fa-calendar-week"></i>
            </div>
            <div class="lino-kpi-card-content">
                <div class="lino-kpi-card-value">${{ total_semana|floatformat:0|default:0 }}</div>
                <div class="lino-kpi-card-label">Esta Semana</div>
            </div>
        </div>
        
        <div class="lino-kpi-card lino-kpi-card--warning">
            <div class="lino-kpi-card-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="lino-kpi-card-content">
                <div class="lino-kpi-card-value">${{ total_mes|floatformat:0|default:0 }}</div>
                <div class="lino-kpi-card-label">Este Mes</div>
            </div>
        </div>
        
        <div class="lino-kpi-card lino-kpi-card--olive">
            <div class="lino-kpi-card-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="lino-kpi-card-content">
                <div class="lino-kpi-card-value">${{ promedio_venta|floatformat:0|default:0 }}</div>
                <div class="lino-kpi-card-label">Promedio</div>
            </div>
        </div>
    </div>

    <!-- Filtros avanzados -->
    <div class="filtros-ventas">
        <form class="lino-form" method="get" id="filtrosVentasForm">
            <div class="lino-grid lino-grid--5-cols">
                <div class="lino-form-group">
                    <label class="lino-form-label">Buscar Venta</label>
                    <div class="lino-input-group">
                        <input type="text" 
                               class="lino-form-input" 
                               name="search" 
                               placeholder="N° venta, cliente..."
                               value="{{ request.GET.search }}">
                        <button type="submit" class="lino-btn lino-btn--primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <div class="lino-form-group">
                    <label class="lino-form-label">Fecha Desde</label>
                    <input type="date" 
                           class="lino-form-input" 
                           name="fecha_desde"
                           value="{{ request.GET.fecha_desde }}">
                </div>
                
                <div class="lino-form-group">
                    <label class="lino-form-label">Fecha Hasta</label>
                    <input type="date" 
                           class="lino-form-input" 
                           name="fecha_hasta"
                           value="{{ request.GET.fecha_hasta }}">
                </div>
                
                <div class="lino-form-group">
                    <label class="lino-form-label">Estado</label>
                    <select class="lino-form-select" name="estado">
                        <option value="">Todos los estados</option>
                        <option value="completada" {% if request.GET.estado == "completada" %}selected{% endif %}>
                            Completada
                        </option>
                        <option value="pendiente" {% if request.GET.estado == "pendiente" %}selected{% endif %}>
                            Pendiente
                        </option>
                        <option value="cancelada" {% if request.GET.estado == "cancelada" %}selected{% endif %}>
                            Cancelada
                        </option>
                    </select>
                </div>
                
                <div class="lino-form-group">
                    <label class="lino-form-label">Vista</label>
                    <div class="lino-btn-group">
                        <button type="button" 
                                class="lino-btn lino-btn--secondary vista-btn" 
                                data-vista="cards"
                                onclick="cambiarVista('cards')">
                            <i class="fas fa-th"></i>
                        </button>
                        <button type="button" 
                                class="lino-btn lino-btn--secondary vista-btn" 
                                data-vista="tabla"
                                onclick="cambiarVista('tabla')">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            {% if request.GET %}
            <div class="lino-form-actions">
                <a href="{% url 'lista_ventas' %}" class="lino-btn lino-btn--secondary">
                    <i class="fas fa-times"></i>
                    Limpiar Filtros
                </a>
                <button type="button" class="lino-btn lino-btn--info" onclick="aplicarFiltrosRapidos()">
                    <i class="fas fa-filter"></i>
                    Filtros Rápidos
                </button>
            </div>
            {% endif %}
        </form>
    </div>

    <!-- Alertas de estado -->
    {% if ventas_pendientes > 0 %}
    <div class="lino-alert lino-alert--warning">
        <div class="lino-alert-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="lino-alert-content">
            <strong>Atención:</strong> Tienes {{ ventas_pendientes }} venta{{ ventas_pendientes|pluralize }} pendiente{{ ventas_pendientes|pluralize }}.
            <a href="?estado=pendiente" class="lino-alert-link">Ver pendientes</a>
        </div>
    </div>
    {% endif %}

    <!-- Vista en Cards -->
    <div id="vista-cards" class="vista-ventas">
        {% if ventas %}
            <div class="lino-grid lino-grid--3-cols">
                {% for venta in ventas %}
                <div class="lino-card venta-card">
                    <!-- Status badge -->
                    <div class="venta-status">
                        {% if venta.estado == 'completada' %}
                            <span class="lino-badge lino-badge--success">Completada</span>
                        {% elif venta.estado == 'pendiente' %}
                            <span class="lino-badge lino-badge--warning">Pendiente</span>
                        {% else %}
                            <span class="lino-badge lino-badge--danger">Cancelada</span>
                        {% endif %}
                    </div>
                    
                    <div class="lino-card-header">
                        <h3 class="lino-card-title">Venta #{{ venta.numero|default:venta.id }}</h3>
                        <div class="lino-card-subtitle venta-fecha">
                            {{ venta.fecha|date:"d/m/Y H:i" }}
                        </div>
                    </div>
                    
                    <div class="lino-card-body">
                        {% if venta.cliente %}
                            <div style="margin-bottom: var(--lino-spacing-sm);">
                                <strong>Cliente:</strong> {{ venta.cliente }}
                            </div>
                        {% endif %}
                        
                        <div class="venta-total">${{ venta.total|floatformat:2 }}</div>
                        
                        <div style="margin: var(--lino-spacing-sm) 0;">
                            <div class="lino-text-sm lino-text-muted">
                                {{ venta.items.count }} producto{{ venta.items.count|pluralize }}
                            </div>
                            {% if venta.metodo_pago %}
                                <div class="lino-text-sm">
                                    <i class="fas fa-credit-card"></i> {{ venta.metodo_pago }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Lista de productos vendidos -->
                        <div class="productos-venta">
                            {% for item in venta.items.all|slice:":5" %}
                            <div class="producto-venta-item">
                                <span>{{ item.producto.nombre }} ({{ item.cantidad }})</span>
                                <span>${{ item.subtotal|floatformat:2 }}</span>
                            </div>
                            {% endfor %}
                            {% if venta.items.count > 5 %}
                            <div class="lino-text-xs lino-text-muted lino-text-center">
                                y {{ venta.items.count|add:"-5" }} producto{{ venta.items.count|add:"-5"|pluralize }} más...
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="lino-card-footer">
                        <div class="lino-btn-group lino-btn-group--full">
                            <a href="{% url 'detalle_venta' venta.id %}" 
                               class="lino-btn lino-btn--primary lino-btn--sm">
                                <i class="fas fa-eye"></i>
                                Ver Detalle
                            </a>
                            <a href="{% url 'factura_venta' venta.id %}" 
                               class="lino-btn lino-btn--success lino-btn--sm">
                                <i class="fas fa-receipt"></i>
                                Factura
                            </a>
                            {% if venta.estado == 'pendiente' %}
                            <button class="lino-btn lino-btn--warning lino-btn--sm"
                                    onclick="completarVenta('{{ venta.id }}')">
                                <i class="fas fa-check"></i>
                                Completar
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="lino-empty-state">
                <div class="lino-empty-state-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h3 class="lino-empty-state-title">No hay ventas registradas</h3>
                <p class="lino-empty-state-text">
                    {% if request.GET %}
                        No se encontraron ventas con los filtros aplicados.
                    {% else %}
                        Comienza registrando tu primera venta.
                    {% endif %}
                </p>
                <div class="lino-empty-state-actions">
                    {% if request.GET %}
                        <a href="{% url 'lista_ventas' %}" class="lino-btn lino-btn--secondary">
                            Ver todas las ventas
                        </a>
                    {% endif %}
                    <a href="{% url 'crear_venta' %}" class="lino-btn lino-btn--primary">
                        <i class="fas fa-plus"></i>
                        Registrar Venta
                    </a>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Vista en Tabla -->
    <div id="vista-tabla" class="vista-ventas" style="display: none;">
        {% if ventas %}
        <div class="lino-table-container">
            <table class="lino-table lino-table--striped lino-table--hover">
                <thead class="lino-table-head">
                    <tr>
                        <th class="lino-table-th lino-table-th--sortable" data-sort="numero">
                            N° Venta
                            <i class="fas fa-sort"></i>
                        </th>
                        <th class="lino-table-th lino-table-th--sortable" data-sort="fecha">
                            Fecha
                            <i class="fas fa-sort"></i>
                        </th>
                        <th class="lino-table-th">Cliente</th>
                        <th class="lino-table-th">Productos</th>
                        <th class="lino-table-th lino-table-th--sortable" data-sort="total">
                            Total
                            <i class="fas fa-sort"></i>
                        </th>
                        <th class="lino-table-th">Estado</th>
                        <th class="lino-table-th lino-table-th--actions">Acciones</th>
                    </tr>
                </thead>
                <tbody class="lino-table-body">
                    {% for venta in ventas %}
                    <tr class="lino-table-row">
                        <td class="lino-table-cell">
                            <strong>#{{ venta.numero|default:venta.id }}</strong>
                        </td>
                        <td class="lino-table-cell">
                            {{ venta.fecha|date:"d/m/Y" }}<br>
                            <span class="lino-text-sm lino-text-muted">{{ venta.fecha|date:"H:i" }}</span>
                        </td>
                        <td class="lino-table-cell">
                            {{ venta.cliente|default:"Cliente general" }}
                        </td>
                        <td class="lino-table-cell">
                            <div class="lino-text-sm">
                                {{ venta.items.count }} producto{{ venta.items.count|pluralize }}
                            </div>
                            <div class="lino-text-xs lino-text-muted">
                                {% for item in venta.items.all|slice:":2" %}
                                    {{ item.producto.nombre }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                                {% if venta.items.count > 2 %}...{% endif %}
                            </div>
                        </td>
                        <td class="lino-table-cell">
                            <strong class="venta-total">${{ venta.total|floatformat:2 }}</strong>
                        </td>
                        <td class="lino-table-cell">
                            {% if venta.estado == 'completada' %}
                                <span class="lino-badge lino-badge--success">Completada</span>
                            {% elif venta.estado == 'pendiente' %}
                                <span class="lino-badge lino-badge--warning">Pendiente</span>
                            {% else %}
                                <span class="lino-badge lino-badge--danger">Cancelada</span>
                            {% endif %}
                        </td>
                        <td class="lino-table-cell lino-table-cell--actions">
                            <div class="lino-table-actions">
                                <a href="{% url 'detalle_venta' venta.id %}" 
                                   class="lino-btn lino-btn--sm lino-btn--secondary"
                                   title="Ver detalle">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'factura_venta' venta.id %}" 
                                   class="lino-btn lino-btn--sm lino-btn--success"
                                   title="Imprimir factura">
                                    <i class="fas fa-receipt"></i>
                                </a>
                                {% if venta.estado == 'pendiente' %}
                                <button class="lino-btn lino-btn--sm lino-btn--primary"
                                        title="Completar venta"
                                        onclick="completarVenta('{{ venta.id }}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                {% endif %}
                                <button class="lino-btn lino-btn--sm lino-btn--danger"
                                        title="Cancelar venta"
                                        onclick="cancelarVenta('{{ venta.id }}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- Paginación -->
    {% if is_paginated %}
    <div class="lino-pagination-container">
        <nav class="lino-pagination" aria-label="Paginación de ventas">
            {% if page_obj.has_previous %}
                <a href="?{% url_replace request 'page' 1 %}" 
                   class="lino-pagination-btn lino-pagination-btn--first">
                    <i class="fas fa-angle-double-left"></i>
                </a>
                <a href="?{% url_replace request 'page' page_obj.previous_page_number %}" 
                   class="lino-pagination-btn lino-pagination-btn--prev">
                    <i class="fas fa-angle-left"></i>
                </a>
            {% endif %}

            <div class="lino-pagination-info">
                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                ({{ page_obj.paginator.count }} ventas)
            </div>

            {% if page_obj.has_next %}
                <a href="?{% url_replace request 'page' page_obj.next_page_number %}" 
                   class="lino-pagination-btn lino-pagination-btn--next">
                    <i class="fas fa-angle-right"></i>
                </a>
                <a href="?{% url_replace request 'page' page_obj.paginator.num_pages %}" 
                   class="lino-pagination-btn lino-pagination-btn--last">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cambio de vista
    window.cambiarVista = function(vista) {
        const cards = document.getElementById('vista-cards');
        const tabla = document.getElementById('vista-tabla');
        const botones = document.querySelectorAll('.vista-btn');
        
        botones.forEach(btn => {
            btn.classList.remove('lino-btn--primary');
            btn.classList.add('lino-btn--secondary');
        });
        
        if (vista === 'cards') {
            cards.style.display = 'block';
            tabla.style.display = 'none';
            document.querySelector('[data-vista="cards"]').classList.add('lino-btn--primary');
            document.querySelector('[data-vista="cards"]').classList.remove('lino-btn--secondary');
            localStorage.setItem('ventas_vista', 'cards');
        } else {
            cards.style.display = 'none';
            tabla.style.display = 'block';
            document.querySelector('[data-vista="tabla"]').classList.add('lino-btn--primary');
            document.querySelector('[data-vista="tabla"]').classList.remove('lino-btn--secondary');
            localStorage.setItem('ventas_vista', 'tabla');
        }
    };
    
    // Restaurar vista guardada
    const vistaGuardada = localStorage.getItem('ventas_vista') || 'cards';
    cambiarVista(vistaGuardada);
    
    // Filtros automáticos
    const filtros = document.querySelectorAll('input[type="date"], select[name]');
    filtros.forEach(filtro => {
        filtro.addEventListener('change', function() {
            document.getElementById('filtrosVentasForm').submit();
        });
    });
    
    // Funciones de acción
    window.completarVenta = function(ventaId) {
        if (confirm('¿Confirmar completar esta venta?')) {
            fetch(`/ventas/${ventaId}/completar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            }).then(() => {
                location.reload();
            });
        }
    };
    
    window.cancelarVenta = function(ventaId) {
        if (confirm('¿Estás seguro de cancelar esta venta?')) {
            fetch(`/ventas/${ventaId}/cancelar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            }).then(() => {
                location.reload();
            });
        }
    };
    
    window.exportarVentas = function() {
        const params = new URLSearchParams(window.location.search);
        params.set('export', 'excel');
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    };
    
    window.imprimirReporte = function() {
        window.open('/ventas/reporte/', '_blank');
    };
    
    window.aplicarFiltrosRapidos = function() {
        const today = new Date().toISOString().split('T')[0];
        document.querySelector('input[name="fecha_desde"]').value = today;
        document.querySelector('input[name="fecha_hasta"]').value = today;
        document.getElementById('filtrosVentasForm').submit();
    };
});
</script>
{% endblock %}
