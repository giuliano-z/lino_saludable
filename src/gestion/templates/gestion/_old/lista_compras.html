{% extends 'gestion/base.html' %}
{% load dietetica_tags %}

{% block title %}Compras - LINO Saludable{% endblock %}

{% block extra_css %}
<style>
    .compras-header {
        background: linear-gradient(135deg, var(--lino-info) 0%, var(--lino-primary) 100%);
    }
    
    .compra-card {
        transition: all var(--lino-transition-base);
        border-left: 4px solid var(--lino-info);
    }
    
    .compra-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--lino-shadow-lg);
        border-left-color: var(--lino-primary);
    }
    
    .compra-total {
        font-size: var(--lino-text-lg);
        font-weight: 700;
        color: var(--lino-info);
    }
    
    .compra-proveedor {
        color: var(--lino-gray-700);
        font-weight: 600;
    }
    
    .compra-status {
        position: absolute;
        top: 1rem;
        right: 1rem;
    }
    
    .filtros-compras {
        background: var(--lino-gray-50);
        border-radius: var(--lino-border-radius-lg);
        padding: var(--lino-spacing-lg);
        margin-bottom: var(--lino-spacing-lg);
    }
    
    .materias-compra {
        max-height: 120px;
        overflow-y: auto;
        border-top: 1px solid var(--lino-gray-200);
        margin-top: var(--lino-spacing-sm);
        padding-top: var(--lino-spacing-sm);
    }
    
    .materia-compra-item {
        display: flex;
        justify-content: space-between;
        padding: var(--lino-spacing-xs) 0;
        font-size: var(--lino-text-sm);
    }
    
    .orden-compra {
        background: var(--lino-primary-50);
        border: 1px solid var(--lino-primary-200);
        border-radius: var(--lino-border-radius-base);
        padding: var(--lino-spacing-sm);
        margin-top: var(--lino-spacing-sm);
        font-size: var(--lino-text-sm);
    }
</style>
{% endblock %}

{% block content %}
<!-- Header de compras -->
<div class="lino-page-header compras-header">
    <div class="lino-page-header-content">
        <div>
            <h1 class="lino-page-title">Gestión de Compras</h1>
            <p class="lino-page-subtitle">Control de adquisiciones y proveedores</p>
        </div>
        <div class="lino-page-actions">
            <a href="{% url 'crear_compra' %}" class="lino-action-btn lino-action-btn--primary">
                <i class="fas fa-plus"></i>
                Nueva Compra
            </a>
            <button class="lino-action-btn lino-action-btn--info" onclick="generarOrdenCompra()">
                <i class="fas fa-file-alt"></i>
                Orden de Compra
            </button>
            <button class="lino-action-btn lino-action-btn--secondary" onclick="exportarCompras()">
                <i class="fas fa-download"></i>
                Exportar
            </button>
        </div>
    </div>
</div>

<div class="lino-container">
    <!-- KPIs de compras -->
    <div class="lino-grid lino-grid--5-cols" style="margin-bottom: var(--lino-spacing-xl);">
        <div class="lino-kpi-card lino-kpi-card--info">
            <div class="lino-kpi-card-icon">
                <i class="fas fa-truck"></i>
            </div>
            <div class="lino-kpi-card-content">
                <div class="lino-kpi-card-value">{{ compras_mes|default:0 }}</div>
                <div class="lino-kpi-card-label">Compras Mes</div>
            </div>
        </div>
        
        <div class="lino-kpi-card lino-kpi-card--primary">
            <div class="lino-kpi-card-icon">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="lino-kpi-card-content">
                <div class="lino-kpi-card-value">${{ total_compras_mes|floatformat:0|default:0 }}</div>
                <div class="lino-kpi-card-label">Total Mes</div>
            </div>
        </div>
        
        <div class="lino-kpi-card lino-kpi-card--warning">
            <div class="lino-kpi-card-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="lino-kpi-card-content">
                <div class="lino-kpi-card-value">{{ compras_pendientes|default:0 }}</div>
                <div class="lino-kpi-card-label">Pendientes</div>
            </div>
        </div>
        
        <div class="lino-kpi-card lino-kpi-card--success">
            <div class="lino-kpi-card-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="lino-kpi-card-content">
                <div class="lino-kpi-card-value">{{ proveedores_activos|default:0 }}</div>
                <div class="lino-kpi-card-label">Proveedores</div>
            </div>
        </div>
        
        <div class="lino-kpi-card lino-kpi-card--olive">
            <div class="lino-kpi-card-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div class="lino-kpi-card-content">
                <div class="lino-kpi-card-value">${{ promedio_compra|floatformat:0|default:0 }}</div>
                <div class="lino-kpi-card-label">Promedio</div>
            </div>
        </div>
    </div>

    <!-- Filtros avanzados -->
    <div class="filtros-compras">
        <form class="lino-form" method="get" id="filtrosComprasForm">
            <div class="lino-grid lino-grid--5-cols">
                <div class="lino-form-group">
                    <label class="lino-form-label">Buscar Compra</label>
                    <div class="lino-input-group">
                        <input type="text" 
                               class="lino-form-input" 
                               name="search" 
                               placeholder="N° compra, proveedor..."
                               value="{{ request.GET.search }}">
                        <button type="submit" class="lino-btn lino-btn--primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <div class="lino-form-group">
                    <label class="lino-form-label">Proveedor</label>
                    <select class="lino-form-select" name="proveedor">
                        <option value="">Todos los proveedores</option>
                        {% for proveedor in proveedores %}
                            <option value="{{ proveedor.id }}" 
                                    {% if request.GET.proveedor == proveedor.id|stringformat:"s" %}selected{% endif %}>
                                {{ proveedor.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="lino-form-group">
                    <label class="lino-form-label">Fecha Desde</label>
                    <input type="date" 
                           class="lino-form-input" 
                           name="fecha_desde"
                           value="{{ request.GET.fecha_desde }}">
                </div>
                
                <div class="lino-form-group">
                    <label class="lino-form-label">Estado</label>
                    <select class="lino-form-select" name="estado">
                        <option value="">Todos los estados</option>
                        <option value="recibida" {% if request.GET.estado == "recibida" %}selected{% endif %}>
                            Recibida
                        </option>
                        <option value="pendiente" {% if request.GET.estado == "pendiente" %}selected{% endif %}>
                            Pendiente
                        </option>
                        <option value="parcial" {% if request.GET.estado == "parcial" %}selected{% endif %}>
                            Parcial
                        </option>
                        <option value="cancelada" {% if request.GET.estado == "cancelada" %}selected{% endif %}>
                            Cancelada
                        </option>
                    </select>
                </div>
                
                <div class="lino-form-group">
                    <label class="lino-form-label">Vista</label>
                    <div class="lino-btn-group">
                        <button type="button" 
                                class="lino-btn lino-btn--secondary vista-btn" 
                                data-vista="cards"
                                onclick="cambiarVista('cards')">
                            <i class="fas fa-th"></i>
                        </button>
                        <button type="button" 
                                class="lino-btn lino-btn--secondary vista-btn" 
                                data-vista="tabla"
                                onclick="cambiarVista('tabla')">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            {% if request.GET %}
            <div class="lino-form-actions">
                <a href="{% url 'lista_compras' %}" class="lino-btn lino-btn--secondary">
                    <i class="fas fa-times"></i>
                    Limpiar Filtros
                </a>
                <button type="button" class="lino-btn lino-btn--info" onclick="filtroStockBajo()">
                    <i class="fas fa-exclamation-triangle"></i>
                    Necesarias para Stock
                </button>
            </div>
            {% endif %}
        </form>
    </div>

    <!-- Alertas importantes -->
    {% if materias_stock_bajo > 0 %}
    <div class="lino-alert lino-alert--warning">
        <div class="lino-alert-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="lino-alert-content">
            <strong>Stock Bajo:</strong> {{ materias_stock_bajo }} materia{{ materias_stock_bajo|pluralize }} prima{{ materias_stock_bajo|pluralize }} con stock bajo necesitan reposición.
            <a href="{% url 'generar_orden_compra_automatica' %}" class="lino-alert-link">Generar orden automática</a>
        </div>
    </div>
    {% endif %}

    <!-- Vista en Cards -->
    <div id="vista-cards" class="vista-compras">
        {% if compras %}
            <div class="lino-grid lino-grid--3-cols">
                {% for compra in compras %}
                <div class="lino-card compra-card">
                    <!-- Status badge -->
                    <div class="compra-status">
                        {% if compra.estado == 'recibida' %}
                            <span class="lino-badge lino-badge--success">Recibida</span>
                        {% elif compra.estado == 'pendiente' %}
                            <span class="lino-badge lino-badge--warning">Pendiente</span>
                        {% elif compra.estado == 'parcial' %}
                            <span class="lino-badge lino-badge--info">Parcial</span>
                        {% else %}
                            <span class="lino-badge lino-badge--danger">Cancelada</span>
                        {% endif %}
                    </div>
                    
                    <div class="lino-card-header">
                        <h3 class="lino-card-title">Compra #{{ compra.numero|default:compra.id }}</h3>
                        <div class="lino-card-subtitle">{{ compra.fecha|date:"d/m/Y" }}</div>
                    </div>
                    
                    <div class="lino-card-body">
                        <div class="compra-proveedor" style="margin-bottom: var(--lino-spacing-sm);">
                            <i class="fas fa-user"></i> {{ compra.proveedor.nombre|default:"Proveedor General" }}
                        </div>
                        
                        <div class="compra-total">${{ compra.total|floatformat:2 }}</div>
                        
                        <div style="margin: var(--lino-spacing-sm) 0;">
                            <div class="lino-text-sm lino-text-muted">
                                {{ compra.items.count }} materia{{ compra.items.count|pluralize }} prima{{ compra.items.count|pluralize }}
                            </div>
                            {% if compra.fecha_entrega %}
                                <div class="lino-text-sm">
                                    <i class="fas fa-calendar"></i> Entrega: {{ compra.fecha_entrega|date:"d/m/Y" }}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Lista de materias primas -->
                        <div class="materias-compra">
                            {% for item in compra.items.all|slice:":5" %}
                            <div class="materia-compra-item">
                                <span>{{ item.materia_prima.nombre }} ({{ item.cantidad }} {{ item.materia_prima.unidad_medida }})</span>
                                <span>${{ item.subtotal|floatformat:2 }}</span>
                            </div>
                            {% endfor %}
                            {% if compra.items.count > 5 %}
                            <div class="lino-text-xs lino-text-muted lino-text-center">
                                y {{ compra.items.count|add:"-5" }} producto{{ compra.items.count|add:"-5"|pluralize }} más...
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Información de orden de compra -->
                        {% if compra.orden_compra %}
                        <div class="orden-compra">
                            <i class="fas fa-file-alt"></i> 
                            Orden: #{{ compra.orden_compra }}
                            {% if compra.fecha_orden %}
                                - {{ compra.fecha_orden|date:"d/m" }}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="lino-card-footer">
                        <div class="lino-btn-group lino-btn-group--full">
                            <a href="{% url 'detalle_compra' compra.id %}" 
                               class="lino-btn lino-btn--primary lino-btn--sm">
                                <i class="fas fa-eye"></i>
                                Ver Detalle
                            </a>
                            {% if compra.estado == 'pendiente' %}
                            <button class="lino-btn lino-btn--success lino-btn--sm"
                                    onclick="recibirCompra('{{ compra.id }}')">
                                <i class="fas fa-check"></i>
                                Recibir
                            </button>
                            {% endif %}
                            <a href="{% url 'orden_compra_pdf' compra.id %}" 
                               class="lino-btn lino-btn--info lino-btn--sm">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="lino-empty-state">
                <div class="lino-empty-state-icon">
                    <i class="fas fa-truck"></i>
                </div>
                <h3 class="lino-empty-state-title">No hay compras registradas</h3>
                <p class="lino-empty-state-text">
                    {% if request.GET %}
                        No se encontraron compras con los filtros aplicados.
                    {% else %}
                        Comienza registrando tu primera compra de materias primas.
                    {% endif %}
                </p>
                <div class="lino-empty-state-actions">
                    {% if request.GET %}
                        <a href="{% url 'lista_compras' %}" class="lino-btn lino-btn--secondary">
                            Ver todas las compras
                        </a>
                    {% endif %}
                    <a href="{% url 'crear_compra' %}" class="lino-btn lino-btn--primary">
                        <i class="fas fa-plus"></i>
                        Registrar Compra
                    </a>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Vista en Tabla -->
    <div id="vista-tabla" class="vista-compras" style="display: none;">
        {% if compras %}
        <div class="lino-table-container">
            <table class="lino-table lino-table--striped lino-table--hover">
                <thead class="lino-table-head">
                    <tr>
                        <th class="lino-table-th lino-table-th--sortable" data-sort="numero">
                            N° Compra
                            <i class="fas fa-sort"></i>
                        </th>
                        <th class="lino-table-th lino-table-th--sortable" data-sort="fecha">
                            Fecha
                            <i class="fas fa-sort"></i>
                        </th>
                        <th class="lino-table-th">Proveedor</th>
                        <th class="lino-table-th">Materias Primas</th>
                        <th class="lino-table-th lino-table-th--sortable" data-sort="total">
                            Total
                            <i class="fas fa-sort"></i>
                        </th>
                        <th class="lino-table-th">Estado</th>
                        <th class="lino-table-th">Entrega</th>
                        <th class="lino-table-th lino-table-th--actions">Acciones</th>
                    </tr>
                </thead>
                <tbody class="lino-table-body">
                    {% for compra in compras %}
                    <tr class="lino-table-row">
                        <td class="lino-table-cell">
                            <strong>#{{ compra.numero|default:compra.id }}</strong>
                            {% if compra.orden_compra %}
                                <div class="lino-text-xs lino-text-muted">OC: {{ compra.orden_compra }}</div>
                            {% endif %}
                        </td>
                        <td class="lino-table-cell">
                            {{ compra.fecha|date:"d/m/Y" }}<br>
                            <span class="lino-text-sm lino-text-muted">{{ compra.fecha|date:"H:i" }}</span>
                        </td>
                        <td class="lino-table-cell">
                            <strong>{{ compra.proveedor.nombre|default:"Proveedor General" }}</strong>
                            {% if compra.proveedor.telefono %}
                                <div class="lino-text-xs lino-text-muted">{{ compra.proveedor.telefono }}</div>
                            {% endif %}
                        </td>
                        <td class="lino-table-cell">
                            <div class="lino-text-sm">
                                {{ compra.items.count }} materia{{ compra.items.count|pluralize }} prima{{ compra.items.count|pluralize }}
                            </div>
                            <div class="lino-text-xs lino-text-muted">
                                {% for item in compra.items.all|slice:":2" %}
                                    {{ item.materia_prima.nombre }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                                {% if compra.items.count > 2 %}...{% endif %}
                            </div>
                        </td>
                        <td class="lino-table-cell">
                            <strong class="compra-total">${{ compra.total|floatformat:2 }}</strong>
                        </td>
                        <td class="lino-table-cell">
                            {% if compra.estado == 'recibida' %}
                                <span class="lino-badge lino-badge--success">Recibida</span>
                            {% elif compra.estado == 'pendiente' %}
                                <span class="lino-badge lino-badge--warning">Pendiente</span>
                            {% elif compra.estado == 'parcial' %}
                                <span class="lino-badge lino-badge--info">Parcial</span>
                            {% else %}
                                <span class="lino-badge lino-badge--danger">Cancelada</span>
                            {% endif %}
                        </td>
                        <td class="lino-table-cell">
                            {% if compra.fecha_entrega %}
                                {{ compra.fecha_entrega|date:"d/m/Y" }}
                            {% else %}
                                <span class="lino-text-muted">No definida</span>
                            {% endif %}
                        </td>
                        <td class="lino-table-cell lino-table-cell--actions">
                            <div class="lino-table-actions">
                                <a href="{% url 'detalle_compra' compra.id %}" 
                                   class="lino-btn lino-btn--sm lino-btn--secondary"
                                   title="Ver detalle">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if compra.estado == 'pendiente' %}
                                <button class="lino-btn lino-btn--sm lino-btn--success"
                                        title="Recibir compra"
                                        onclick="recibirCompra('{{ compra.id }}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                {% endif %}
                                <a href="{% url 'orden_compra_pdf' compra.id %}" 
                                   class="lino-btn lino-btn--sm lino-btn--info"
                                   title="Generar PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                                <button class="lino-btn lino-btn--sm lino-btn--danger"
                                        title="Cancelar compra"
                                        onclick="cancelarCompra('{{ compra.id }}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>

    <!-- Paginación -->
    {% if is_paginated %}
    <div class="lino-pagination-container">
        <nav class="lino-pagination" aria-label="Paginación de compras">
            {% if page_obj.has_previous %}
                <a href="?{% url_replace request 'page' 1 %}" 
                   class="lino-pagination-btn lino-pagination-btn--first">
                    <i class="fas fa-angle-double-left"></i>
                </a>
                <a href="?{% url_replace request 'page' page_obj.previous_page_number %}" 
                   class="lino-pagination-btn lino-pagination-btn--prev">
                    <i class="fas fa-angle-left"></i>
                </a>
            {% endif %}

            <div class="lino-pagination-info">
                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                ({{ page_obj.paginator.count }} compras)
            </div>

            {% if page_obj.has_next %}
                <a href="?{% url_replace request 'page' page_obj.next_page_number %}" 
                   class="lino-pagination-btn lino-pagination-btn--next">
                    <i class="fas fa-angle-right"></i>
                </a>
                <a href="?{% url_replace request 'page' page_obj.paginator.num_pages %}" 
                   class="lino-pagination-btn lino-pagination-btn--last">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cambio de vista
    window.cambiarVista = function(vista) {
        const cards = document.getElementById('vista-cards');
        const tabla = document.getElementById('vista-tabla');
        const botones = document.querySelectorAll('.vista-btn');
        
        botones.forEach(btn => {
            btn.classList.remove('lino-btn--primary');
            btn.classList.add('lino-btn--secondary');
        });
        
        if (vista === 'cards') {
            cards.style.display = 'block';
            tabla.style.display = 'none';
            document.querySelector('[data-vista="cards"]').classList.add('lino-btn--primary');
            document.querySelector('[data-vista="cards"]').classList.remove('lino-btn--secondary');
            localStorage.setItem('compras_vista', 'cards');
        } else {
            cards.style.display = 'none';
            tabla.style.display = 'block';
            document.querySelector('[data-vista="tabla"]').classList.add('lino-btn--primary');
            document.querySelector('[data-vista="tabla"]').classList.remove('lino-btn--secondary');
            localStorage.setItem('compras_vista', 'tabla');
        }
    };
    
    // Restaurar vista guardada
    const vistaGuardada = localStorage.getItem('compras_vista') || 'cards';
    cambiarVista(vistaGuardada);
    
    // Filtros automáticos
    const filtros = document.querySelectorAll('select[name], input[type="date"]');
    filtros.forEach(filtro => {
        filtro.addEventListener('change', function() {
            document.getElementById('filtrosComprasForm').submit();
        });
    });
    
    // Funciones de acción
    window.recibirCompra = function(compraId) {
        if (confirm('¿Confirmar recepción de esta compra?')) {
            fetch(`/compras/${compraId}/recibir/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            }).then(() => {
                location.reload();
            });
        }
    };
    
    window.cancelarCompra = function(compraId) {
        if (confirm('¿Estás seguro de cancelar esta compra?')) {
            fetch(`/compras/${compraId}/cancelar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            }).then(() => {
                location.reload();
            });
        }
    };
    
    window.exportarCompras = function() {
        const params = new URLSearchParams(window.location.search);
        params.set('export', 'excel');
        window.location.href = `${window.location.pathname}?${params.toString()}`;
    };
    
    window.generarOrdenCompra = function() {
        window.open('/compras/generar-orden/', '_blank');
    };
    
    window.filtroStockBajo = function() {
        window.location.href = '/compras/?stock_bajo=1';
    };
});
</script>
{% endblock %}
