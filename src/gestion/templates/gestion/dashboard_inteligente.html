{% extends 'gestion/base.html' %}
{% load static %}

{% block title %}Dashboard LINO Diet√©tica{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/lino-hero-section.css' %}?v=20241104">
{% endblock %}

{% block header %}üåø Dashboard Principal - LINO{% endblock %}

{% block content %}

<!-- ÔøΩ HERO SECTION DIN√ÅMICO - LINO V3 -->
<div class="lino-hero-section mb-4">
    <div class="row align-items-center">
        <!-- Columna Izquierda: Saludo Personalizado -->
        <div class="col-lg-8">
            <div class="lino-hero-greeting">
                {% load tz %}
                {% now "H" as current_hour %}
                {% if current_hour|add:"0" < 12 %}
                    <h1 class="lino-hero-greeting__title">‚òÄÔ∏è ¬°Buenos d√≠as, {% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}!</h1>
                {% elif current_hour|add:"0" < 18 %}
                    <h1 class="lino-hero-greeting__title">üå§Ô∏è ¬°Buenas tardes, {% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}!</h1>
                {% else %}
                    <h1 class="lino-hero-greeting__title">üåô ¬°Buenas noches, {% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}!</h1>
                {% endif %}
                <p class="lino-hero-greeting__subtitle">
                    <i class="bi bi-calendar3 me-2"></i>
                    {% now "l, j \d\e F \d\e Y" %}
                </p>
            </div>

            <!-- Resumen del D√≠a -->
            <div class="row g-3 mt-2">
                <div class="col-md-4">
                    <div class="lino-hero-stat">
                        <div class="lino-hero-stat__label">üí∞ Ventas Hoy</div>
                        <div class="lino-hero-stat__value">
                            ${{ resumen_hoy.total_ventas|floatformat:0|default:"0" }}
                        </div>
                        {% if resumen_hoy.variacion > 0 %}
                            <div class="lino-hero-stat__trend lino-hero-stat__trend--up">
                                <i class="bi bi-arrow-up"></i> +{{ resumen_hoy.variacion|floatformat:1 }}%
                            </div>
                        {% elif resumen_hoy.variacion < 0 %}
                            <div class="lino-hero-stat__trend lino-hero-stat__trend--down">
                                <i class="bi bi-arrow-down"></i> {{ resumen_hoy.variacion|floatformat:1 }}%
                            </div>
                        {% else %}
                            <div class="lino-hero-stat__trend lino-hero-stat__trend--neutral">
                                <i class="bi bi-dash"></i> Sin cambios
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="lino-hero-stat">
                        <div class="lino-hero-stat__label">üìã Transacciones</div>
                        <div class="lino-hero-stat__value">
                            {{ resumen_hoy.cantidad_ventas|default:"0" }}
                        </div>
                        <div class="lino-hero-stat__subtitle">
                            operaciones hoy
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="lino-hero-stat">
                        <div class="lino-hero-stat__label">üì¶ Productos Vendidos</div>
                        <div class="lino-hero-stat__value">
                            {{ resumen_hoy.productos_vendidos|default:"0" }}
                        </div>
                        <div class="lino-hero-stat__subtitle">
                            unidades
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: B√∫squeda R√°pida -->
        <div class="col-lg-4">
            <div class="lino-quick-search-card">
                <div class="lino-quick-search-card__header">
                    <i class="bi bi-search me-2"></i>
                    <span>B√∫squeda R√°pida</span>
                </div>
                <div class="lino-quick-search-card__body">
                    <form action="{% url 'gestion:lista_productos' %}" method="get" class="mb-3">
                        <div class="input-group">
                            <input type="text" name="q" class="form-control" 
                                   placeholder="üîç Buscar producto..." autocomplete="off">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </form>
                    <div class="lino-quick-filters">
                        <a href="{% url 'gestion:lista_productos' %}?categoria=organicos" class="lino-quick-filter">
                            üå± Org√°nicos
                        </a>
                        <a href="{% url 'gestion:lista_productos' %}?categoria=sin_tacc" class="lino-quick-filter">
                            üö´ Sin TACC
                        </a>
                        <a href="{% url 'gestion:lista_productos' %}?categoria=cereales" class="lino-quick-filter">
                            üåæ Cereales
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- üåü M√âTRICAS PRINCIPALES - LINO V3 -->
<div class="row g-4 mb-5">
    <!-- üí∞ VENTAS DEL MES -->
    <div class="col-xl-3 col-lg-6 col-md-6">
        <div class="lino-metric-spectacular lino-metric-spectacular--success">
            <div class="lino-metric-spectacular__header">
                <div class="lino-metric-spectacular__icon">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <span class="lino-metric-spectacular__badge">Este Mes</span>
            </div>
            <div class="lino-metric-spectacular__body">
                <h3 class="lino-metric-spectacular__label">üí∞ Ventas Totales</h3>
                <div class="lino-metric-spectacular__value">${{ kpis.ventas_mes.total|floatformat:0|default:"0" }}</div>
                {% if kpis.ventas_mes.variacion > 0 %}
                    <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--success">
                        <i class="bi bi-arrow-up"></i>
                        <span>+{{ kpis.ventas_mes.variacion|floatformat:1 }}% vs mes anterior</span>
                    </div>
                {% elif kpis.ventas_mes.variacion < 0 %}
                    <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--danger">
                        <i class="bi bi-arrow-down"></i>
                        <span>{{ kpis.ventas_mes.variacion|floatformat:1 }}% vs mes anterior</span>
                    </div>
                {% else %}
                    <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--neutral">
                        <i class="bi bi-dash"></i>
                        <span>Sin cambios</span>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- üå± PRODUCTOS ACTIVOS -->
    <div class="col-xl-3 col-lg-6 col-md-6">
        <div class="lino-metric-spectacular lino-metric-spectacular--primary">
            <div class="lino-metric-spectacular__header">
                <div class="lino-metric-spectacular__icon">
                    <i class="bi bi-basket3"></i>
                </div>
                <span class="lino-metric-spectacular__badge">Cat√°logo</span>
            </div>
            <div class="lino-metric-spectacular__body">
                <h3 class="lino-metric-spectacular__label">üå± Productos Activos</h3>
                <div class="lino-metric-spectacular__value">{{ kpis.productos.total|default:"0" }}</div>
                {% if kpis.productos.bajo_stock > 0 %}
                    <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span>{{ kpis.productos.bajo_stock }} bajo stock</span>
                    </div>
                {% else %}
                    <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--success">
                        <i class="bi bi-check-circle"></i>
                        <span>Stock saludable</span>
                    </div>
                {% endif %}
                <a href="{% url 'gestion:lista_productos' %}" class="btn btn-sm btn-outline-primary mt-3 w-100">
                    <i class="bi bi-arrow-right-circle me-1"></i> Ver productos
                </a>
            </div>
        </div>
    </div>

    <!-- üíé VALOR INVENTARIO -->
    <div class="col-xl-3 col-lg-6 col-md-6">
        <div class="lino-metric-spectacular lino-metric-spectacular--info">
            <div class="lino-metric-spectacular__header">
                <div class="lino-metric-spectacular__icon">
                    <i class="bi bi-gem"></i>
                </div>
                <span class="lino-metric-spectacular__badge">Patrimonio</span>
            </div>
            <div class="lino-metric-spectacular__body">
                <h3 class="lino-metric-spectacular__label">üíé Valor Inventario</h3>
                <div class="lino-metric-spectacular__value">${{ kpis.inventario.valor|floatformat:0|default:"0" }}</div>
                <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--neutral">
                    <i class="bi bi-graph-up"></i>
                    <span>ROI: {{ kpis.inventario.roi|floatformat:1 }}%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- üîî ALERTAS CR√çTICAS -->
    <div class="col-xl-3 col-lg-6 col-md-6">
        <div class="lino-metric-spectacular lino-metric-spectacular--danger">
            <div class="lino-metric-spectacular__header">
                <div class="lino-metric-spectacular__icon">
                    <i class="bi bi-bell-fill"></i>
                </div>
                <span class="lino-metric-spectacular__badge">Notificaciones</span>
            </div>
            <div class="lino-metric-spectacular__body">
                <h3 class="lino-metric-spectacular__label">üîî Alertas Cr√≠ticas</h3>
                <div class="lino-metric-spectacular__value">{{ alertas_criticas|default:"0" }}</div>
                {% if alertas_criticas > 0 %}
                    <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--danger">
                        <i class="bi bi-exclamation-circle"></i>
                        <span>Requieren atenci√≥n</span>
                    </div>
                {% else %}
                    <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--success">
                        <i class="bi bi-check-circle"></i>
                        <span>Todo bajo control</span>
                    </div>
                {% endif %}
                <a href="#alertas-section" class="btn btn-sm btn-outline-danger mt-3 w-100">
                    <i class="bi bi-arrow-right-circle me-1"></i> Ver alertas
                </a>
            </div>
        </div>
    </div>
</div>

<!-- üìä PANEL DE CONTROL PRINCIPAL -->
<div class="row g-3">
    <div class="col-lg-8">
        <!-- ACCIONES R√ÅPIDAS PRINCIPALES -->
        <div class="lino-chart-container mb-3">
            <div class="lino-chart-header">
                <h5 class="lino-chart-title mb-0">
                    <i class="bi bi-lightning me-2"></i>
                    Acciones R√°pidas
                </h5>
            </div>
            <div class="lino-chart-body p-3">
                <div class="row g-2">
                    <div class="col-md-4">
                        <a href="/gestion/ventas/crear/" class="lino-btn lino-btn-success w-100">
                            <i class="bi bi-plus-circle me-2"></i>Nueva Venta
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="/gestion/compras/crear/" class="lino-btn lino-btn-secondary w-100">
                            <i class="bi bi-truck me-2"></i>Nueva Compra
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="/gestion/productos/crear/" class="lino-btn lino-btn-warning w-100">
                            <i class="bi bi-box me-2"></i>Nuevo Producto
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESUMEN SEMANAL -->
        <div class="lino-chart-container">
            <div class="lino-chart-header">
                <h5 class="lino-chart-title">
                    <i class="bi bi-graph-up me-2"></i>
                    Resumen de la Semana
                </h5>
                <!-- üìä CONTROLES DE GR√ÅFICO -->
                <div class="lino-chart-controls">
                    <button class="lino-chart-btn lino-chart-btn--active" data-chart="ventas" onclick="changeChart('ventas')">
                        <i class="bi bi-bar-chart"></i>
                        Ventas
                    </button>
                    <button class="lino-chart-btn" data-chart="productos" onclick="changeChart('productos')">
                        <i class="bi bi-pie-chart"></i>
                        Productos
                    </button>
                    <button class="lino-chart-btn" data-chart="tendencias" onclick="changeChart('tendencias')">
                        <i class="bi bi-graph-up-arrow"></i>
                        Tendencias
                    </button>
                </div>
            </div>
            <div class="lino-chart-body p-3">
                <!-- üìà √ÅREA DEL GR√ÅFICO -->
                <div id="chart-container" style="min-height: 250px; position: relative;">
                    <canvas id="dashboard-chart" style="max-height: 250px;"></canvas>
                </div>
                
                <!-- üìä M√âTRICAS RESUMIDAS -->
                <div class="row text-center mt-4">
                    <div class="col-md-3">
                        <div class="metric-item">
                            <div class="metric-value text-success">${{ ventas_semana|floatformat:0|default:"0" }}</div>
                            <div class="metric-label">Ventas Semana</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-item">
                            <div class="metric-value text-info">{{ productos_vendidos_semana|default:"0" }}</div>
                            <div class="metric-label">Productos Vendidos</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-item">
                            <div class="metric-value text-warning">{{ margen_semana|default:"0" }}%</div>
                            <div class="metric-label">Margen Promedio</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-item">
                            <div class="metric-value text-primary">{{ clientes_semana|default:"0" }}</div>
                            <div class="metric-label">Clientes √önicos</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PANEL LATERAL -->
    <div class="col-lg-4">
        <!-- ACTIVIDAD RECIENTE -->
        <div class="lino-sidebar-card mb-3">
            <div class="lino-sidebar-card__header">
                <h6 class="mb-0 fw-bold d-flex align-items-center">
                    <i class="bi bi-clock-history me-2"></i>
                    Actividad Reciente
                </h6>
            </div>
            <div class="lino-sidebar-card__body">
                {% if ventas_recientes %}
                    <div class="recent-activity">
                        {% for venta in ventas_recientes %}
                        <div class="activity-item">
                            <div class="activity-info">
                                <div class="activity-title">Venta #{{ venta.id }}</div>
                                <div class="activity-meta">{{ venta.fecha|date:"d/m H:i" }}</div>
                            </div>
                            <div class="activity-value">${{ venta.total|floatformat:0 }}</div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted small mb-0">No hay actividad reciente</p>
                {% endif %}
            </div>
        </div>

        <!-- PRODUCTOS DESTACADOS -->
        <div class="lino-sidebar-card">
            <div class="lino-sidebar-card__header">
                <h6 class="mb-0 fw-bold d-flex align-items-center">
                    <i class="bi bi-star me-2"></i>
                    Productos Destacados
                </h6>
            </div>
            <div class="lino-sidebar-card__body">
                <div class="d-flex align-items-center mb-2">
                    <span class="lino-tag lino-tag--organico me-2">üå±</span>
                    <small>Pan Integral Org√°nico</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <span class="lino-tag lino-tag--sin-tacc me-2">üö´</span>
                    <small>Galletas Sin TACC</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="lino-tag lino-tag--frutos me-2">ü•ú</span>
                    <small>Mix de Frutos Secos</small>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// üåø LINO Diet√©tica - Sistema de Dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('üåø LINO Diet√©tica - Dashboard cargado correctamente');
    
    // Animaci√≥n suave para las m√©tricas
    const metrics = document.querySelectorAll('.lino-metric-spectacular');
    metrics.forEach((metric, index) => {
        metric.style.opacity = '0';
        metric.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            metric.style.transition = 'all 0.3s ease';
            metric.style.opacity = '1';
            metric.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Efecto hover mejorado para las etiquetas
    const tags = document.querySelectorAll('.lino-tag');
    tags.forEach(tag => {
        tag.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px) scale(1.05)';
        });
        
        tag.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });
    
    // üìä SISTEMA DE GR√ÅFICOS INTELIGENTE
    initChart();
});

// üìà Funci√≥n para cambiar entre gr√°ficos
function changeChart(type) {
    // Actualizar botones activos
    document.querySelectorAll('.lino-chart-btn').forEach(btn => {
        btn.classList.remove('lino-chart-btn--active');
    });
    document.querySelector(`[data-chart="${type}"]`).classList.add('lino-chart-btn--active');
    
    // Cambiar el gr√°fico
    updateChart(type);
}

// üìä Inicializar Chart.js
function initChart() {
    const ctx = document.getElementById('dashboard-chart');
    if (!ctx) return;
    
    window.dashboardChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
            datasets: [{
                label: 'Ventas Diarias ($)',
                data: [{{ ventas_data|default:"150, 200, 180, 220, 300, 350, 280"|safe }}],
                backgroundColor: [
                    'rgba(74, 92, 58, 0.8)',
                    'rgba(139, 148, 113, 0.8)',
                    'rgba(107, 122, 79, 0.8)',
                    'rgba(74, 92, 58, 0.9)',
                    'rgba(139, 148, 113, 0.9)',
                    'rgba(74, 92, 58, 1)',
                    'rgba(107, 122, 79, 0.8)'
                ],
                borderColor: 'rgba(74, 92, 58, 1)',
                borderWidth: 0,
                borderRadius: {
                    topLeft: 12,
                    topRight: 12,
                    bottomLeft: 4,
                    bottomRight: 4
                },
                borderSkipped: false,
                barThickness: 35,
                categoryPercentage: 0.8,
                barPercentage: 0.9,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 20,
                    right: 20,
                    bottom: 20,
                    left: 20
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(74, 92, 58, 0.95)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(74, 92, 58, 1)',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: false,
                    titleFont: {
                        size: 14,
                        weight: '600'
                    },
                    bodyFont: {
                        size: 13
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    border: {
                        display: false
                    },
                    grid: {
                        color: 'rgba(74, 92, 58, 0.08)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: 'rgba(74, 92, 58, 0.7)',
                        font: {
                            size: 11,
                            weight: '500'
                        },
                        padding: 10
                    }
                },
                x: {
                    border: {
                        display: false
                    },
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: 'rgba(74, 92, 58, 0.7)',
                        font: {
                            size: 11,
                            weight: '500'
                        },
                        padding: 10
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            animation: {
                duration: 800,
                easing: 'easeInOutQuart'
            }
        }
    });
}

// üîÑ Actualizar gr√°fico seg√∫n tipo
function updateChart(type) {
    if (!window.dashboardChart) return;
    
    const chart = window.dashboardChart;
    
    switch(type) {
        case 'ventas':
            chart.data.datasets[0].label = 'Ventas Diarias ($)';
            chart.data.datasets[0].data = [{{ ventas_data|default:"150, 200, 180, 220, 300, 350, 280"|safe }}];
            chart.data.datasets[0].backgroundColor = [
                'rgba(74, 92, 58, 0.8)',
                'rgba(139, 148, 113, 0.8)',
                'rgba(107, 122, 79, 0.8)',
                'rgba(74, 92, 58, 0.9)',
                'rgba(139, 148, 113, 0.9)',
                'rgba(74, 92, 58, 1)',
                'rgba(107, 122, 79, 0.8)'
            ];
            chart.data.datasets[0].borderColor = 'rgba(74, 92, 58, 1)';
            chart.config.type = 'bar';
            chart.data.datasets[0].borderRadius = {
                topLeft: 12, topRight: 12, bottomLeft: 4, bottomRight: 4
            };
            chart.data.datasets[0].borderWidth = 0;
            chart.data.datasets[0].barThickness = 35;
            chart.data.datasets[0].categoryPercentage = 0.8;
            chart.data.datasets[0].barPercentage = 0.9;
            break;
            
        case 'productos':
            chart.data.datasets[0].label = 'Productos M√°s Vendidos';
            chart.data.datasets[0].data = [{{ productos_data|default:"45, 30, 25"|safe }}];
            chart.data.labels = ['Pan Integral', 'Galletas Sin TACC', 'Mix Frutos Secos'];
            chart.data.datasets[0].backgroundColor = [
                'rgba(74, 92, 58, 0.9)',
                'rgba(139, 148, 113, 0.9)', 
                'rgba(212, 165, 116, 0.9)'
            ];
            chart.data.datasets[0].borderColor = [
                'rgba(74, 92, 58, 1)',
                'rgba(139, 148, 113, 1)',
                'rgba(212, 165, 116, 1)'
            ];
            chart.config.type = 'doughnut';
            chart.data.datasets[0].borderWidth = 2;
            chart.data.datasets[0].cutout = '50%';
            break;
            
        case 'tendencias':
            chart.data.datasets[0].label = 'Tendencia de Ventas';
            chart.data.datasets[0].data = [{{ tendencias_data|default:"100, 120, 110, 140, 160, 180, 200"|safe }}];
            chart.data.labels = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
            chart.data.datasets[0].backgroundColor = 'rgba(74, 92, 58, 0.1)';
            chart.data.datasets[0].borderColor = 'rgba(74, 92, 58, 1)';
            chart.data.datasets[0].borderWidth = 3;
            chart.data.datasets[0].fill = true;
            chart.data.datasets[0].tension = 0.4;
            chart.data.datasets[0].pointBackgroundColor = 'rgba(74, 92, 58, 1)';
            chart.data.datasets[0].pointBorderColor = 'white';
            chart.data.datasets[0].pointBorderWidth = 2;
            chart.data.datasets[0].pointRadius = 6;
            chart.config.type = 'line';
            break;
    }
    
    chart.update('active');
}
</script>
{% endblock %}
