{% extends 'gestion/base.html' %}
{% load static %}

{% block title %}Dashboard LINO Diet√©tica{% endblock %}

{% block header %}üåø Dashboard Principal - LINO{% endblock %}

{% block content %}

<!-- üåø HERO SECTION DIN√ÅMICO - LINO V3 -->
<div class="lino-hero-section">
    <div class="row align-items-center">
        <!-- Columna Izquierda: Saludo Personalizado -->
        <div class="col-lg-8">
            <div class="lino-hero-greeting">
                {% load tz %}
                {% now "H" as current_hour %}
                {% if current_hour|add:"0" < 12 %}
                    <h1 class="lino-hero-greeting__title">‚òÄÔ∏è ¬°Buenos d√≠as, {% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}!</h1>
                {% elif current_hour|add:"0" < 18 %}
                    <h1 class="lino-hero-greeting__title">üå§Ô∏è ¬°Buenas tardes, {% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}!</h1>
                {% else %}
                    <h1 class="lino-hero-greeting__title">üåô ¬°Buenas noches, {% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}!</h1>
                {% endif %}
                <p class="lino-hero-greeting__subtitle">
                    <i class="bi bi-calendar3 me-2"></i>
                    {% now "l, j \d\e F \d\e Y" %}
                </p>
            </div>

            <!-- Resumen del D√≠a -->
            <div class="row g-3 mt-2">
                <div class="col-md-4">
                    <div class="lino-hero-stat">
                        <div class="lino-hero-stat__label">üí∞ Ventas Hoy</div>
                        <div class="lino-hero-stat__value">
                            ${{ resumen_hoy.total_ventas|floatformat:0|default:"0" }}
                        </div>
                        {% if resumen_hoy.variacion > 0 %}
                            <div class="lino-hero-stat__trend lino-hero-stat__trend--up">
                                <i class="bi bi-arrow-up"></i> +{{ resumen_hoy.variacion|floatformat:1 }}%
                            </div>
                        {% elif resumen_hoy.variacion < 0 %}
                            <div class="lino-hero-stat__trend lino-hero-stat__trend--down">
                                <i class="bi bi-arrow-down"></i> {{ resumen_hoy.variacion|floatformat:1 }}%
                            </div>
                        {% else %}
                            <div class="lino-hero-stat__trend lino-hero-stat__trend--neutral">
                                <i class="bi bi-dash"></i> Sin cambios
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="lino-hero-stat">
                        <div class="lino-hero-stat__label">üìã Transacciones</div>
                        <div class="lino-hero-stat__value">
                            {{ resumen_hoy.cantidad_ventas|default:"0" }}
                        </div>
                        <div class="lino-hero-stat__subtitle">
                            operaciones hoy
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="lino-hero-stat">
                        <div class="lino-hero-stat__label">üì¶ Productos Vendidos</div>
                        <div class="lino-hero-stat__value">
                            {{ resumen_hoy.productos_vendidos|default:"0" }}
                        </div>
                        <div class="lino-hero-stat__subtitle">
                            unidades
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: B√∫squeda R√°pida -->
        <div class="col-lg-4">
            <div class="lino-quick-search-card">
                <div class="lino-quick-search-card__header">
                    <i class="bi bi-search me-2"></i>
                    <span>B√∫squeda R√°pida</span>
                </div>
                <div class="lino-quick-search-card__body">
                    <form action="{% url 'gestion:lista_productos' %}" method="get" class="mb-3">
                        <div class="input-group">
                            <input type="text" name="q" class="form-control" 
                                   placeholder="üîç Buscar producto..." autocomplete="off">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </form>
                    <div class="lino-quick-filters">
                        <a href="{% url 'gestion:lista_productos' %}?categoria=organicos" class="lino-quick-filter">
                            üå± Org√°nicos
                        </a>
                        <a href="{% url 'gestion:lista_productos' %}?categoria=sin_tacc" class="lino-quick-filter">
                            üö´ Sin TACC
                        </a>
                        <a href="{% url 'gestion:lista_productos' %}?categoria=cereales" class="lino-quick-filter">
                            üåæ Cereales
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- üåü M√âTRICAS PRINCIPALES - LINO V3 -->
<div class="row g-4 mb-5">
    <!-- üí∞ VENTAS DEL MES -->
    <div class="col-xl-3 col-lg-6 col-md-6">
        <div class="lino-metric-spectacular lino-metric-spectacular--success">
            <div class="lino-metric-spectacular__header">
                <div class="lino-metric-spectacular__icon">
                    <i class="bi bi-cash-stack"></i>
                </div>
                <span class="lino-metric-spectacular__badge">Este Mes</span>
            </div>
            <div class="lino-metric-spectacular__body">
                <h3 class="lino-metric-spectacular__label">üí∞ Ventas Totales</h3>
                <div class="lino-metric-spectacular__value">${{ kpis.ventas_mes.total|floatformat:0|default:"0" }}</div>
                {% if kpis.ventas_mes.variacion > 0 %}
                    <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--success">
                        <i class="bi bi-arrow-up"></i>
                        <span>+{{ kpis.ventas_mes.variacion|floatformat:1 }}% vs mes anterior</span>
                    </div>
                {% elif kpis.ventas_mes.variacion < 0 %}
                    <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--danger">
                        <i class="bi bi-arrow-down"></i>
                        <span>{{ kpis.ventas_mes.variacion|floatformat:1 }}% vs mes anterior</span>
                    </div>
                {% else %}
                    <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--neutral">
                        <i class="bi bi-dash"></i>
                        <span>Sin cambios</span>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- üå± PRODUCTOS ACTIVOS -->
    <div class="col-xl-3 col-lg-6 col-md-6">
        <div class="lino-metric-spectacular lino-metric-spectacular--primary">
            <div class="lino-metric-spectacular__header">
                <div class="lino-metric-spectacular__icon">
                    <i class="bi bi-basket3"></i>
                </div>
                <span class="lino-metric-spectacular__badge">Cat√°logo</span>
            </div>
            <div class="lino-metric-spectacular__body">
                <h3 class="lino-metric-spectacular__label">üå± Productos Activos</h3>
                <div class="lino-metric-spectacular__value">{{ kpis.productos.total|default:"0" }}</div>
                {% if kpis.productos.bajo_stock > 0 %}
                    <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span>{{ kpis.productos.bajo_stock }} bajo stock</span>
                    </div>
                {% else %}
                    <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--success">
                        <i class="bi bi-check-circle"></i>
                        <span>Stock saludable</span>
                    </div>
                {% endif %}
                <a href="{% url 'gestion:lista_productos' %}" class="btn btn-sm btn-outline-primary mt-3 w-100">
                    <i class="bi bi-arrow-right-circle me-1"></i> Ver productos
                </a>
            </div>
        </div>
    </div>

    <!-- üíé VALOR INVENTARIO -->
    <div class="col-xl-3 col-lg-6 col-md-6">
        <div class="lino-metric-spectacular lino-metric-spectacular--info">
            <div class="lino-metric-spectacular__header">
                <div class="lino-metric-spectacular__icon">
                    <i class="bi bi-gem"></i>
                </div>
                <span class="lino-metric-spectacular__badge">Patrimonio</span>
            </div>
            <div class="lino-metric-spectacular__body">
                <h3 class="lino-metric-spectacular__label">üíé Valor Inventario</h3>
                <div class="lino-metric-spectacular__value">${{ kpis.inventario.valor|floatformat:0|default:"0" }}</div>
                <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--neutral">
                    <i class="bi bi-graph-up"></i>
                    <span>ROI: {{ kpis.inventario.roi|floatformat:1 }}%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- üîî ALERTAS CR√çTICAS -->
    <div class="col-xl-3 col-lg-6 col-md-6">
        <div class="lino-metric-spectacular lino-metric-spectacular--danger">
            <div class="lino-metric-spectacular__header">
                <div class="lino-metric-spectacular__icon">
                    <i class="bi bi-bell-fill"></i>
                </div>
                <span class="lino-metric-spectacular__badge">Notificaciones</span>
            </div>
            <div class="lino-metric-spectacular__body">
                <h3 class="lino-metric-spectacular__label">üîî Alertas Cr√≠ticas</h3>
                <div class="lino-metric-spectacular__value">{{ alertas_criticas|default:"0" }}</div>
                {% if alertas_criticas > 0 %}
                    <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--danger">
                        <i class="bi bi-exclamation-circle"></i>
                        <span>Requieren atenci√≥n</span>
                    </div>
                {% else %}
                    <div class="lino-metric-spectacular__trend lino-metric-spectacular__trend--success">
                        <i class="bi bi-check-circle"></i>
                        <span>Todo bajo control</span>
                    </div>
                {% endif %}
                <a href="#alertas-section" class="btn btn-sm btn-outline-danger mt-3 w-100">
                    <i class="bi bi-arrow-right-circle me-1"></i> Ver alertas
                </a>
            </div>
        </div>
    </div>
</div>

<!-- üìä PANEL DE CONTROL PRINCIPAL -->
<div class="row g-3">
    <div class="col-lg-8">
        <!-- ACCIONES R√ÅPIDAS PRINCIPALES -->
        <div class="lino-chart-container mb-3">
            <div class="lino-chart-header">
                <h5 class="lino-chart-title mb-0">
                    <i class="bi bi-lightning me-2"></i>
                    Acciones R√°pidas
                </h5>
            </div>
            <div class="lino-chart-body p-3">
                <div class="row g-2">
                    <div class="col-md-4">
                        <a href="/gestion/ventas/crear/" class="lino-btn lino-btn-success w-100">
                            <i class="bi bi-plus-circle me-2"></i>Nueva Venta
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="/gestion/compras/crear/" class="lino-btn lino-btn-secondary w-100">
                            <i class="bi bi-truck me-2"></i>Nueva Compra
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="/gestion/productos/crear/" class="lino-btn lino-btn-warning w-100">
                            <i class="bi bi-box me-2"></i>Nuevo Producto
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- üìä GR√ÅFICO DE VENTAS AVANZADO -->
        <div class="lino-chart-container mt-3">
            <div class="lino-chart-header">
                <h5 class="lino-chart-title">
                    <i class="bi bi-graph-up me-2"></i>
                    Evoluci√≥n de Ventas
                </h5>
                <!-- üìÖ CONTROLES DE PER√çODO -->
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn lino-btn-periodo {% if periodo_actual == 7 %}active{% endif %}" 
                            onclick="cambiarPeriodo(7)">7 d√≠as</button>
                    <button type="button" class="btn lino-btn-periodo {% if periodo_actual == 30 %}active{% endif %}" 
                            onclick="cambiarPeriodo(30)">30 d√≠as</button>
                    <button type="button" class="btn lino-btn-periodo {% if periodo_actual == 90 %}active{% endif %}" 
                            onclick="cambiarPeriodo(90)">90 d√≠as</button>
                </div>
            </div>
            <div class="lino-chart-body p-3">
                <!-- üìà √ÅREA DEL GR√ÅFICO -->
                <div style="position: relative; height: 300px;">
                    <canvas id="ventasChart"></canvas>
                </div>
                
                <!-- üìä M√âTRICAS DEL PER√çODO -->
                <div class="row text-center mt-4">
                    <div class="col-md-3">
                        <div class="metric-item">
                            <div class="metric-value" style="color: #4a5c3a; font-weight: 700; font-size: 1.75rem;">
                                ${{ ventas_grafico.total|floatformat:0 }}
                            </div>
                            <div class="metric-label" style="color: #6b7a4f; font-size: 0.875rem;">Total Per√≠odo</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-item">
                            <div class="metric-value" style="color: #6b7a4f; font-weight: 700; font-size: 1.75rem;">
                                ${{ ventas_grafico.promedio|floatformat:0 }}
                            </div>
                            <div class="metric-label" style="color: #6b7a4f; font-size: 0.875rem;">Promedio Diario</div>
                        </div>
                    </div>
                    {% if ventas_grafico.variacion %}
                    <div class="col-md-3">
                        <div class="metric-item">
                            <div class="metric-value" style="color: {% if ventas_grafico.variacion > 0 %}#4a5c3a{% else %}#d4a574{% endif %}; font-weight: 700; font-size: 1.75rem;">
                                {{ ventas_grafico.variacion|floatformat:1 }}%
                            </div>
                            <div class="metric-label" style="color: #6b7a4f; font-size: 0.875rem;">vs Per√≠odo Anterior</div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="col-md-3">
                        <div class="form-check form-switch d-flex justify-content-center align-items-center mt-3">
                            <input class="form-check-input me-2" type="checkbox" id="comparar" 
                                   {% if comparar_activo %}checked{% endif %}
                                   onchange="toggleComparacion()">
                            <label class="form-check-label small" for="comparar" style="color: #6b7a4f;">
                                Comparar per√≠odos
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- üìä TOP 5 PRODUCTOS M√ÅS VENDIDOS -->
        <div class="lino-chart-container mt-3">
            <div class="lino-chart-header">
                <h5 class="lino-chart-title">
                    <i class="bi bi-star me-2"></i>
                    Top 5 Productos (√öltimo Mes)
                </h5>
            </div>
            <div class="lino-chart-body p-3">
                <div style="position: relative; height: 280px;">
                    <canvas id="topProductosChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- PANEL LATERAL -->
    <div class="col-lg-4">
        <!-- ACTIVIDAD RECIENTE -->
        <div class="lino-sidebar-card mb-3">
            <div class="lino-sidebar-card__header">
                <h6 class="mb-0 fw-bold d-flex align-items-center">
                    <i class="bi bi-clock-history me-2"></i>
                    Actividad Reciente
                </h6>
            </div>
            <div class="lino-sidebar-card__body">
                {% if ventas_recientes %}
                    <div class="recent-activity">
                        {% for venta in ventas_recientes %}
                        <div class="activity-item">
                            <div class="activity-info">
                                <div class="activity-title">Venta #{{ venta.id }}</div>
                                <div class="activity-meta">{{ venta.fecha|date:"d/m H:i" }}</div>
                            </div>
                            <div class="activity-value">${{ venta.total|floatformat:0 }}</div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted small mb-0">No hay actividad reciente</p>
                {% endif %}
            </div>
        </div>

        <!-- PRODUCTOS DESTACADOS -->
        <div class="lino-sidebar-card">
            <div class="lino-sidebar-card__header">
                <h6 class="mb-0 fw-bold d-flex align-items-center">
                    <i class="bi bi-star me-2"></i>
                    Productos Destacados
                </h6>
            </div>
            <div class="lino-sidebar-card__body">
                <div class="d-flex align-items-center mb-2">
                    <span class="lino-tag lino-tag--organico me-2">üå±</span>
                    <small>Pan Integral Org√°nico</small>
                </div>
                <div class="d-flex align-items-center mb-2">
                    <span class="lino-tag lino-tag--sin-tacc me-2">üö´</span>
                    <small>Galletas Sin TACC</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="lino-tag lino-tag--frutos me-2">ü•ú</span>
                    <small>Mix de Frutos Secos</small>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// üåø LINO Diet√©tica - Sistema de Dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('üåø LINO Diet√©tica - Dashboard cargado correctamente');
    
    // Animaci√≥n suave para las m√©tricas
    const metrics = document.querySelectorAll('.lino-metric-spectacular');
    metrics.forEach((metric, index) => {
        metric.style.opacity = '0';
        metric.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            metric.style.transition = 'all 0.3s ease';
            metric.style.opacity = '1';
            metric.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Efecto hover mejorado para las etiquetas
    const tags = document.querySelectorAll('.lino-tag');
    tags.forEach(tag => {
        tag.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px) scale(1.05)';
        });
        
        tag.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });
    
    // üìä SISTEMA DE GR√ÅFICOS INTELIGENTE
    initChart();
});

// üìà Funci√≥n para cambiar entre gr√°ficos
function changeChart(type) {
    // Actualizar botones activos
    document.querySelectorAll('.lino-chart-btn').forEach(btn => {
        btn.classList.remove('lino-chart-btn--active');
    });
    document.querySelector(`[data-chart="${type}"]`).classList.add('lino-chart-btn--active');
    
    // Cambiar el gr√°fico
    updateChart(type);
}

// üìä Inicializar Chart.js
function initChart() {
    const ctx = document.getElementById('dashboard-chart');
    if (!ctx) return;
    
    window.dashboardChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
            datasets: [{
                label: 'Ventas Diarias ($)',
                data: [{{ ventas_data|default:"150, 200, 180, 220, 300, 350, 280"|safe }}],
                backgroundColor: [
                    'rgba(74, 92, 58, 0.8)',
                    'rgba(139, 148, 113, 0.8)',
                    'rgba(107, 122, 79, 0.8)',
                    'rgba(74, 92, 58, 0.9)',
                    'rgba(139, 148, 113, 0.9)',
                    'rgba(74, 92, 58, 1)',
                    'rgba(107, 122, 79, 0.8)'
                ],
                borderColor: 'rgba(74, 92, 58, 1)',
                borderWidth: 0,
                borderRadius: {
                    topLeft: 12,
                    topRight: 12,
                    bottomLeft: 4,
                    bottomRight: 4
                },
                borderSkipped: false,
                barThickness: 35,
                categoryPercentage: 0.8,
                barPercentage: 0.9,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    top: 20,
                    right: 20,
                    bottom: 20,
                    left: 20
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(74, 92, 58, 0.95)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(74, 92, 58, 1)',
                    borderWidth: 1,
                    cornerRadius: 8,
                    displayColors: false,
                    titleFont: {
                        size: 14,
                        weight: '600'
                    },
                    bodyFont: {
                        size: 13
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    border: {
                        display: false
                    },
                    grid: {
                        color: 'rgba(74, 92, 58, 0.08)',
                        lineWidth: 1
                    },
                    ticks: {
                        color: 'rgba(74, 92, 58, 0.7)',
                        font: {
                            size: 11,
                            weight: '500'
                        },
                        padding: 10
                    }
                },
                x: {
                    border: {
                        display: false
                    },
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: 'rgba(74, 92, 58, 0.7)',
                        font: {
                            size: 11,
                            weight: '500'
                        },
                        padding: 10
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            animation: {
                duration: 800,
                easing: 'easeInOutQuart'
            }
        }
    });
}

// üîÑ Actualizar gr√°fico seg√∫n tipo
function updateChart(type) {
    if (!window.dashboardChart) return;
    
    const chart = window.dashboardChart;
    
    switch(type) {
        case 'ventas':
            chart.data.datasets[0].label = 'Ventas Diarias ($)';
            chart.data.datasets[0].data = [{{ ventas_data|default:"150, 200, 180, 220, 300, 350, 280"|safe }}];
            chart.data.datasets[0].backgroundColor = [
                'rgba(74, 92, 58, 0.8)',
                'rgba(139, 148, 113, 0.8)',
                'rgba(107, 122, 79, 0.8)',
                'rgba(74, 92, 58, 0.9)',
                'rgba(139, 148, 113, 0.9)',
                'rgba(74, 92, 58, 1)',
                'rgba(107, 122, 79, 0.8)'
            ];
            chart.data.datasets[0].borderColor = 'rgba(74, 92, 58, 1)';
            chart.config.type = 'bar';
            chart.data.datasets[0].borderRadius = {
                topLeft: 12, topRight: 12, bottomLeft: 4, bottomRight: 4
            };
            chart.data.datasets[0].borderWidth = 0;
            chart.data.datasets[0].barThickness = 35;
            chart.data.datasets[0].categoryPercentage = 0.8;
            chart.data.datasets[0].barPercentage = 0.9;
            break;
            
        case 'productos':
            chart.data.datasets[0].label = 'Productos M√°s Vendidos';
            chart.data.datasets[0].data = [{{ productos_data|default:"45, 30, 25"|safe }}];
            chart.data.labels = ['Pan Integral', 'Galletas Sin TACC', 'Mix Frutos Secos'];
            chart.data.datasets[0].backgroundColor = [
                'rgba(74, 92, 58, 0.9)',
                'rgba(139, 148, 113, 0.9)', 
                'rgba(212, 165, 116, 0.9)'
            ];
            chart.data.datasets[0].borderColor = [
                'rgba(74, 92, 58, 1)',
                'rgba(139, 148, 113, 1)',
                'rgba(212, 165, 116, 1)'
            ];
            chart.config.type = 'doughnut';
            chart.data.datasets[0].borderWidth = 2;
            chart.data.datasets[0].cutout = '50%';
            break;
            
        case 'tendencias':
            chart.data.datasets[0].label = 'Tendencia de Ventas';
            chart.data.datasets[0].data = [{{ tendencias_data|default:"100, 120, 110, 140, 160, 180, 200"|safe }}];
            chart.data.labels = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
            chart.data.datasets[0].backgroundColor = 'rgba(74, 92, 58, 0.1)';
            chart.data.datasets[0].borderColor = 'rgba(74, 92, 58, 1)';
            chart.data.datasets[0].borderWidth = 3;
            chart.data.datasets[0].fill = true;
            chart.data.datasets[0].tension = 0.4;
            chart.data.datasets[0].pointBackgroundColor = 'rgba(74, 92, 58, 1)';
            chart.data.datasets[0].pointBorderColor = 'white';
            chart.data.datasets[0].pointBorderWidth = 2;
            chart.data.datasets[0].pointRadius = 6;
            chart.config.type = 'line';
            break;
    }
    
    chart.update('active');
}

// ========== GR√ÅFICOS AVANZADOS FASE 2 ==========

// üìä GR√ÅFICO DE VENTAS POR PER√çODO
let ventasChartInstance = null;

function initVentasChart() {
    const ctx = document.getElementById('ventasChart');
    if (!ctx) {
        console.error('Canvas ventasChart no encontrado');
        return;
    }
    
    // Destruir gr√°fico anterior si existe
    if (ventasChartInstance) {
        ventasChartInstance.destroy();
    }
    
    // Parsear datos JSON desde Django
    let ventasData;
    try {
        ventasData = JSON.parse('{{ ventas_grafico_json|escapejs }}');
    } catch(e) {
        console.error('Error parseando ventas_grafico_json:', e);
        return;
    }
    
    const labels = ventasData.labels;
    const datos = ventasData.datos;
    
    const datasets = [{
        label: 'Ventas ($)',
        data: datos,
        borderColor: '#4a5c3a',
        backgroundColor: 'rgba(74, 92, 58, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 4,
        pointBackgroundColor: '#4a5c3a',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointHoverRadius: 6
    }];
    
    // Agregar l√≠nea de comparaci√≥n si est√° activa
    if (ventasData.datos_anterior) {
        datasets.push({
            label: 'Per√≠odo Anterior ($)',
            data: ventasData.datos_anterior,
            borderColor: '#999',
            backgroundColor: 'rgba(153, 153, 153, 0.05)',
            borderWidth: 2,
            borderDash: [5, 5],
            fill: false,
            tension: 0.4,
            pointRadius: 3,
            pointBackgroundColor: '#999',
            pointBorderColor: '#fff',
            pointBorderWidth: 1
        });
    }
    
    ventasChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: (ventasData.datos_anterior ? true : false),
                    position: 'top',
                    labels: {
                        padding: 15,
                        font: { size: 12, weight: '500' },
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    padding: 12,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString('es-AR');
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString('es-AR');
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// üìä GR√ÅFICO TOP 5 PRODUCTOS
let topProductosChartInstance = null;

function initTopProductosChart() {
    const ctx = document.getElementById('topProductosChart');
    if (!ctx) {
        console.error('Canvas topProductosChart no encontrado');
        return;
    }
    
    if (topProductosChartInstance) {
        topProductosChartInstance.destroy();
    }
    
    // Parsear datos JSON desde Django
    let topProductosData;
    try {
        topProductosData = JSON.parse('{{ top_productos_json|escapejs }}');
    } catch(e) {
        console.error('Error parseando top_productos_json:', e);
        return;
    }
    
    const labels = topProductosData.labels;
    const ingresos = topProductosData.ingresos;
    
    topProductosChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Ingresos ($)',
                data: ingresos,
                backgroundColor: [
                    'rgba(74, 92, 58, 0.9)',
                    'rgba(107, 122, 79, 0.9)',
                    'rgba(139, 148, 113, 0.9)',
                    'rgba(171, 174, 147, 0.9)',
                    'rgba(212, 165, 116, 0.9)'
                ],
                borderColor: [
                    '#4a5c3a',
                    '#6b7a4f',
                    '#8b9471',
                    '#abae93',
                    '#d4a574'
                ],
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    left: 10,
                    right: 20,
                    top: 5,
                    bottom: 5
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            return 'Ingresos: $' + context.parsed.x.toLocaleString('es-AR');
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString('es-AR');
                        },
                        font: {
                            size: 11
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    ticks: {
                        font: {
                            size: 12
                        }
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// üîÑ FUNCIONES DE CONTROL
function cambiarPeriodo(dias) {
    const comparar = {% if comparar_activo %}true{% else %}false{% endif %};
    window.location.href = '?periodo=' + dias + (comparar ? '&comparar=true' : '');
}

function toggleComparacion() {
    const comparar = document.getElementById('comparar').checked;
    const periodo = {{ periodo_actual }};
    window.location.href = '?periodo=' + periodo + (comparar ? '&comparar=true' : '');
}

// üöÄ INICIALIZAR GR√ÅFICOS AL CARGAR
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando gr√°ficos...');
    initVentasChart();
    initTopProductosChart();
});
</script>
{% endblock %}
