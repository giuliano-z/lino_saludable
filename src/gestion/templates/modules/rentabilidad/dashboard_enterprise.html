{% extends 'gestion/base.html' %}
{% load static %}

{% block title %}An√°lisis de Rentabilidad - LINO SYS{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/lino-wizard-ventas.css' %}?v=20241030">
<style>
body {
    background-color: #fafaf9 !important;
}

/* ===== ALERT CARDS ===== */
.alert-card-enterprise {
    background: white;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    border-left-width: 4px;
    padding: 1.25rem;
    margin-bottom: 0.875rem;
    transition: all 0.2s ease;
}

.alert-card-enterprise:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.alert-card-enterprise.critica {
    border-left-color: #dc2626;
    background: linear-gradient(to right, #fef2f2 0%, #ffffff 100%);
}

.alert-card-enterprise.alta {
    border-left-color: #f59e0b;
    background: linear-gradient(to right, #fffbeb 0%, #ffffff 100%);
}

.alert-card-enterprise.media {
    border-left-color: #3b82f6;
    background: linear-gradient(to right, #eff6ff 0%, #ffffff 100%);
}

.alert-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.alert-card-enterprise.critica .alert-icon {
    background: #fee2e2;
    color: #dc2626;
}

.alert-card-enterprise.alta .alert-icon {
    background: #fef3c7;
    color: #f59e0b;
}

.alert-card-enterprise.media .alert-icon {
    background: #dbeafe;
    color: #3b82f6;
}

/* ===== CHARTS ===== */
.chart-wrapper {
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    padding: 1.75rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    height: 100%;
}

.chart-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.chart-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: #111827;
    margin-bottom: 0.25rem;
}

.chart-subtitle {
    font-size: 0.8125rem;
    color: #6b7280;
}

.chart-container {
    position: relative;
    height: 320px;
}

/* ===== TABLE ===== */
.table-enterprise {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.table-enterprise thead {
    background: #f9fafb;
}

.table-enterprise th {
    padding: 1rem;
    text-align: left;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6b7280;
    border-bottom: 2px solid #e5e7eb;
}

.table-enterprise tbody tr {
    border-bottom: 1px solid #f3f4f6;
    transition: all 0.2s ease;
}

.table-enterprise tbody tr:hover {
    background: #f9fafb;
}

.table-enterprise td {
    padding: 1rem;
    font-size: 0.9375rem;
    color: #374151;
}

.badge-status {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    font-size: 0.8125rem;
    font-weight: 600;
    white-space: nowrap;
}

.badge-status.perdida {
    background: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
}

.badge-status.critico {
    background: #fffbeb;
    color: #d97706;
    border: 1px solid #fde68a;
}

.badge-status.bajo {
    background: #eff6ff;
    color: #2563eb;
    border: 1px solid #bfdbfe;
}

.badge-status.aceptable {
    background: #ecfdf5;
    color: #059669;
    border: 1px solid #a7f3d0;
}

.badge-status.optimo {
    background: linear-gradient(135deg, #4a5c3a 0%, #5d7247 100%);
    color: white;
    border: none;
}

/* ===== SECTION HEADERS ===== */
.section-header {
    margin-bottom: 1.5rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
    margin-bottom: 0.375rem;
}

.section-subtitle {
    font-size: 0.9375rem;
    color: #6b7280;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .kpi-value {
        font-size: 1.875rem;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .table-enterprise {
        font-size: 0.875rem;
    }
    
    .table-enterprise th,
    .table-enterprise td {
        padding: 0.75rem 0.5rem;
    }
}
</style>
{% endblock %}

{% block header %}
{% include 'modules/_shared/page_header.html' with title="An√°lisis de Rentabilidad" subtitle="Control de m√°rgenes, costos y optimizaci√≥n de precios" icon="graph-up-arrow" print_button=True %}
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 2rem 1rem;">

    <!-- ===== KPIs LINO EST√ÅNDAR (id√©ntico a Reportes) ===== -->
    <div class="row g-4 mb-4">
        <!-- Total Productos -->
        <div class="col-xl-3 col-md-6">
            <div class="lino-kpi-card lino-kpi-card--primary">
                <div class="lino-kpi-card__header">
                    <h3 class="lino-kpi-card__title">Productos Activos</h3>
                    <div class="lino-kpi-card__icon">
                        <i class="bi bi-box-seam"></i>
                    </div>
                </div>
                <div class="lino-kpi-card__content">
                    <div class="lino-kpi-card__value">{{ analytics.kpis.total_productos|default:0 }}</div>
                    <div class="lino-kpi-card__subtitle">en cat√°logo</div>
                </div>
            </div>
        </div>

        <!-- Rentables -->
        <div class="col-xl-3 col-md-6">
            <div class="lino-kpi-card lino-kpi-card--success">
                <div class="lino-kpi-card__header">
                    <h3 class="lino-kpi-card__title">Rentables</h3>
                    <div class="lino-kpi-card__icon">
                        <i class="bi bi-graph-up-arrow"></i>
                    </div>
                </div>
                <div class="lino-kpi-card__content">
                    <div class="lino-kpi-card__value">{{ analytics.kpis.porcentaje_rentables|default:0 }}%</div>
                    <div class="lino-kpi-card__subtitle">{{ analytics.kpis.productos_rentables|default:0 }} productos</div>
                    <span class="lino-badge lino-badge--success mt-2">
                        <i class="bi bi-arrow-up"></i> 2 productos
                    </span>
                </div>
            </div>
        </div>

        <!-- En P√©rdida -->
        <div class="col-xl-3 col-md-6">
            <div class="lino-kpi-card lino-kpi-card--danger">
                <div class="lino-kpi-card__header">
                    <h3 class="lino-kpi-card__title">En P√©rdida</h3>
                    <div class="lino-kpi-card__icon">
                        <i class="bi bi-graph-down-arrow"></i>
                    </div>
                </div>
                <div class="lino-kpi-card__content">
                    <div class="lino-kpi-card__value">{{ analytics.kpis.porcentaje_perdida|default:0 }}%</div>
                    <div class="lino-kpi-card__subtitle">
                        {% if analytics.kpis.productos_en_perdida > 0 %}
                        <i class="bi bi-check-circle"></i> Sin p√©rdidas
                        {% else %}
                        <i class="bi bi-check-circle"></i> Sin p√©rdidas
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Margen Promedio -->
        <div class="col-xl-3 col-md-6">
            <div class="lino-kpi-card lino-kpi-card--warning">
                <div class="lino-kpi-card__header">
                    <h3 class="lino-kpi-card__title">Margen Promedio</h3>
                    <div class="lino-kpi-card__icon">
                        <i class="bi bi-percent"></i>
                    </div>
                </div>
                <div class="lino-kpi-card__content">
                    <div class="lino-kpi-card__value">{{ analytics.kpis.margen_promedio_ponderado|default:0|floatformat:1 }}%</div>
                    <div class="lino-kpi-card__subtitle">ponderado por ventas</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== ALERTAS ===== -->
    {% if analytics.alertas %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="section-header">
                <h5 class="section-title">
                    <i class="bi bi-bell me-2" style="color: #dc2626;"></i>Alertas de Rentabilidad
                </h5>
                <p class="section-subtitle">Productos que requieren atenci√≥n inmediata</p>
            </div>

            <div class="row g-3">
                {% for alerta in analytics.alertas %}
                <div class="col-lg-6">
                    <div class="alert-card-enterprise {{ alerta.severidad }}">
                        <div class="d-flex gap-3">
                            <div class="alert-icon">
                                <i class="bi {% if alerta.severidad == 'critica' %}bi-exclamation-triangle-fill{% elif alerta.severidad == 'alta' %}bi-exclamation-circle-fill{% else %}bi-info-circle-fill{% endif %}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 style="font-weight: 700; font-size: 0.9375rem; margin: 0; color: #111827;">
                                        {{ alerta.tipo|title }}
                                    </h6>
                                    {% if alerta.severidad == 'critica' %}
                                    <span class="badge bg-danger">Cr√≠tico</span>
                                    {% elif alerta.severidad == 'alta' %}
                                    <span class="badge bg-warning text-dark">Alto</span>
                                    {% else %}
                                    <span class="badge bg-info">Medio</span>
                                    {% endif %}
                                </div>
                                <p style="font-size: 0.875rem; color: #4b5563; margin-bottom: 0.75rem;">
                                    <strong>{{ alerta.producto }}</strong>: {{ alerta.mensaje }}
                                </p>
                                {% if alerta.recomendacion %}
                                <div style="background: rgba(255,255,255,0.6); padding: 0.625rem 0.875rem; border-radius: 6px; font-size: 0.8125rem;">
                                    <i class="bi bi-lightbulb me-1" style="color: #f59e0b;"></i>
                                    <strong>Recomendaci√≥n:</strong> {{ alerta.recomendacion }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ===== GR√ÅFICOS ===== -->
    <div class="row g-4 mb-4">
        <!-- Distribuci√≥n por M√°rgenes -->
        <div class="col-lg-6">
            <div class="chart-wrapper">
                <div class="chart-header">
                    <h5 class="chart-title">Distribuci√≥n por M√°rgenes</h5>
                    <p class="chart-subtitle">Clasificaci√≥n de productos seg√∫n rentabilidad</p>
                </div>
                <div class="chart-container">
                    <canvas id="margenesChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top 10 M√°rgenes -->
        <div class="col-lg-6">
            <div class="chart-wrapper">
                <div class="chart-header">
                    <h5 class="chart-title">Top 10 M√°rgenes</h5>
                    <p class="chart-subtitle">Productos m√°s rentables del cat√°logo</p>
                </div>
                <div class="chart-container">
                    <canvas id="topProductosChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== TABLA DETALLADA ===== -->
    <div class="row">
        <div class="col-12">
            <div class="chart-wrapper">
                <div class="d-flex justify-content-between align-items-center mb-4 pb-3" style="border-bottom: 1px solid #e5e7eb;">
                    <div>
                        <h5 class="chart-title mb-1">An√°lisis Detallado por Producto</h5>
                        <p class="chart-subtitle mb-0">Costos, precios y m√°rgenes actuales</p>
                    </div>
                    <div>
                        <input type="text" id="searchProduct" class="form-control form-control-sm" placeholder="üîç Buscar producto..." style="width: 250px;">
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table-enterprise">
                        <thead>
                            <tr>
                                <th style="width: 30%;">Producto</th>
                                <th style="width: 13%;" class="text-end">Costo Unit.</th>
                                <th style="width: 13%;" class="text-end">Precio Venta</th>
                                <th style="width: 12%;" class="text-end">Margen %</th>
                                <th style="width: 14%;" class="text-center">Ganancia</th>
                                <th style="width: 18%;" class="text-center">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="productosTableBody">
                            {% for producto_data in productos_paginados %}
                            <tr class="producto-row" data-nombre="{{ producto_data.producto.nombre|lower }}">
                                <td>
                                    <div style="font-weight: 600; color: #111827; margin-bottom: 0.25rem;">
                                        {{ producto_data.producto.nombre }}
                                    </div>
                                    {% if producto_data.producto.categoria %}
                                    <div style="font-size: 0.75rem; color: #9ca3af;">
                                        {{ producto_data.producto.categoria }}
                                    </div>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <span style="font-family: 'Courier New', monospace; font-weight: 600; color: #dc2626;">
                                        ${{ producto_data.costo_actual|floatformat:2 }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    <span style="font-family: 'Courier New', monospace; font-weight: 600; color: #059669;">
                                        ${{ producto_data.precio_actual|floatformat:2 }}
                                    </span>
                                </td>
                                <td class="text-end">
                                    <span style="font-family: 'Courier New', monospace; font-weight: 700; font-size: 1.0625rem; 
                                        {% if producto_data.en_perdida %}color: #dc2626;
                                        {% elif producto_data.margen_porcentaje < 10 %}color: #f59e0b;
                                        {% elif producto_data.margen_porcentaje < 20 %}color: #3b82f6;
                                        {% elif producto_data.margen_porcentaje < 30 %}color: #059669;
                                        {% else %}color: #4a5c3a;{% endif %}">
                                        {{ producto_data.margen_porcentaje|floatformat:1 }}%
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span style="font-family: 'Courier New', monospace; font-weight: 600; font-size: 0.9375rem;
                                        {% if producto_data.en_perdida %}color: #dc2626;{% else %}color: #059669;{% endif %}">
                                        {% if producto_data.en_perdida %}-{% endif %}${{ producto_data.margen_absoluto|floatformat:2 }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    {% if producto_data.en_perdida %}
                                        <span class="badge-status perdida">‚õî P√©rdida</span>
                                    {% elif producto_data.margen_porcentaje < 10 %}
                                        <span class="badge-status critico">‚ö†Ô∏è Cr√≠tico</span>
                                    {% elif producto_data.margen_porcentaje < 20 %}
                                        <span class="badge-status bajo">üìä Bajo</span>
                                    {% elif producto_data.margen_porcentaje < 30 %}
                                        <span class="badge-status aceptable">‚úÖ Aceptable</span>
                                    {% else %}
                                        <span class="badge-status optimo">üèÜ √ìptimo</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-5">
                                    <i class="bi bi-inbox" style="font-size: 3rem; display: block; margin-bottom: 1rem; opacity: 0.3;"></i>
                                    <p style="margin: 0;">No hay productos para analizar</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- ===== PAGINACI√ìN ===== -->
                {% if productos_paginados.has_other_pages %}
                <div class="d-flex justify-content-between align-items-center mt-4 pt-3" style="border-top: 1px solid #e5e7eb;">
                    <div style="font-size: 0.875rem; color: #6b7280;">
                        Mostrando {{ productos_paginados.start_index }} - {{ productos_paginados.end_index }} de {{ productos_paginados.paginator.count }} productos
                    </div>
                    <nav>
                        <ul class="pagination mb-0">
                            {% if productos_paginados.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1">
                                    <i class="bi bi-chevron-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ productos_paginados.previous_page_number }}">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-double-left"></i></span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                            </li>
                            {% endif %}

                            {% for num in productos_paginados.paginator.page_range %}
                                {% if productos_paginados.number == num %}
                                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                {% elif num > productos_paginados.number|add:'-3' and num < productos_paginados.number|add:'3' %}
                                <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                                {% endif %}
                            {% endfor %}

                            {% if productos_paginados.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ productos_paginados.next_page_number }}">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ productos_paginados.paginator.num_pages }}">
                                    <i class="bi bi-chevron-double-right"></i>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-double-right"></i></span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

</div>

<script>
// ===== SEARCH FUNCTIONALITY =====
document.getElementById('searchProduct')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.producto-row');
    
    rows.forEach(row => {
        const productName = row.dataset.nombre;
        if (productName.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// ===== CHART.JS CONFIGURATION =====
const ctxMargenes = document.getElementById('margenesChart')?.getContext('2d');
if (ctxMargenes) {
    new Chart(ctxMargenes, {
        type: 'doughnut',
        data: {
            labels: {{ margenes_labels|safe }},
            datasets: [{
                data: {{ margenes_data|safe }},
                backgroundColor: [
                    '#dc2626',  // En P√©rdida - Rojo intenso
                    '#f59e0b',  // Cr√≠tico (<10%) - Naranja
                    '#3b82f6',  // Bajo (10-20%) - Azul
                    '#10b981',  // Aceptable (20-30%) - Verde esmeralda
                    '#4a5c3a',  // Bueno (30-40%) - Verde oliva LINO
                    '#059669',  // Muy Bueno (40-60%) - Verde oscuro
                    '#065f46',  // Excelente (60-80%) - Verde muy oscuro
                    '#064e3b',  // Premium (80-100%) - Verde profundo
                    '#022c22'   // Elite (>100%) - Verde ultra oscuro
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12, family: 'Inter, sans-serif' },
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + ' productos';
                        }
                    }
                }
            }
        }
    });
}

const ctxTopProductos = document.getElementById('topProductosChart')?.getContext('2d');
if (ctxTopProductos) {
    new Chart(ctxTopProductos, {
        type: 'bar',
        data: {
            labels: {{ top_margenes_labels|safe }},
            datasets: [{
                label: 'Margen %',
                data: {{ top_margenes_data|safe }},
                backgroundColor: 'rgba(74, 92, 58, 0.8)',
                borderColor: 'rgba(74, 92, 58, 1)',
                borderWidth: 1,
                borderRadius: 6
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Margen: ' + context.parsed.x.toFixed(1) + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: { display: true, color: '#f3f4f6' }
                },
                y: {
                    grid: { display: false }
                }
            }
        }
    });
}
</script>
{% endblock %}
