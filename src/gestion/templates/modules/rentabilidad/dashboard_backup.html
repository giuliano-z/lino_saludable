{% extends 'gestion/base.html' %}
{% load static %}

{% block title %}An√°lisis de Rentabilidad - LINO SYS{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/lino-wizard-ventas.css' %}?v=20241030">
<style>
body {
    background-color: #fafaf9 !important;
}

/* ===== ENTERPRISE KPI CARDS ===== */
.enterprise-kpi-card {
    background: white;
    border-radius: 12px;
    padding: 1.75rem;
    border: 1px solid #e5e7eb;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
}

.enterprise-kpi-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--accent-color, #4a5c3a), var(--accent-light, #5d7247));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.enterprise-kpi-card:hover::before {
    opacity: 1;
}

.enterprise-kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(74, 92, 58, 0.12);
    border-color: var(--lino-primary);
}

.kpi-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.25rem;
}

.kpi-icon {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.kpi-label {
    font-size: 0.8125rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6b7280;
    margin-bottom: 0.5rem;
}

.kpi-value {
    font-size: 2.25rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0.75rem;
}

.kpi-trend {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    font-weight: 600;
    padding: 0.25rem 0.625rem;
    border-radius: 6px;
}

.kpi-trend.positive {
    background: #ecfdf5;
    color: #059669;
}

.kpi-trend.negative {
    background: #fef2f2;
    color: #dc2626;
}

.kpi-trend.neutral {
    background: #f3f4f6;
    color: #6b7280;
}

.kpi-subtitle {
    font-size: 0.8125rem;
    color: #9ca3af;
    margin-top: 0.5rem;
}

/* ===== ALERT SYSTEM ENTERPRISE ===== */
.alert-enterprise {
    background: white;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    padding: 1.25rem;
    margin-bottom: 0.875rem;
    transition: all 0.2s ease;
    border-left-width: 4px;
}

.alert-enterprise:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.alert-enterprise.critica {
    border-left-color: #dc2626;
    background: linear-gradient(to right, #fef2f2 0%, #ffffff 100%);
}

.alert-enterprise.alta {
    border-left-color: #f59e0b;
    background: linear-gradient(to right, #fffbeb 0%, #ffffff 100%);
}

.alert-enterprise.media {
    border-left-color: #3b82f6;
    background: linear-gradient(to right, #eff6ff 0%, #ffffff 100%);
}

.alert-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.alert-enterprise.critica .alert-icon {
    background: #fef2f2;
    color: #dc2626;
}

.alert-enterprise.alta .alert-icon {
    background: #fffbeb;
    color: #f59e0b;
}

.alert-enterprise.media .alert-icon {
    background: #eff6ff;
    color: #3b82f6;
}

/* ===== CHART CONTAINERS ===== */
.chart-wrapper {
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    padding: 1.75rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.chart-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: #111827;
}

.chart-subtitle {
    font-size: 0.8125rem;
    color: #6b7280;
    margin-top: 0.25rem;
}

.chart-container {
    position: relative;
    height: 320px;
}

/* ===== PRODUCT TABLE ENTERPRISE ===== */
.table-enterprise {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.table-enterprise thead {
    background: #f9fafb;
}

.table-enterprise th {
    padding: 1rem;
    text-align: left;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6b7280;
    border-bottom: 2px solid #e5e7eb;
}

.table-enterprise tbody tr {
    border-bottom: 1px solid #f3f4f6;
    transition: all 0.2s ease;
}

.table-enterprise tbody tr:hover {
    background: #f9fafb;
}

.table-enterprise td {
    padding: 1rem;
    font-size: 0.9375rem;
    color: #374151;
}

.badge-status {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    font-size: 0.8125rem;
    font-weight: 600;
    white-space: nowrap;
}

.badge-status.perdida {
    background: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
}

.badge-status.critico {
    background: #fffbeb;
    color: #d97706;
    border: 1px solid #fde68a;
}

.badge-status.bajo {
    background: #eff6ff;
    color: #2563eb;
    border: 1px solid #bfdbfe;
}

.badge-status.aceptable {
    background: #ecfdf5;
    color: #059669;
    border: 1px solid #a7f3d0;
}

.badge-status.optimo {
    background: linear-gradient(135deg, #4a5c3a 0%, #5d7247 100%);
    color: white;
    border: none;
}

/* ===== SECTION HEADERS ===== */
.section-header {
    margin-bottom: 1.5rem;
}

.section-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
    margin-bottom: 0.375rem;
}

.section-subtitle {
    font-size: 0.9375rem;
    color: #6b7280;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .kpi-value {
        font-size: 1.875rem;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .table-enterprise {
        font-size: 0.875rem;
    }
    
    .table-enterprise th,
    .table-enterprise td {
        padding: 0.75rem 0.5rem;
    }
}
</style>
{% endblock %}

{% block header %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1">
            <i class="bi bi-graph-up-arrow me-2"></i>An√°lisis de Rentabilidad
        </h1>
        <p class="text-muted mb-0">Control de m√°rgenes y optimizaci√≥n de precios</p>
    </div>
    <div>
        <button class="lino-btn lino-btn-primary" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise me-2"></i>Actualizar
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 2rem 1rem;">
    
    <!-- üìä KPIs Principales -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="lino-card" style="border: none; border-radius: 16px; box-shadow: 0 2px 12px rgba(74, 92, 58, 0.08);">
                <div class="lino-card-body" style="padding: 1.5rem;">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div style="background: linear-gradient(135deg, #4a5c3a 0%, #5d7247 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-boxes" style="color: white; font-size: 1.5rem;"></i>
                        </div>
                        <span class="badge bg-light text-dark">Total</span>
                    </div>
                    <h3 style="color: var(--lino-primary); font-weight: 700; font-size: 2rem; margin-bottom: 0.25rem;">
                        {{ analytics.kpis.total_productos|default:"0" }}
                    </h3>
                    <p class="text-muted mb-0" style="font-size: 0.875rem;">Productos en Sistema</p>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="lino-card" style="border: none; border-radius: 16px; box-shadow: 0 2px 12px rgba(40, 167, 69, 0.08);">
                <div class="lino-card-body" style="padding: 1.5rem;">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-graph-up" style="color: white; font-size: 1.5rem;"></i>
                        </div>
                        <span class="badge bg-success">Rentables</span>
                    </div>
                    <h3 style="color: #28a745; font-weight: 700; font-size: 2rem; margin-bottom: 0.25rem;">
                        {{ analytics.kpis.porcentaje_rentables|floatformat:1|default:"0" }}%
                    </h3>
                    <p class="text-muted mb-0" style="font-size: 0.875rem;">
                        {{ analytics.kpis.productos_rentables|default:"0" }} productos rentables
                    </p>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="lino-card" style="border: none; border-radius: 16px; box-shadow: 0 2px 12px rgba(220, 53, 69, 0.08);">
                <div class="lino-card-body" style="padding: 1.5rem;">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-exclamation-triangle-fill" style="color: white; font-size: 1.5rem;"></i>
                        </div>
                        <span class="badge bg-danger">‚ö†Ô∏è Alerta</span>
                    </div>
                    <h3 style="color: #dc3545; font-weight: 700; font-size: 2rem; margin-bottom: 0.25rem;">
                        {{ analytics.kpis.porcentaje_perdida|floatformat:1|default:"0" }}%
                    </h3>
                    <p class="text-muted mb-0" style="font-size: 0.875rem;">
                        {{ analytics.kpis.productos_en_perdida|default:"0" }} productos en p√©rdida
                    </p>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="lino-card" style="border: none; border-radius: 16px; box-shadow: 0 2px 12px rgba(255, 193, 7, 0.08);">
                <div class="lino-card-body" style="padding: 1.5rem;">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-percent" style="color: white; font-size: 1.5rem;"></i>
                        </div>
                        <span class="badge bg-warning text-dark">Promedio</span>
                    </div>
                    <h3 style="color: #ffc107; font-weight: 700; font-size: 2rem; margin-bottom: 0.25rem;">
                        {{ analytics.kpis.margen_promedio_ponderado|floatformat:1|default:"0" }}%
                    </h3>
                    <p class="text-muted mb-0" style="font-size: 0.875rem;">Margen ponderado</p>
                </div>
            </div>
        </div>
    </div>

    <!-- üö® Alertas Cr√≠ticas -->
    {% if analytics.alertas %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="lino-card" style="border: none; border-radius: 16px; box-shadow: 0 2px 12px rgba(220, 53, 69, 0.12);">
                <div class="lino-card-body" style="padding: 2rem;">
                    <div class="d-flex align-items-center mb-3">
                        <div style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                            <i class="bi bi-exclamation-triangle-fill" style="color: white; font-size: 1.25rem;"></i>
                        </div>
                        <div>
                            <h4 style="color: var(--lino-primary); font-weight: 700; margin-bottom: 0.25rem;">
                                Alertas Cr√≠ticas
                            </h4>
                            <p class="text-muted mb-0" style="font-size: 0.875rem;">
                                {{ total_alertas }} alerta{{ total_alertas|pluralize:",s" }} requieren atenci√≥n
                            </p>
                        </div>
                    </div>

                    <div class="row g-3">
                        {% for alerta in analytics.alertas %}
                        <div class="col-md-6">
                            <div class="alerta-card alerta-{% if alerta.severidad == 'critica' %}critica{% elif alerta.severidad == 'alta' %}alta{% else %}media{% endif %}" style="padding: 1.25rem; border-radius: 12px;">
                                <div class="d-flex align-items-start">
                                    <div class="me-3">
                                        {% if alerta.severidad == 'critica' %}
                                        <i class="bi bi-x-circle-fill" style="color: #dc3545; font-size: 1.5rem;"></i>
                                        {% elif alerta.severidad == 'alta' %}
                                        <i class="bi bi-exclamation-circle-fill" style="color: #ffc107; font-size: 1.5rem;"></i>
                                        {% else %}
                                        <i class="bi bi-info-circle-fill" style="color: #17a2b8; font-size: 1.5rem;"></i>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 style="font-weight: 600; margin-bottom: 0.5rem;">{{ alerta.tipo|title }}</h6>
                                        <p class="mb-2" style="font-size: 0.875rem;">{{ alerta.mensaje }}</p>
                                        {% if alerta.producto %}
                                        <div class="d-flex flex-wrap gap-2 mt-2">
                                            <span class="badge bg-secondary">{{ alerta.producto }}</span>
                                            {% if alerta.valor_actual %}
                                            <span class="badge bg-light text-dark">Actual: {{ alerta.valor_actual }}</span>
                                            {% endif %}
                                            {% if alerta.recomendacion %}
                                            <span class="badge" style="background: var(--lino-primary); color: white;">‚Üí {{ alerta.recomendacion }}</span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- üìà Gr√°ficos -->
    <div class="row g-4 mb-4">
        <!-- Distribuci√≥n de M√°rgenes -->
        <div class="col-lg-6">
            <div class="lino-card" style="border: none; border-radius: 16px; box-shadow: 0 2px 12px rgba(74, 92, 58, 0.08);">
                <div class="lino-card-body" style="padding: 2rem;">
                    <h5 style="color: var(--lino-primary); font-weight: 700; margin-bottom: 1.5rem;">
                        <i class="bi bi-pie-chart me-2"></i>Distribuci√≥n de M√°rgenes
                    </h5>
                    <div class="chart-container">
                        <canvas id="margenesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Productos por Margen -->
        <div class="col-lg-6">
            <div class="lino-card" style="border: none; border-radius: 16px; box-shadow: 0 2px 12px rgba(74, 92, 58, 0.08);">
                <div class="lino-card-body" style="padding: 2rem;">
                    <h5 style="color: var(--lino-primary); font-weight: 700; margin-bottom: 1.5rem;">
                        <i class="bi bi-bar-chart me-2"></i>Top 10 Productos por Margen
                    </h5>
                    <div class="chart-container">
                        <canvas id="topProductosChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- üìã Listado de Productos por Rentabilidad -->
    <div class="row">
        <div class="col-12">
            <div class="lino-card" style="border: none; border-radius: 16px; box-shadow: 0 2px 12px rgba(74, 92, 58, 0.08);">
                <div class="lino-card-body" style="padding: 2rem;">
                    <h5 style="color: var(--lino-primary); font-weight: 700; margin-bottom: 1.5rem;">
                        <i class="bi bi-list-check me-2"></i>Detalle de Productos
                    </h5>
                    
                    {% for producto_data in analytics.productos_rentabilidad %}
                    <div class="producto-row">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <h6 style="font-weight: 600; margin-bottom: 0.25rem;">
                                    {{ producto_data.producto.nombre }}
                                </h6>
                                <small class="text-muted">SKU: {{ producto_data.producto.id }}</small>
                            </div>
                            <div class="col-md-2 text-center">
                                <small class="text-muted d-block">Costo</small>
                                <strong style="color: var(--lino-primary);">${{ producto_data.costo_actual|floatformat:2 }}</strong>
                            </div>
                            <div class="col-md-2 text-center">
                                <small class="text-muted d-block">Precio</small>
                                <strong>${{ producto_data.precio_actual|floatformat:2 }}</strong>
                            </div>
                            <div class="col-md-2 text-center">
                                <small class="text-muted d-block">Margen</small>
                                <strong class="{% if producto_data.margen_porcentaje < 0 %}text-danger{% elif producto_data.margen_porcentaje < 10 %}text-warning{% else %}text-success{% endif %}">
                                    {{ producto_data.margen_porcentaje|floatformat:1 }}%
                                </strong>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="badge-margen badge-{% if producto_data.en_perdida %}perdida{% elif producto_data.estado == 'critico' %}critico{% elif producto_data.estado == 'bajo' %}bajo{% elif producto_data.estado == 'aceptable' %}aceptable{% else %}optimo{% endif %}">
                                    {% if producto_data.en_perdida %}‚õî P√©rdida
                                    {% elif producto_data.estado == 'critico' %}‚ö†Ô∏è Cr√≠tico
                                    {% elif producto_data.estado == 'bajo' %}üìä Bajo
                                    {% elif producto_data.estado == 'aceptable' %}‚úÖ Aceptable
                                    {% else %}üèÜ √ìptimo{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-inbox" style="font-size: 4rem; opacity: 0.2;"></i>
                        <p class="mt-3">No hay productos para analizar</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
// Gr√°fico de distribuci√≥n de m√°rgenes
const margenesCtx = document.getElementById('margenesChart').getContext('2d');
new Chart(margenesCtx, {
    type: 'doughnut',
    data: {
        labels: {{ margenes_labels|safe }},
        datasets: [{
            data: {{ margenes_data|safe }},
            backgroundColor: [
                '#dc3545',  // P√©rdida - rojo
                '#ffc107',  // Cr√≠tico - amarillo
                '#17a2b8',  // Bajo - azul
                '#28a745',  // Aceptable - verde
                '#4a5c3a'   // √ìptimo - verde oliva
            ],
            borderWidth: 2,
            borderColor: '#ffffff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    font: {
                        size: 12,
                        family: "'Inter', sans-serif"
                    }
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed + ' productos';
                    }
                }
            }
        }
    }
});

// Gr√°fico de top productos
const topProductosCtx = document.getElementById('topProductosChart').getContext('2d');
new Chart(topProductosCtx, {
    type: 'bar',
    data: {
        labels: {{ top_margenes_labels|safe }},
        datasets: [{
            label: 'Margen de Ganancia (%)',
            data: {{ top_margenes_data|safe }},
            backgroundColor: function(context) {
                const value = context.parsed.y;
                if (value < 0) return '#dc3545';
                if (value < 10) return '#ffc107';
                if (value < 20) return '#17a2b8';
                if (value < 30) return '#28a745';
                return '#4a5c3a';
            },
            borderRadius: 8,
            borderSkipped: false
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'Margen: ' + context.parsed.x.toFixed(1) + '%';
                    }
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                },
                grid: {
                    color: '#e5e7eb'
                }
            },
            y: {
                grid: {
                    display: false
                }
            }
        }
    }
});
</script>
{% endblock %}
