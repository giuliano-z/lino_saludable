{% extends 'gestion/base.html' %}
{% load static %}
{% load dietetica_tags %}

{% block title %}Nueva Receta - LINO SYS{% endblock %}

{% block extra_head %}
<style>
body {
    background-color: #fafaf9 !important;
}

.lino-loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: lino-spin 1s linear infinite;
    display: inline-block;
    margin-right: 8px;
}

@keyframes lino-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.ingrediente-item {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    transition: all 0.3s ease;
    position: relative;
    background: white;
}

.ingrediente-item:hover {
    border-color: var(--lino-primary);
    box-shadow: 0 2px 8px rgba(74, 92, 58, 0.15);
}

.ingrediente-number-badge {
    background: linear-gradient(135deg, #4a5c3a 0%, #5d7247 100%);
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block header %}{% if es_edicion %}Editar Receta{% else %}Nueva Receta{% endif %}{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 2rem 1rem;">
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <form method="post" id="recetaForm" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <!-- Informaci√≥n General -->
                <div class="lino-wizard-content" style="box-shadow: 0 4px 20px rgba(74, 92, 58, 0.1); margin-bottom: 2rem;">
                    <div style="padding: 2.5rem; background: white; border-radius: 12px;">
                        <div class="mb-4">
                            <h2 style="color: var(--lino-primary); font-weight: 700; margin-bottom: 0.5rem;">
                                <span style="font-size: 2.5rem; margin-right: 0.75rem;">ü•Ñ</span>
                                Informaci√≥n General
                            </h2>
                            <p class="text-muted" style="font-size: 0.95rem; margin-left: 3.5rem;">
                                Datos b√°sicos de la receta
                            </p>
                        </div>

                        <div class="row g-4">
                            <!-- Nombre -->
                            <div class="col-md-8">
                                <label for="nombre" class="lino-label">
                                    Nombre de la Receta
                                    <span class="text-danger">*</span>
                                </label>
                                <input type="text" 
                                       name="nombre" 
                                       id="nombre"
                                       class="lino-input"
                                       placeholder="Ej: Alfajores de maicena"
                                       required>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Nombre descriptivo de la receta
                                </small>
                            </div>

                            <!-- Estado -->
                            <div class="col-md-4">
                                <label for="activa" class="lino-label">Estado</label>
                                <select name="activa" id="activa" class="lino-input">
                                    <option value="True" selected>
                                        ‚úÖ Activa
                                    </option>
                                    <option value="False">
                                        ‚è∏Ô∏è Inactiva
                                    </option>
                                </select>
                            </div>

                            <!-- Descripci√≥n -->
                            <div class="col-12">
                                <label for="descripcion" class="lino-label">Descripci√≥n</label>
                                <textarea name="descripcion" 
                                          id="descripcion"
                                          class="lino-input" 
                                          rows="3" 
                                          placeholder="Instrucciones, notas especiales..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ingredientes -->
                <div class="lino-wizard-content" style="box-shadow: 0 4px 20px rgba(74, 92, 58, 0.1); margin-bottom: 2rem;">
                    <div style="padding: 2.5rem; background: white; border-radius: 12px;">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h2 style="color: var(--lino-primary); font-weight: 700; margin-bottom: 0.5rem;">
                                    <span style="font-size: 2.5rem; margin-right: 0.75rem;">üß∫</span>
                                    Ingredientes
                                </h2>
                                <p class="text-muted" style="font-size: 0.95rem; margin-left: 3.5rem; margin-bottom: 0;">
                                    <span id="totalIngredientesText">0 ingredientes</span> agregados
                                </p>
                            </div>
                            <button type="button" 
                                    class="lino-btn lino-btn-primary lino-btn-lg" 
                                    onclick="agregarIngrediente()">
                                <i class="bi bi-plus-circle me-2"></i>Agregar Ingrediente
                            </button>
                        </div>

                        <div id="ingredientesContainer">
                            <!-- Los ingredientes se agregar√°n aqu√≠ din√°micamente -->
                        </div>

                        <!-- Mensaje cuando no hay ingredientes -->
                        <div id="emptyMessage" class="text-center text-muted py-5">
                            <i class="bi bi-basket" style="font-size: 4rem; opacity: 0.2; color: var(--lino-primary);"></i>
                            <p class="mt-3 mb-1" style="font-size: 1.1rem; font-weight: 500;">No hay ingredientes agregados</p>
                            <p class="small">Haz clic en "Agregar Ingrediente" para comenzar</p>
                        </div>

                        <!-- Resumen de Costo -->
                        <div id="costoResumen" style="display: none; background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-radius: 12px; padding: 1.5rem; margin-top: 1.5rem;">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h6 style="color: var(--lino-primary); font-weight: 600; margin-bottom: 0.25rem;">
                                        <i class="bi bi-calculator-fill"></i> Costo Total de la Receta
                                    </h6>
                                    <p class="small text-muted mb-0">Suma de todos los ingredientes</p>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <h2 id="costoTotal" style="color: var(--lino-success); font-weight: 700; margin-bottom: 0;">$0.00</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones -->
                <div class="d-flex justify-content-between" style="margin-top: 2.5rem; padding-top: 2rem; border-top: 2px solid #e5e7eb;">
                    <a href="{% url 'gestion:lista_recetas' %}" class="lino-btn lino-btn-ghost lino-btn-lg">
                        <i class="bi bi-x-circle me-2"></i> Cancelar
                    </a>
                    <button type="submit" class="lino-btn lino-btn-primary lino-btn-lg" id="btnSubmit">
                        <i class="bi bi-check-circle me-2"></i> Guardar Receta
                    </button>
                </div>
            </form>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-3">
            <div class="lino-wizard-content" style="box-shadow: 0 2px 12px rgba(74, 92, 58, 0.08); position: sticky; top: 20px;">
                <div style="padding: 1.5rem; background: white; border-radius: 12px;">
                    <h6 style="color: var(--lino-primary); font-weight: 600; margin-bottom: 1rem;">
                        <i class="bi bi-lightbulb-fill" style="color: #f59e0b;"></i> Consejos √ötiles
                    </h6>
                    <ul class="small text-muted mb-0" style="padding-left: 20px; line-height: 1.8;">
                        <li><strong>Ingredientes:</strong> Agrega todas las materias primas necesarias</li>
                        <li><strong>Cantidades:</strong> Usa las unidades correctas seg√∫n cada materia prima</li>
                        <li><strong>Costo autom√°tico:</strong> Se calcula sumando todos los ingredientes</li>
                        <li><strong>Productos:</strong> Asocia los productos que usan esta receta (opcional)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template para nuevo ingrediente (oculto) -->
<template id="ingredienteTemplate">
    <div class="ingrediente-item p-4 mb-3" style="background: white; border-radius: 12px;" data-index="__INDEX__">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div class="d-flex align-items-center">
                <span class="ingrediente-number-badge me-2">__NUMBER__</span>
                <h6 class="mb-0">Ingrediente</h6>
            </div>
            <button type="button" 
                    class="btn btn-sm btn-danger" 
                    onclick="eliminarIngrediente(__INDEX__)">
                <i class="bi bi-trash"></i>
            </button>
        </div>

        <div class="row g-3">
            <!-- Materia Prima -->
            <div class="col-12">
                <label class="lino-label">
                    Materia Prima
                    <span class="text-danger">*</span>
                </label>
                <select name="ingredientes[__INDEX__][materia_prima_id]" 
                        class="lino-input materia-select" 
                        data-index="__INDEX__"
                        onchange="actualizarCostoIngrediente(__INDEX__)"
                        required>
                    <option value="">Seleccione una materia prima...</option>
                    {% for materia in materias_primas %}
                    <option value="{{ materia.id }}" 
                            data-unidad="{{ materia.get_unidad_medida_display }}"
                            data-unidad-code="{{ materia.unidad_medida }}"
                            data-costo="{{ materia.costo_unitario|default:'0' }}">
                        {{ materia.nombre }} - ${{ materia.costo_unitario|default:"0"|floatformat:2 }}/{{ materia.get_unidad_medida_display }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Cantidad y Costo -->
            <div class="col-md-6">
                <label class="lino-label">
                    Cantidad
                    <span class="text-danger">*</span>
                    <span class="unidad-label" data-index="__INDEX__" style="color: var(--lino-primary); font-weight: 600;"></span>
                </label>
                <input type="number" 
                       name="ingredientes[__INDEX__][cantidad]" 
                       class="lino-input cantidad-input"
                       data-index="__INDEX__"
                       min="0.001" 
                       step="0.001"
                       placeholder="0.000"
                       oninput="actualizarCostoIngrediente(__INDEX__)"
                       required>
                <small class="text-muted unidad-display" data-index="__INDEX__">
                    <i class="bi bi-info-circle"></i> Cantidad necesaria
                </small>
            </div>

            <div class="col-md-6">
                <label class="lino-label">üí∞ Costo</label>
                <div class="lino-input costo-ingrediente" 
                     data-index="__INDEX__"
                     style="background-color: #f8f9fa; cursor: not-allowed; font-weight: 600; font-size: 1rem;">
                    <em class="text-muted" style="font-weight: 400;">$0.00</em>
                </div>
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Cantidad √ó Precio unit.
                </small>
            </div>

            <!-- Notas (opcional) -->
            <div class="col-12">
                <label class="lino-label">Notas <span class="text-muted small">(opcional)</span></label>
                <input type="text" 
                       name="ingredientes[__INDEX__][notas]" 
                       class="lino-input"
                       placeholder="Ej: Bien batido, temperatura ambiente...">
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
let ingredienteIndex = 0;

// Datos de materias primas
const materiasPrimasData = {
    {% for materia in materias_primas %}
    '{{ materia.id }}': {
        'nombre': '{{ materia.nombre|escapejs }}',
        'unidad': '{{ materia.get_unidad_medida_display|escapejs }}',
        'unidad_code': '{{ materia.unidad_medida|escapejs }}',
        'costo': {{ materia.costo_unitario|default:0 }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

console.log('Materias Primas cargadas:', materiasPrimasData);

// Agregar nuevo ingrediente
function agregarIngrediente() {
    const template = document.getElementById('ingredienteTemplate');
    const container = document.getElementById('ingredientesContainer');
    const emptyMessage = document.getElementById('emptyMessage');
    
    if (!template || !container) {
        console.error('Template o container no encontrado');
        return;
    }
    
    // Clonar template
    let html = template.innerHTML;
    html = html.replace(/__INDEX__/g, ingredienteIndex);
    html = html.replace(/__NUMBER__/g, ingredienteIndex + 1);
    
    // Agregar al container
    const div = document.createElement('div');
    div.innerHTML = html;
    container.appendChild(div.firstElementChild);
    
    // Ocultar mensaje vac√≠o
    if (emptyMessage) {
        emptyMessage.style.display = 'none';
    }
    
    ingredienteIndex++;
    actualizarResumen();
}

// Eliminar ingrediente
function eliminarIngrediente(index) {
    const item = document.querySelector(`.ingrediente-item[data-index="${index}"]`);
    if (item) {
        item.style.transition = 'all 0.3s ease';
        item.style.opacity = '0';
        item.style.transform = 'translateX(20px)';
        
        setTimeout(() => {
            item.remove();
            actualizarResumen();
            
            const container = document.getElementById('ingredientesContainer');
            const emptyMessage = document.getElementById('emptyMessage');
            if (container && container.children.length === 0 && emptyMessage) {
                emptyMessage.style.display = 'block';
            }
            
            renumerarIngredientes();
        }, 300);
    }
}

// Actualizar costo al seleccionar materia prima o cambiar cantidad
function actualizarCostoIngrediente(index) {
    const select = document.querySelector(`select[name="ingredientes[${index}][materia_prima_id]"]`);
    const cantidadInput = document.querySelector(`input[name="ingredientes[${index}][cantidad]"]`);
    const costoDisplay = document.querySelector(`.costo-ingrediente[data-index="${index}"]`);
    const unidadDisplay = document.querySelector(`.unidad-display[data-index="${index}"]`);
    const unidadLabel = document.querySelector(`.unidad-label[data-index="${index}"]`);
    
    if (select && select.selectedIndex > 0) {
        const option = select.options[select.selectedIndex];
        const costoUnitario = parseFloat(option.dataset.costo) || 0;
        const unidad = option.dataset.unidad;
        const cantidad = parseFloat(cantidadInput?.value) || 0;
        
        // Update labels
        if (unidadLabel) {
            unidadLabel.textContent = `(${unidad})`;
        }
        if (unidadDisplay) {
            unidadDisplay.innerHTML = `<i class="bi bi-info-circle"></i> Cantidad en <strong>${unidad}</strong>`;
        }
        
        // Calculate cost
        const costoTotal = cantidad * costoUnitario;
        if (costoTotal > 0 && costoDisplay) {
            costoDisplay.textContent = `$${costoTotal.toFixed(2)}`;
            costoDisplay.style.fontWeight = '700';
            costoDisplay.style.color = 'var(--lino-success)';
        } else if (costoDisplay) {
            costoDisplay.innerHTML = '<em class="text-muted" style="font-weight: 400;">$0.00</em>';
        }
        
        actualizarResumen();
    }
}

// Actualizar resumen
function actualizarResumen() {
    const items = document.querySelectorAll('.ingrediente-item');
    let costoTotal = 0;
    let count = 0;
    
    items.forEach(item => {
        const index = item.dataset.index;
        const select = document.querySelector(`select[name="ingredientes[${index}][materia_prima_id]"]`);
        const cantidadInput = document.querySelector(`input[name="ingredientes[${index}][cantidad]"]`);
        
        if (select && select.selectedIndex > 0 && cantidadInput) {
            const option = select.options[select.selectedIndex];
            const costoUnitario = parseFloat(option.dataset.costo) || 0;
            const cantidad = parseFloat(cantidadInput.value) || 0;
            
            if (cantidad > 0) {
                costoTotal += cantidad * costoUnitario;
                count++;
            }
        }
    });
    
    const costoTotalElement = document.getElementById('costoTotal');
    const totalIngredientesText = document.getElementById('totalIngredientesText');
    const costoResumen = document.getElementById('costoResumen');
    
    if (costoTotalElement) {
        costoTotalElement.textContent = `$${costoTotal.toFixed(2)}`;
    }
    
    if (totalIngredientesText) {
        totalIngredientesText.textContent = `${count} ingrediente${count !== 1 ? 's' : ''}`;
    }
    
    if (costoResumen) {
        costoResumen.style.display = count > 0 ? 'block' : 'none';
    }
}

// Renumerar ingredientes
function renumerarIngredientes() {
    const items = document.querySelectorAll('.ingrediente-item');
    items.forEach((item, idx) => {
        const numero = item.querySelector('.ingrediente-number-badge');
        if (numero) {
            numero.textContent = idx + 1;
        }
    });
}

// Submit handler
const form = document.getElementById('recetaForm');
const btnSubmit = document.getElementById('btnSubmit');

if (form) {
    form.addEventListener('submit', function(e) {
        const ingredientes = document.querySelectorAll('.ingrediente-item');
        
        if (ingredientes.length === 0) {
            e.preventDefault();
            alert('‚ùå Debe agregar al menos un ingrediente a la receta');
            return false;
        }
        
        // Validar ingredientes
        let valido = true;
        ingredientes.forEach(item => {
            const index = item.dataset.index;
            const select = document.querySelector(`select[name="ingredientes[${index}][materia_prima_id]"]`);
            const cantidad = document.querySelector(`input[name="ingredientes[${index}][cantidad]"]`);
            
            if (!select || !select.value || !cantidad || parseFloat(cantidad.value) <= 0) {
                valido = false;
            }
        });
        
        if (!valido) {
            e.preventDefault();
            alert('‚ùå Todos los ingredientes deben tener materia prima y cantidad v√°lida');
            return false;
        }
        
        // Loading state
        if (btnSubmit) {
            btnSubmit.innerHTML = '<span class="lino-loading-spinner"></span> Guardando...';
            btnSubmit.disabled = true;
        }
    });
}

// Agregar primer ingrediente al cargar
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');
    
    {% if es_edicion and ingredientes_actuales %}
    // Cargar ingredientes existentes
    console.log('Cargando ingredientes existentes...');
    const ingredientesExistentes = {{ ingredientes_actuales|safe }};
    
    ingredientesExistentes.forEach(function(ing) {
        agregarIngrediente();
        const ultimoIndex = ingredienteIndex - 1;
        
        // Esperar a que el elemento est√© en el DOM
        setTimeout(function() {
            const select = document.querySelector(`select[name="ingredientes[${ultimoIndex}][materia_prima_id]"]`);
            const cantidad = document.querySelector(`input[name="ingredientes[${ultimoIndex}][cantidad]"]`);
            
            if (select && cantidad) {
                select.value = ing.materia_prima_id;
                cantidad.value = ing.cantidad;
                
                // Trigger change para actualizar costo
                const event = new Event('change');
                select.dispatchEvent(event);
            }
        }, 100);
    });
    {% else %}
    // Agregar primer ingrediente vac√≠o
    console.log('Agregando primer ingrediente vac√≠o');
    agregarIngrediente();
    {% endif %}
});
</script>
{% endblock %}
