{% extends 'gestion/base.html' %}
{% load dietetica_tags %}

{% block title %}Materias Primas - LINO SYS{% endblock %}

{% block header %}
<div class="page-header d-flex justify-content-between align-items-center">
    <span>Materias Primas - Sistema LINO</span>
    <div class="d-flex gap-2">
        {% lino_badge "ACTIVO" "success" "lg" "bi-check-circle" %}
    </div>
</div>
{% endblock %}

{% block content %}

<!-- KPIs de Materias Primas -->
<div class="lino-grid lino-grid--4-col mb-5">
    {% lino_kpi_card "Total Materias Primas" materias_primas|length "Registradas" "bi-box" "olive" %}
    {% lino_kpi_card "Stock Cr칤tico" "0" "Requieren reposici칩n" "bi-exclamation-triangle" "warning" %}
    {% lino_kpi_card "Sin Stock" "0" "Agotadas" "bi-x-circle" "danger" %}
    {% lino_kpi_card "Valor Total" "$0" "Inventario valorizado" "bi-currency-dollar" "success" %}
</div>

<!-- Filtros -->
<div class="row g-4 mb-5">
    <div class="col-lg-8">
        <div class="lino-card">
            {% lino_card_header "Filtros de B칰squeda" "bi-funnel" "olive" %}
            
            <div class="lino-card-content">
                <form method="get" id="filtrosForm">
                    <div class="lino-grid lino-grid--3-col">
                        <div>
                            <label for="q" class="form-label fw-medium">Buscar materia prima</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    {% lino_icon "bi-search" "text-muted" %}
                                </span>
                                <input type="text" class="form-control border-start-0" id="q" name="q" 
                                       value="{{ query|default:'' }}" placeholder="Nombre de la materia prima...">
                            </div>
                        </div>
                        <div>
                            <label for="unidad" class="form-label fw-medium">Unidad de Medida</label>
                            <select class="form-select" id="unidad" name="unidad">
                                <option value="">Todas las unidades</option>
                                <option value="kg" {% if unidad_seleccionada == 'kg' %}selected{% endif %}>Kilogramos</option>
                                <option value="g" {% if unidad_seleccionada == 'g' %}selected{% endif %}>Gramos</option>
                                <option value="l" {% if unidad_seleccionada == 'l' %}selected{% endif %}>Litros</option>
                                <option value="ml" {% if unidad_seleccionada == 'ml' %}selected{% endif %}>Mililitros</option>
                                <option value="unidad" {% if unidad_seleccionada == 'unidad' %}selected{% endif %}>Unidades</option>
                            </select>
                        </div>
                        <div>
                            <label for="estado" class="form-label fw-medium">Estado del Stock</label>
                            <select class="form-select" id="estado" name="estado">
                                <option value="">Todos los estados</option>
                                <option value="critico" {% if estado_seleccionado == 'critico' %}selected{% endif %}>游리 Stock Cr칤tico</option>
                                <option value="agotado" {% if estado_seleccionado == 'agotado' %}selected{% endif %}>游댮 Agotado</option>
                                <option value="normal" {% if estado_seleccionado == 'normal' %}selected{% endif %}>游릭 Normal</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-4">
                        <button type="submit" class="btn btn-primary">
                            {% lino_icon "bi-funnel" "me-2" %} Aplicar Filtros
                        </button>
                        {% url 'gestion:lista_materias_primas' as url_limpiar %}
                        <a href="{{ url_limpiar }}" class="btn btn-outline-secondary">
                            {% lino_icon "bi-arrow-clockwise" "me-2" %} Limpiar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="lino-card">
            {% lino_card_header "Acciones R치pidas" "bi-lightning" "green" %}
            
            <div class="lino-card-content">
                <div class="d-grid gap-3">
                    {% url 'gestion:crear_materia_prima' as url_crear %}
                    <a href="{{ url_crear }}" class="btn btn-primary btn-lg">
                        {% lino_icon "bi-plus-circle" "me-2" %} Nueva Materia Prima
                    </a>
                    <a href="#" class="btn btn-success">
                        {% lino_icon "bi-download" "me-2" %} Exportar Lista
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Materias Primas -->
<div class="lino-grid lino-grid--3-col mb-4">
    {% for materia in materias_primas %}
    <div class="lino-card hover-card">
        {% lino_card_header materia.nombre "bi-box" "olive" %}
        
        <div class="lino-card-content">
            {% if materia.descripcion %}
                <p class="text-muted small mb-3">{{ materia.descripcion|truncatechars:60 }}</p>
            {% endif %}
            
            <!-- Informaci칩n principal -->
            <div class="row g-3 mb-3">
                <div class="col-6">
                    {% lino_value_box materia.costo_unitario|floatformat:2 "Costo Unitario" "success" "sm" %}
                </div>
                <div class="col-6">
                    {% lino_value_box materia.stock_actual|floatformat:1 "Stock Actual" "primary" "sm" %}
                </div>
            </div>
            
            <!-- Unidad de medida -->
            <div class="mb-3">
                {% lino_badge materia.get_unidad_medida_display "olive" "md" "bi-rulers" %}
            </div>
            
            <!-- Estado del stock -->
            <div class="mb-3">
                {% if materia.necesita_restock %}
                    {% lino_badge "Stock Cr칤tico" "warning" "lg" "bi-exclamation-triangle" %}
                {% else %}
                    {% lino_badge "Stock Normal" "success" "lg" "bi-check-circle" %}
                {% endif %}
            </div>
            
            <!-- Stock m칤nimo -->
            {% lino_info_section "Stock M칤nimo" "bi-bar-chart" "earth" %}
            <div class="lino-info-section__content">
                <span class="fw-medium">{{ materia.stock_minimo|floatformat:1 }} {{ materia.get_unidad_medida_display }}</span>
            </div>
            
            <!-- Proveedor -->
            {% if materia.proveedor %}
            {% lino_info_section "Proveedor" "bi-building" "brown" %}
            <div class="lino-info-section__content">
                <span class="fw-medium">{{ materia.proveedor }}</span>
            </div>
            {% endif %}
            
            <!-- Valor total -->
            {% lino_info_section "Valor Total" "bi-currency-dollar" "green" %}
            <div class="lino-info-section__content">
                <span class="fw-medium">${{ materia.valor_total_stock|floatformat:2 }}</span>
            </div>
            
            <!-- Acciones -->
            <div class="border-top pt-3 mt-3">
                <div class="d-flex gap-2">
                    {% url 'gestion:editar_materia_prima' materia.id as url_editar %}
                    <a href="{{ url_editar }}" class="btn btn-primary btn-sm">
                        {% lino_icon "bi-pencil" "me-1" %} Editar
                    </a>
                    {% url 'gestion:detalle_materia_prima' materia.id as url_detalle %}
                    <a href="{{ url_detalle }}" class="btn btn-info btn-sm">
                        {% lino_icon "bi-eye" "me-1" %} Ver
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="lino-card text-center py-5">
            <div class="lino-card-content">
                {% if query or unidad_seleccionada or estado_seleccionado %}
                    {% lino_icon "bi-search" "text-muted opacity-50 mb-3" %}
                    <h5 class="text-muted">No se encontraron materias primas</h5>
                    <p class="text-muted mb-4">No hay materias primas que coincidan con los filtros aplicados</p>
                    {% url 'gestion:lista_materias_primas' as url_ver_todos %}
                    <a href="{{ url_ver_todos }}" class="btn btn-outline-primary">
                        {% lino_icon "bi-arrow-clockwise" "me-2" %} Ver todas las materias primas
                    </a>
                {% else %}
                    {% lino_icon "bi-box" "text-muted opacity-50 mb-3" %}
                    <h5 class="text-muted">No hay materias primas registradas</h5>
                    <p class="text-muted mb-4">Agrega tu primera materia prima al inventario</p>
                    {% url 'gestion:crear_materia_prima' as url_agregar %}
                    <a href="{{ url_agregar }}" class="btn btn-primary btn-lg">
                        {% lino_icon "bi-plus-circle" "me-2" %} Agregar Materia Prima
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% endblock %}
