{% extends 'gestion/base.html' %}
{% load dietetica_tags %}

{% block title %}Crear Materia Prima - LINO SYS{% endblock %}

{% block header %}
<div class="lino-page-header">
    <div class="lino-page-header__content">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb lino-breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'gestion:panel_control' %}">
                        <i class="bi bi-house-door"></i> Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'gestion:lista_materias_primas' %}">
                        <i class="bi bi-archive"></i> Materias Primas
                    </a>
                </li>
                <li class="breadcrumb-item active">Nueva Materia Prima</li>
            </ol>
        </nav>
        <h1 class="lino-page-header__title">
            <i class="bi bi-plus-circle me-2"></i>Nueva Materia Prima
        </h1>
        <p class="lino-page-header__subtitle">Complete los datos para registrar una nueva materia prima en el sistema</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Action Buttons -->
    <div class="lino-toolbar mb-4">
        <a href="{% url 'gestion:lista_materias_primas' %}" class="lino-btn lino-btn--secondary">
            <i class="bi bi-arrow-left"></i>
            <span>Volver al Listado</span>
        </a>
        <button type="submit" form="form-materia-prima" class="lino-btn lino-btn--primary">
            <i class="bi bi-save"></i>
            <span>Guardar Materia Prima</span>
        </button>
    </div>

    <!-- Main Form Card -->
    <div class="row">
        <div class="col-12">
            <div class="lino-card">
                <div class="lino-card__header">
                    <h3 class="lino-card__title">
                        <i class="bi bi-box2 me-2"></i>Datos de la Materia Prima
                    </h3>
                </div>
                <div class="lino-card__body">
                    <form method="post" id="form-materia-prima" class="lino-form" novalidate>
                        {% csrf_token %}
                        
                        <!-- Sección: Información Básica -->
                        <div class="lino-form-section mb-4">
                            <h5 class="lino-form-section__title">
                                <i class="bi bi-info-circle me-2"></i>Información Básica
                            </h5>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="lino-form-group">
                                        <label for="{{ form.nombre.id_for_label }}" class="lino-form-label lino-form-label--required">
                                            {{ form.nombre.label }}
                                        </label>
                                        <div class="lino-input-group">
                                            <span class="lino-input-group__prepend">
                                                <i class="bi bi-box2"></i>
                                            </span>
                                            {{ form.nombre }}
                                        </div>
                                        {% if form.nombre.errors %}
                                            <div class="lino-form-error">{{ form.nombre.errors.0 }}</div>
                                        {% endif %}
                                        <small class="lino-form-help">Nombre descriptivo de la materia prima</small>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="lino-form-group">
                                        <label for="{{ form.unidad_medida.id_for_label }}" class="lino-form-label lino-form-label--required">
                                            {{ form.unidad_medida.label }}
                                        </label>
                                        <div class="lino-input-group">
                                            <span class="lino-input-group__prepend">
                                                <i class="bi bi-rulers"></i>
                                            </span>
                                            {{ form.unidad_medida }}
                                        </div>
                                        {% if form.unidad_medida.errors %}
                                            <div class="lino-form-error">{{ form.unidad_medida.errors.0 }}</div>
                                        {% endif %}
                                        <small class="lino-form-help">Unidad de medida (kg, g, L, etc.)</small>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="lino-form-group">
                                        <label for="{{ form.descripcion.id_for_label }}" class="lino-form-label">
                                            {{ form.descripcion.label }}
                                        </label>
                                        <div class="lino-input-group">
                                            <span class="lino-input-group__prepend">
                                                <i class="bi bi-text-paragraph"></i>
                                            </span>
                                            {{ form.descripcion }}
                                        </div>
                                        {% if form.descripcion.errors %}
                                            <div class="lino-form-error">{{ form.descripcion.errors.0 }}</div>
                                        {% endif %}
                                        <small class="lino-form-help">Descripción detallada (opcional)</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección: Control de Stock -->
                        <div class="lino-form-section mb-4">
                            <h5 class="lino-form-section__title">
                                <i class="bi bi-graph-up me-2"></i>Control de Stock
                            </h5>
                            
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="lino-form-group">
                                        <label for="{{ form.stock_actual.id_for_label }}" class="lino-form-label lino-form-label--required">
                                            {{ form.stock_actual.label }}
                                        </label>
                                        <div class="lino-input-group">
                                            <span class="lino-input-group__prepend">
                                                <i class="bi bi-box"></i>
                                            </span>
                                            {{ form.stock_actual }}
                                        </div>
                                        {% if form.stock_actual.errors %}
                                            <div class="lino-form-error">{{ form.stock_actual.errors.0 }}</div>
                                        {% endif %}
                                        <small class="lino-form-help">Cantidad disponible actual</small>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="lino-form-group">
                                        <label for="{{ form.stock_minimo.id_for_label }}" class="lino-form-label lino-form-label--required">
                                            {{ form.stock_minimo.label }}
                                        </label>
                                        <div class="lino-input-group">
                                            <span class="lino-input-group__prepend">
                                                <i class="bi bi-exclamation-triangle"></i>
                                            </span>
                                            {{ form.stock_minimo }}
                                        </div>
                                        {% if form.stock_minimo.errors %}
                                            <div class="lino-form-error">{{ form.stock_minimo.errors.0 }}</div>
                                        {% endif %}
                                        <small class="lino-form-help">Alerta de stock bajo</small>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="lino-form-group">
                                        <label for="{{ form.costo_unitario.id_for_label }}" class="lino-form-label lino-form-label--required">
                                            {{ form.costo_unitario.label }}
                                        </label>
                                        <div class="lino-input-group">
                                            <span class="lino-input-group__prepend">
                                                <i class="bi bi-currency-dollar"></i>
                                            </span>
                                            {{ form.costo_unitario }}
                                        </div>
                                        {% if form.costo_unitario.errors %}
                                            <div class="lino-form-error">{{ form.costo_unitario.errors.0 }}</div>
                                        {% endif %}
                                        <small class="lino-form-help">Costo por unidad de medida</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Alerta de Stock -->
                            <div class="lino-alert lino-alert--info mt-3">
                                <div class="lino-alert__content">
                                    <i class="bi bi-info-circle lino-alert__icon"></i>
                                    <div class="lino-alert__text">
                                        <strong>Nota:</strong> Se generará una alerta automática cuando el stock actual sea menor o igual al stock mínimo configurado.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección: Información Comercial -->
                        <div class="lino-form-section mb-4">
                            <h5 class="lino-form-section__title">
                                <i class="bi bi-building me-2"></i>Información Comercial
                            </h5>
                            
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <div class="lino-form-group">
                                        <label for="{{ form.proveedor.id_for_label }}" class="lino-form-label">
                                            {{ form.proveedor.label }}
                                        </label>
                                        <div class="lino-input-group">
                                            <span class="lino-input-group__prepend">
                                                <i class="bi bi-truck"></i>
                                            </span>
                                            {{ form.proveedor }}
                                        </div>
                                        {% if form.proveedor.errors %}
                                            <div class="lino-form-error">{{ form.proveedor.errors.0 }}</div>
                                        {% endif %}
                                        <small class="lino-form-help">Proveedor habitual (opcional)</small>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="lino-form-group">
                                        <label for="{{ form.activo.id_for_label }}" class="lino-form-label">
                                            {{ form.activo.label }}
                                        </label>
                                        <div class="lino-switch-container">
                                            {{ form.activo }}
                                            <label for="{{ form.activo.id_for_label }}" class="lino-switch-label">
                                                <span class="lino-switch-indicator"></span>
                                                <span class="lino-switch-text">Materia prima activa</span>
                                            </label>
                                        </div>
                                        {% if form.activo.errors %}
                                            <div class="lino-form-error">{{ form.activo.errors.0 }}</div>
                                        {% endif %}
                                        <small class="lino-form-help">Desactivar oculta la materia prima</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="lino-form-actions">
                            <a href="{% url 'gestion:lista_materias_primas' %}" class="lino-btn lino-btn--secondary">
                                <i class="bi bi-x-circle"></i>
                                <span>Cancelar</span>
                            </a>
                            <button type="submit" class="lino-btn lino-btn--primary">
                                <i class="bi bi-check-circle"></i>
                                <span>Guardar Materia Prima</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript de Validación -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('form-materia-prima');
    const stockActual = document.querySelector('[name="stock_actual"]');
    const stockMinimo = document.querySelector('[name="stock_minimo"]');
    
    // Validación en tiempo real de stock
    if (stockActual && stockMinimo) {
        function validarStock() {
            const actual = parseFloat(stockActual.value) || 0;
            const minimo = parseFloat(stockMinimo.value) || 0;
            
            // Remover alertas previas
            const alertaExistente = form.querySelector('.lino-alert--warning');
            if (alertaExistente) alertaExistente.remove();
            
            if (actual > 0 && actual <= minimo) {
                const alerta = document.createElement('div');
                alerta.className = 'lino-alert lino-alert--warning mt-3';
                alerta.innerHTML = `
                    <div class="lino-alert__content">
                        <i class="bi bi-exclamation-triangle lino-alert__icon"></i>
                        <div class="lino-alert__text">
                            <strong>Advertencia:</strong> El stock actual está en nivel crítico (menor o igual al stock mínimo).
                        </div>
                    </div>
                `;
                stockMinimo.closest('.lino-form-section').appendChild(alerta);
            }
        }
        
        stockActual.addEventListener('input', validarStock);
        stockMinimo.addEventListener('input', validarStock);
    }
    
    // Validación del formulario
    form.addEventListener('submit', function(e) {
        let isValid = true;
        
        // Validar campos requeridos
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            const alerta = document.createElement('div');
            alerta.className = 'lino-alert lino-alert--danger mb-4';
            alerta.innerHTML = `
                <div class="lino-alert__content">
                    <i class="bi bi-x-circle lino-alert__icon"></i>
                    <div class="lino-alert__text">
                        <strong>Error:</strong> Por favor complete todos los campos requeridos.
                    </div>
                </div>
            `;
            form.parentElement.insertBefore(alerta, form);
            
            // Scroll al primer error
            setTimeout(() => alerta.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
            setTimeout(() => alerta.remove(), 5000);
        }
    });
});
</script>
{% endblock %}
