{% extends 'gestion/base.html' %}
{% load dietetica_tags %}

{% block title %}Editar Materia Prima - LINO SYS{% endblock %}

{% block header %}
<div class="lino-page-header">
    <div class="lino-page-header__content">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb lino-breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'gestion:panel_control' %}">
                        <i class="bi bi-house-door"></i> Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'gestion:lista_materias_primas' %}">
                        <i class="bi bi-archive"></i> Materias Primas
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'gestion:detalle_materia_prima' object.pk %}">
                        {{ object.nombre }}
                    </a>
                </li>
                <li class="breadcrumb-item active">Editar</li>
            </ol>
        </nav>
        <h1 class="lino-page-header__title">
            <i class="bi bi-pencil-square me-2"></i>Editar Materia Prima
        </h1>
        <p class="lino-page-header__subtitle">Modificar los datos de: <strong>{{ object.nombre }}</strong></p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Action Buttons -->
    <div class="lino-toolbar mb-4">
        <a href="{% url 'gestion:detalle_materia_prima' object.pk %}" class="lino-btn lino-btn--secondary">
            <i class="bi bi-arrow-left"></i>
            <span>Volver al Detalle</span>
        </a>
        <a href="{% url 'gestion:lista_materias_primas' %}" class="lino-btn lino-btn--outline-secondary">
            <i class="bi bi-list"></i>
            <span>Ir al Listado</span>
        </a>
        <button type="submit" form="form-materia-prima" class="lino-btn lino-btn--primary">
            <i class="bi bi-save"></i>
            <span>Guardar Cambios</span>
        </button>
    </div>

    <div class="row">
        <!-- Columna Principal: Formulario -->
        <div class="col-lg-8">
            <div class="lino-card">
                <div class="lino-card__header">
                    <h3 class="lino-card__title">
                        <i class="bi bi-box2 me-2"></i>Datos de la Materia Prima
                    </h3>
                </div>
                <div class="lino-card__body">
                    <form method="post" id="form-materia-prima" class="lino-form" novalidate>
                        {% csrf_token %}
                        
                        <!-- Sección: Información Básica -->
                        <div class="lino-form-section mb-4">
                            <h5 class="lino-form-section__title">
                                <i class="bi bi-info-circle me-2"></i>Información Básica
                            </h5>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="lino-form-group">
                                        <label for="{{ form.nombre.id_for_label }}" class="lino-form-label lino-form-label--required">
                                            {{ form.nombre.label }}
                                        </label>
                                        <div class="lino-input-group">
                                            <span class="lino-input-group__prepend">
                                                <i class="bi bi-box2"></i>
                                            </span>
                                            {{ form.nombre }}
                                        </div>
                                        {% if form.nombre.errors %}
                                            <div class="lino-form-error">{{ form.nombre.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="lino-form-group">
                                        <label for="{{ form.unidad_medida.id_for_label }}" class="lino-form-label lino-form-label--required">
                                            {{ form.unidad_medida.label }}
                                        </label>
                                        <div class="lino-input-group">
                                            <span class="lino-input-group__prepend">
                                                <i class="bi bi-rulers"></i>
                                            </span>
                                            {{ form.unidad_medida }}
                                        </div>
                                        {% if form.unidad_medida.errors %}
                                            <div class="lino-form-error">{{ form.unidad_medida.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="lino-form-group">
                                        <label for="{{ form.descripcion.id_for_label }}" class="lino-form-label">
                                            {{ form.descripcion.label }}
                                        </label>
                                        <div class="lino-input-group">
                                            <span class="lino-input-group__prepend">
                                                <i class="bi bi-text-paragraph"></i>
                                            </span>
                                            {{ form.descripcion }}
                                        </div>
                                        {% if form.descripcion.errors %}
                                            <div class="lino-form-error">{{ form.descripcion.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección: Control de Stock -->
                        <div class="lino-form-section mb-4">
                            <h5 class="lino-form-section__title">
                                <i class="bi bi-graph-up me-2"></i>Control de Stock
                            </h5>
                            
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="lino-form-group">
                                        <label for="{{ form.stock_actual.id_for_label }}" class="lino-form-label lino-form-label--required">
                                            {{ form.stock_actual.label }}
                                        </label>
                                        <div class="lino-input-group">
                                            <span class="lino-input-group__prepend">
                                                <i class="bi bi-box"></i>
                                            </span>
                                            {{ form.stock_actual }}
                                        </div>
                                        {% if form.stock_actual.errors %}
                                            <div class="lino-form-error">{{ form.stock_actual.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="lino-form-group">
                                        <label for="{{ form.stock_minimo.id_for_label }}" class="lino-form-label lino-form-label--required">
                                            {{ form.stock_minimo.label }}
                                        </label>
                                        <div class="lino-input-group">
                                            <span class="lino-input-group__prepend">
                                                <i class="bi bi-exclamation-triangle"></i>
                                            </span>
                                            {{ form.stock_minimo }}
                                        </div>
                                        {% if form.stock_minimo.errors %}
                                            <div class="lino-form-error">{{ form.stock_minimo.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="lino-form-group">
                                        <label for="{{ form.costo_unitario.id_for_label }}" class="lino-form-label lino-form-label--required">
                                            {{ form.costo_unitario.label }}
                                        </label>
                                        <div class="lino-input-group">
                                            <span class="lino-input-group__prepend">
                                                <i class="bi bi-currency-dollar"></i>
                                            </span>
                                            {{ form.costo_unitario }}
                                        </div>
                                        {% if form.costo_unitario.errors %}
                                            <div class="lino-form-error">{{ form.costo_unitario.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Alerta de Stock si está bajo -->
                            {% if object.stock_actual <= object.stock_minimo %}
                            <div class="lino-alert lino-alert--warning mt-3">
                                <div class="lino-alert__content">
                                    <i class="bi bi-exclamation-triangle lino-alert__icon"></i>
                                    <div class="lino-alert__text">
                                        <strong>Stock Crítico:</strong> El stock actual ({{ object.stock_actual }} {{ object.unidad_medida }}) está por debajo del mínimo ({{ object.stock_minimo }} {{ object.unidad_medida }}).
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Sección: Información Comercial -->
                        <div class="lino-form-section mb-4">
                            <h5 class="lino-form-section__title">
                                <i class="bi bi-building me-2"></i>Información Comercial
                            </h5>
                            
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <div class="lino-form-group">
                                        <label for="{{ form.proveedor.id_for_label }}" class="lino-form-label">
                                            {{ form.proveedor.label }}
                                        </label>
                                        <div class="lino-input-group">
                                            <span class="lino-input-group__prepend">
                                                <i class="bi bi-truck"></i>
                                            </span>
                                            {{ form.proveedor }}
                                        </div>
                                        {% if form.proveedor.errors %}
                                            <div class="lino-form-error">{{ form.proveedor.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="lino-form-group">
                                        <label for="{{ form.activo.id_for_label }}" class="lino-form-label">
                                            {{ form.activo.label }}
                                        </label>
                                        <div class="lino-switch-container">
                                            {{ form.activo }}
                                            <label for="{{ form.activo.id_for_label }}" class="lino-switch-label">
                                                <span class="lino-switch-indicator"></span>
                                                <span class="lino-switch-text">Activa</span>
                                            </label>
                                        </div>
                                        {% if form.activo.errors %}
                                            <div class="lino-form-error">{{ form.activo.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="lino-form-actions">
                            <a href="{% url 'gestion:detalle_materia_prima' object.pk %}" class="lino-btn lino-btn--secondary">
                                <i class="bi bi-x-circle"></i>
                                <span>Cancelar</span>
                            </a>
                            <button type="submit" class="lino-btn lino-btn--primary">
                                <i class="bi bi-check-circle"></i>
                                <span>Guardar Cambios</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Columna Lateral: Información -->
        <div class="col-lg-4">
            <!-- Card de Información -->
            <div class="lino-card mb-4">
                <div class="lino-card__header">
                    <h3 class="lino-card__title">
                        <i class="bi bi-info-circle me-2"></i>Información del Sistema
                    </h3>
                </div>
                <div class="lino-card__body">
                    <div class="lino-data-list">
                        <div class="lino-data-list__item">
                            <span class="lino-data-list__label">
                                <i class="bi bi-calendar-plus"></i> Creada
                            </span>
                            <span class="lino-data-list__value">
                                {{ object.fecha_creacion|date:"d/m/Y H:i" }}
                            </span>
                        </div>
                        <div class="lino-data-list__item">
                            <span class="lino-data-list__label">
                                <i class="bi bi-toggle-on"></i> Estado
                            </span>
                            <span class="lino-data-list__value">
                                {% if object.activo %}
                                    <span class="lino-badge lino-badge--success">Activa</span>
                                {% else %}
                                    <span class="lino-badge lino-badge--secondary">Inactiva</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card de Estadísticas de Stock -->
            <div class="lino-card">
                <div class="lino-card__header">
                    <h3 class="lino-card__title">
                        <i class="bi bi-graph-up me-2"></i>Estado de Stock
                    </h3>
                </div>
                <div class="lino-card__body">
                    <div class="lino-stat-card mb-3">
                        <div class="lino-stat-card__label">Stock Actual</div>
                        <div class="lino-stat-card__value">{{ object.stock_actual }} {{ object.unidad_medida }}</div>
                    </div>
                    <div class="lino-stat-card mb-3">
                        <div class="lino-stat-card__label">Stock Mínimo</div>
                        <div class="lino-stat-card__value">{{ object.stock_minimo }} {{ object.unidad_medida }}</div>
                    </div>
                    <div class="lino-stat-card">
                        <div class="lino-stat-card__label">Valor en Stock</div>
                        <div class="lino-stat-card__value">
                            ${% widthratio object.stock_actual 1 object.costo_unitario %}
                        </div>
                    </div>

                    <!-- Barra de Progreso de Stock -->
                    <div class="mt-3">
                        <small class="text-muted d-block mb-1">Nivel de Stock</small>
                        <div class="progress" style="height: 8px;">
                            {% widthratio object.stock_actual object.stock_minimo 100 as porcentaje %}
                            <div class="progress-bar {% if porcentaje <= 100 %}bg-danger{% elif porcentaje <= 150 %}bg-warning{% else %}bg-success{% endif %}" 
                                 role="progressbar" 
                                 style="width: {% if porcentaje > 100 %}100{% else %}{{ porcentaje }}{% endif %}%">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript de Validación -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('form-materia-prima');
    const stockActual = document.querySelector('[name="stock_actual"]');
    const stockMinimo = document.querySelector('[name="stock_minimo"]');
    
    // Validación en tiempo real de stock
    if (stockActual && stockMinimo) {
        function validarStock() {
            const actual = parseFloat(stockActual.value) || 0;
            const minimo = parseFloat(stockMinimo.value) || 0;
            
            const contenedorAlerta = document.querySelector('.lino-form-section:nth-child(2)');
            let alertaExistente = contenedorAlerta.querySelector('.lino-alert--warning.alerta-dinamica');
            
            if (actual > 0 && actual <= minimo) {
                if (!alertaExistente) {
                    const alerta = document.createElement('div');
                    alerta.className = 'lino-alert lino-alert--warning mt-3 alerta-dinamica';
                    alerta.innerHTML = `
                        <div class="lino-alert__content">
                            <i class="bi bi-exclamation-triangle lino-alert__icon"></i>
                            <div class="lino-alert__text">
                                <strong>Advertencia:</strong> El stock actual está en nivel crítico.
                            </div>
                        </div>
                    `;
                    contenedorAlerta.appendChild(alerta);
                }
            } else if (alertaExistente) {
                alertaExistente.remove();
            }
        }
        
        stockActual.addEventListener('input', validarStock);
        stockMinimo.addEventListener('input', validarStock);
    }
});
</script>
{% endblock %}
