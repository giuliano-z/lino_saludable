{% extends 'gestion/base.html' %}
{% load static %}

{% block title %}Productos - LINO Diet√©tica{% endblock %}
{% block header %}Gesti√≥n de Productos{% endblock %}

{% block extra_head %}
<style>
.product-card-transition {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.view-transition {
    opacity: 0;
    animation: fadeIn 0.3s ease forwards;
}

@keyframes fadeIn {
    to { opacity: 1; }
}

.loading-skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

/* Dashboard-style action buttons */
.lino-action-button-compact {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    border: none;
    border-radius: 10px;
    color: white;
    padding: 12px 20px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    font-weight: 600;
    font-size: 14px;
    height: 85px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
}

.lino-action-button-compact:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
    color: white;
}

/* Elegant table styling */
.lino-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.lino-table thead th {
    background: linear-gradient(135deg, #8c9c6c 0%, #a8b86b 100%) !important;
    color: white !important;
    font-weight: bold !important;
    padding: 15px !important;
    border: none !important;
}

.lino-table tbody tr {
    transition: all 0.2s ease;
}

.lino-table tbody tr:hover {
    background-color: #f8f9fa;
    transform: scale(1.01);
}

.lino-product-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-align: center;
    margin: 2px;
}

.lino-product-badge--stock-ok { background: #d4edda; color: #155724; }
.lino-product-badge--stock-low { background: #fff3cd; color: #856404; }
.lino-product-badge--stock-critical { background: #f8d7da; color: #721c24; }
.lino-product-badge--organic { background: #d1ecf1; color: #0c5460; }
.lino-product-badge--gluten-free { background: #ffeaa7; color: #6c5b00; }
.lino-product-badge--vegan { background: #a8e6cf; color: #2d5a3d; }

.lino-action-btn {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 8px 12px;
    transition: all 0.2s ease;
    text-decoration: none;
    color: #666;
}

.lino-action-btn--view:hover { border-color: #2196F3; color: #2196F3; }
.lino-action-btn--edit:hover { border-color: #FF9800; color: #FF9800; }
.lino-action-btn--delete:hover { border-color: #f44336; color: #f44336; }
</style>
{% endblock %}

{% block content %}
<div class="lino-list-container">
    <!-- HEADER CON M√âTRICAS -->
    <div class="lino-list-header">
        <div>
            <h1 class="lino-list-title">
                ü•ó Gesti√≥n de Productos
            </h1>
            <p class="lino-list-subtitle">
                Control integral de inventario diet√©tico y productos naturales
            </p>
        </div>
        
        <div class="lino-list-actions">
            <!-- Botones de acci√≥n con estilo dashboard -->
            <a href="{% url 'gestion:crear_producto' %}" class="lino-action-button-compact">
                <i class="bi bi-plus-circle me-2"></i>
                Nuevo Producto
            </a>
        </div>
    </div>

    <!-- M√âTRICAS PRINCIPALES -->
    <div class="lino-metrics-grid">
        <!-- M√©trica: Productos Disponibles -->
        <div class="lino-metric-card lino-metric-card--primary">
            <div class="lino-metric-card__icon">
                <i class="bi bi-box-seam"></i>
            </div>
            <div class="lino-metric-card__content">
                <div class="lino-metric-card__title">Productos Disponibles</div>
                <div class="lino-metric-card__value">
                    {% for producto in productos %}{% if producto.stock > 10 %}{{ forloop.counter }}{% endif %}{% endfor %}
                </div>
            </div>
        </div>

        <!-- M√©trica: Stock Cr√≠tico -->
        <div class="lino-metric-card lino-metric-card--warning">
            <div class="lino-metric-card__icon">
                <i class="bi bi-exclamation-triangle"></i>
            </div>
            <div class="lino-metric-card__content">
                <div class="lino-metric-card__title">Stock Cr√≠tico</div>
                <div class="lino-metric-card__value">
                    {% for producto in productos %}{% if producto.stock <= 5 %}{{ forloop.counter }}{% endif %}{% endfor %}
                </div>
            </div>
        </div>

        <!-- M√©trica: Valor Total -->
        <div class="lino-metric-card lino-metric-card--success">
            <div class="lino-metric-card__icon">
                <i class="bi bi-currency-dollar"></i>
            </div>
            <div class="lino-metric-card__content">
                <div class="lino-metric-card__title">Valor Total Inventario</div>
                <div class="lino-metric-card__value">$125,400</div>
            </div>
        </div>

        <!-- M√©trica: Categor√≠as -->
        <div class="lino-metric-card lino-metric-card--info">
            <div class="lino-metric-card__icon">
                <i class="bi bi-tags"></i>
            </div>
            <div class="lino-metric-card__content">
                <div class="lino-metric-card__title">Categor√≠as Activas</div>
                <div class="lino-metric-card__value">8</div>
            </div>
        </div>
    </div>

    <!-- HERRAMIENTAS Y FILTROS -->
    <div class="lino-tools-section">
        <div class="lino-tools-main">
            <!-- B√∫squeda -->
            <div class="lino-search-field">
                <i class="bi bi-search lino-search-field__icon"></i>
                <input type="text" 
                       class="lino-search-field__input" 
                       placeholder="Buscar productos por nombre, categor√≠a o c√≥digo..."
                       id="productSearch">
            </div>
            
            <!-- Filtros -->
            <div class="lino-filter-group">
                <select class="lino-filter-select" id="categoryFilter">
                    <option value="">Todas las categor√≠as</option>
                    <option value="cereales">üåæ Cereales</option>
                    <option value="proteinas">ü•© Prote√≠nas</option>
                    <option value="lacteos">ü•õ L√°cteos</option>
                    <option value="frutas">üçé Frutas</option>
                    <option value="snacks">ü•ú Snacks</option>
                    <option value="bebidas">üßÉ Bebidas</option>
                    <option value="suplementos">üíä Suplementos</option>
                </select>
                
                <select class="lino-filter-select" id="stockFilter">
                    <option value="">Todos los stocks</option>
                    <option value="disponible">Stock disponible</option>
                    <option value="bajo">Stock bajo</option>
                    <option value="critico">Stock cr√≠tico</option>
                    <option value="agotado">Agotado</option>
                </select>
            </div>
        </div>
        
        <!-- Toggle de Vista -->
        <div class="lino-view-toggle">
            <button class="lino-view-btn lino-view-btn--active" id="cardViewBtn">
                <i class="bi bi-grid-3x3-gap"></i>
                Cards
            </button>
            <button class="lino-view-btn" id="tableViewBtn">
                <i class="bi bi-table"></i>
                Tabla
            </button>
        </div>
    </div>

    <!-- VISTA CARDS -->
    <div id="cardView" class="lino-products-grid">
        {% for producto in productos %}
        <div class="lino-product-card product-card-transition"
             data-name="{{ producto.nombre|lower }}"
             data-category="{{ producto.categoria|default:'otros' }}"
             data-stock="{% if producto.stock > 10 %}disponible{% elif producto.stock > 5 %}bajo{% elif producto.stock > 0 %}critico{% else %}agotado{% endif %}">
            
            <div class="lino-product-card__header">
                <div class="lino-product-card__category">
                    {% if producto.categoria == 'cereales' %}üåæ Cereales
                    {% elif producto.categoria == 'proteinas' %}ü•© Prote√≠nas
                    {% elif producto.categoria == 'lacteos' %}ü•õ L√°cteos
                    {% elif producto.categoria == 'frutas' %}üçé Frutas
                    {% elif producto.categoria == 'snacks' %}ü•ú Snacks
                    {% elif producto.categoria == 'bebidas' %}üßÉ Bebidas
                    {% elif producto.categoria == 'suplementos' %}üíä Suplementos
                    {% else %}üì¶ Otros{% endif %}
                </div>
            </div>
            
            <div class="lino-product-card__content">
                <h3 class="lino-product-card__title">{{ producto.nombre }}</h3>
                {% if producto.descripcion %}
                    <p class="lino-product-card__description">{{ producto.descripcion|truncatechars:80 }}</p>
                {% endif %}
                
                <!-- M√©tricas del Producto -->
                <div class="lino-product-metrics">
                    <div class="lino-product-metric">
                        <div class="lino-product-metric__label">Stock</div>
                        <div class="lino-product-metric__value 
                                   {% if producto.stock > 10 %}lino-product-metric__value--stock
                                   {% elif producto.stock > 5 %}lino-product-metric__value--warning
                                   {% else %}lino-product-metric__value--critical{% endif %}">
                            {{ producto.stock }} un.
                        </div>
                    </div>
                    
                    <div class="lino-product-metric">
                        <div class="lino-product-metric__label">Precio</div>
                        <div class="lino-product-metric__value lino-product-metric__value--price">
                            ${{ producto.precio|floatformat:2 }}
                        </div>
                    </div>
                </div>
                
                <!-- Badges de Estado -->
                <div class="lino-product-badges">
                    {% if producto.stock > 10 %}
                        <span class="lino-product-badge lino-product-badge--stock-ok">‚úÖ Disponible</span>
                    {% elif producto.stock > 5 %}
                        <span class="lino-product-badge lino-product-badge--stock-low">‚ö†Ô∏è Bajo</span>
                    {% elif producto.stock > 0 %}
                        <span class="lino-product-badge lino-product-badge--stock-critical">üö® Cr√≠tico</span>
                    {% else %}
                        <span class="lino-product-badge lino-product-badge--stock-critical">‚ùå Agotado</span>
                    {% endif %}
                    
                    {% if producto.organico %}
                        <span class="lino-product-badge lino-product-badge--organic">üçÉ Org√°nico</span>
                    {% endif %}
                    {% if producto.sin_gluten %}
                        <span class="lino-product-badge lino-product-badge--gluten-free">üåæ Sin Gluten</span>
                    {% endif %}
                    {% if producto.vegano %}
                        <span class="lino-product-badge lino-product-badge--vegan">üå± Vegano</span>
                    {% endif %}
                </div>
                
                <!-- Informaci√≥n Nutricional -->
                {% if producto.calorias %}
                <div class="lino-product-nutrition">
                    <div class="lino-product-nutrition__title">Info Nutricional</div>
                    <div class="lino-product-nutrition__values">
                        üî• {{ producto.calorias }} cal/100g
                        {% if producto.proteinas %} ‚Ä¢ ü•© {{ producto.proteinas }}g prot{% endif %}
                        {% if producto.fibra %} ‚Ä¢ üåø {{ producto.fibra }}g fibra{% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Acciones -->
                <div class="lino-product-card__actions">
                    <a href="{% url 'gestion:detalle_producto' producto.id %}" class="lino-action-btn lino-action-btn--view">
                        <i class="bi bi-eye"></i>
                    </a>
                    <a href="{% url 'gestion:editar_producto' producto.id %}" class="lino-action-btn lino-action-btn--edit">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <button class="lino-action-btn lino-action-btn--delete" onclick="deleteProduct({{ producto.id }}, '{{ producto.nombre }}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="lino-empty-state">
            <div class="lino-empty-state__content">
                <i class="bi bi-box-seam lino-empty-state__icon"></i>
                <h3 class="lino-empty-state__title">No hay productos registrados</h3>
                <p class="lino-empty-state__message">Comienza agregando tu primer producto al inventario</p>
                <a href="{% url 'gestion:crear_producto' %}" class="lino-action-button-compact">
                    <i class="bi bi-plus-circle me-2"></i>
                    Crear Primer Producto
                </a>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- VISTA TABLA -->
    <div id="tableView" class="lino-table-container" style="display: none;">
        <table class="lino-table">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Categor√≠a</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th>Estado</th>
                    <th>Caracter√≠sticas</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for producto in productos %}
                <tr class="product-row"
                    data-name="{{ producto.nombre|lower }}"
                    data-category="{{ producto.categoria|default:'otros' }}"
                    data-stock="{% if producto.stock > 10 %}disponible{% elif producto.stock > 5 %}bajo{% elif producto.stock > 0 %}critico{% else %}agotado{% endif %}">
                    <td>
                        <div>
                            <strong style="color: var(--lino-dark);">{{ producto.nombre }}</strong>
                            {% if producto.descripcion %}
                                <br><small style="color: var(--lino-gray-600);">{{ producto.descripcion|truncatechars:50 }}</small>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if producto.categoria == 'cereales' %}üåæ Cereales
                        {% elif producto.categoria == 'proteinas' %}ü•© Prote√≠nas
                        {% elif producto.categoria == 'lacteos' %}ü•õ L√°cteos
                        {% elif producto.categoria == 'frutas' %}üçé Frutas
                        {% elif producto.categoria == 'snacks' %}ü•ú Snacks
                        {% elif producto.categoria == 'bebidas' %}üßÉ Bebidas
                        {% elif producto.categoria == 'suplementos' %}üíä Suplementos
                        {% else %}üì¶ Otros{% endif %}
                    </td>
                    <td>
                        <strong style="color: var(--lino-success); font-size: 16px;">
                            ${{ producto.precio|floatformat:2 }}
                        </strong>
                    </td>
                    <td>
                        <span style="font-weight: 600; 
                                   {% if producto.stock > 10 %}color: var(--lino-success);
                                   {% elif producto.stock > 5 %}color: var(--lino-warning);
                                   {% else %}color: var(--lino-danger);{% endif %}">
                            {{ producto.stock }} un.
                        </span>
                    </td>
                    <td>
                        {% if producto.stock > 10 %}
                            <span class="lino-product-badge lino-product-badge--stock-ok">‚úÖ Disponible</span>
                        {% elif producto.stock > 5 %}
                            <span class="lino-product-badge lino-product-badge--stock-low">‚ö†Ô∏è Bajo</span>
                        {% elif producto.stock > 0 %}
                            <span class="lino-product-badge lino-product-badge--stock-critical">üö® Cr√≠tico</span>
                        {% else %}
                            <span class="lino-product-badge lino-product-badge--stock-critical">‚ùå Agotado</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if producto.organico %}<span class="lino-product-badge lino-product-badge--organic">üçÉ</span>{% endif %}
                        {% if producto.sin_gluten %}<span class="lino-product-badge lino-product-badge--gluten-free">üåæ</span>{% endif %}
                        {% if producto.vegano %}<span class="lino-product-badge lino-product-badge--vegan">üå±</span>{% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 4px;">
                            <button class="lino-action-btn lino-action-btn--view" onclick="viewProduct({{ producto.id }})" title="Ver producto">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="lino-action-btn lino-action-btn--edit" onclick="editProduct({{ producto.id }})" title="Editar producto">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="lino-action-btn lino-action-btn--delete" onclick="deleteProduct({{ producto.id }}, '{{ producto.nombre }}')" title="Eliminar producto">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <div class="text-muted">
                            <i class="bi bi-box-seam display-4 d-block mb-3 opacity-50"></i>
                            <h6 class="text-muted">No hay productos que coincidan con los filtros</h6>
                            <p class="small mb-3">Intenta modificar los criterios de b√∫squeda o crea tu primer producto</p>
                            <a href="{% url 'gestion:crear_producto' %}" class="btn btn-primary btn-sm">
                                <i class="bi bi-plus-circle me-1"></i>Crear primer producto
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle entre vistas
    const cardViewBtn = document.getElementById('cardViewBtn');
    const tableViewBtn = document.getElementById('tableViewBtn');
    const cardView = document.getElementById('cardView');
    const tableView = document.getElementById('tableView');
    
    cardViewBtn.addEventListener('click', function() {
        cardViewBtn.classList.add('lino-view-btn--active');
        tableViewBtn.classList.remove('lino-view-btn--active');
        cardView.style.display = 'grid';
        tableView.style.display = 'none';
    });
    
    tableViewBtn.addEventListener('click', function() {
        tableViewBtn.classList.add('lino-view-btn--active');
        cardViewBtn.classList.remove('lino-view-btn--active');
        cardView.style.display = 'none';
        tableView.style.display = 'block';
    });

    // B√∫squeda y filtros
    const searchInput = document.getElementById('productSearch');
    const categoryFilter = document.getElementById('categoryFilter');
    const stockFilter = document.getElementById('stockFilter');

    function filterProducts() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedCategory = categoryFilter.value;
        const selectedStock = stockFilter.value;
        
        // Filtrar cards
        document.querySelectorAll('.lino-product-card').forEach(card => {
            const name = card.dataset.name || '';
            const category = card.dataset.category || '';
            const stock = card.dataset.stock || '';
            
            const matchesSearch = name.includes(searchTerm);
            const matchesCategory = !selectedCategory || category === selectedCategory;
            const matchesStock = !selectedStock || stock === selectedStock;
            
            card.style.display = (matchesSearch && matchesCategory && matchesStock) ? 'block' : 'none';
        });
        
        // Filtrar tabla
        document.querySelectorAll('.product-row').forEach(row => {
            const name = row.dataset.name || '';
            const category = row.dataset.category || '';
            const stock = row.dataset.stock || '';
            
            const matchesSearch = name.includes(searchTerm);
            const matchesCategory = !selectedCategory || category === selectedCategory;
            const matchesStock = !selectedStock || stock === selectedStock;
            
            row.style.display = (matchesSearch && matchesCategory && matchesStock) ? '' : 'none';
        });
    }

    searchInput.addEventListener('input', filterProducts);
    categoryFilter.addEventListener('change', filterProducts);
    stockFilter.addEventListener('change', filterProducts);
});

// Funciones de acci√≥n
function viewProduct(id) {
    window.location.href = `/gestion/productos/${id}/`;
}

function editProduct(id) {
    window.location.href = `/gestion/productos/${id}/editar/`;
}

function deleteProduct(id, name) {
    if (confirm(`¬øEst√°s seguro de que deseas eliminar el producto "${name}"?`)) {
        fetch(`/gestion/productos/${id}/eliminar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error al eliminar el producto');
            }
        });
    }
}
</script>
{% endblock %}
