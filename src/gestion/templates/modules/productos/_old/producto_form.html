{% extends 'gestion/base.html' %}
{% block title %}{{ titulo }} - LINO SYS{% endblock %}
{% block header %}{{ titulo }}{% endblock %}
{% block content %}

<div class="container-fluid">
    <form method="post" id="productoForm">
        {% csrf_token %}
        
        <!-- Información Básica -->
        <div class="card shadow mb-4">
            <div class="card-header bg-earth text-white d-flex align-items-center">
                <i class="bi bi-info-circle me-2"></i>
                <h5 class="mb-0">Información Básica</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label for="{{ form.nombre.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-box me-1"></i>{{ form.nombre.label }}
                        </label>
                        {{ form.nombre }}
                        {% if form.nombre.errors %}
                            <div class="text-danger mt-1">{{ form.nombre.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.categoria.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-tag me-1"></i>{{ form.categoria.label }}
                        </label>
                        <div class="input-group">
                            {{ form.categoria }}
                            <button type="button" class="btn btn-outline-earth" id="nuevaCategoriaBtn" data-bs-toggle="modal" data-bs-target="#nuevaCategoriaModal">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        <div class="form-text">Selecciona una categoría existente o crea una nueva</div>
                        {% if form.categoria.errors %}
                            <div class="text-danger mt-1">{{ form.categoria.errors }}</div>
                        {% endif %}
                        
                        <!-- Campo oculto para nueva categoría -->
                        {{ form.nueva_categoria }}
                        {% if form.nueva_categoria.errors %}
                            <div class="text-danger mt-1">{{ form.nueva_categoria.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="{{ form.descripcion.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-card-text me-1"></i>{{ form.descripcion.label }}
                        </label>
                        {{ form.descripcion }}
                        {% if form.descripcion.errors %}
                            <div class="text-danger mt-1">{{ form.descripcion.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuración de Producto -->
        <div class="card shadow mb-4">
            <div class="card-header bg-earth text-white d-flex align-items-center">
                <i class="bi bi-gear me-2"></i>
                <h5 class="mb-0">Configuración de Producto</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="{{ form.materia_prima_asociada.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-box-seam me-1"></i>{{ form.materia_prima_asociada.label }}
                        </label>
                        {{ form.materia_prima_asociada }}
                        <div class="form-text">Opcional: solo para productos simples</div>
                        {% if form.materia_prima_asociada.errors %}
                            <div class="text-danger mt-1">{{ form.materia_prima_asociada.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-journal-bookmark me-1"></i>Receta
                        </label>
                        <div class="form-check mt-2">
                            {{ form.tiene_receta }}
                            <label class="form-check-label" for="{{ form.tiene_receta.id_for_label }}">{{ form.tiene_receta.label }}</label>
                        </div>
                        <div class="form-text">Marca si el producto se produce a partir de una receta</div>
                        {% if form.tiene_receta.errors %}
                            <div class="text-danger mt-1">{{ form.tiene_receta.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.receta.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-book me-1"></i>{{ form.receta.label }}
                        </label>
                        {{ form.receta }}
                        <div class="form-text">Opcional: selecciona la receta principal</div>
                        {% if form.receta.errors %}
                            <div class="text-danger mt-1">{{ form.receta.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Gestión de Stock y Precios -->
        <div class="card shadow mb-4">
            <div class="card-header bg-earth text-white d-flex align-items-center">
                <i class="bi bi-graph-up me-2"></i>
                <h5 class="mb-0">Gestión de Stock y Precios</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="{{ form.precio.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-currency-dollar me-1"></i>{{ form.precio.label }}
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            {{ form.precio }}
                        </div>
                        {% if form.precio.errors %}
                            <div class="text-danger mt-1">{{ form.precio.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.stock.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-boxes me-1"></i>{{ form.stock.label }}
                        </label>
                        {{ form.stock }}
                        {% if form.instance.pk %}
                            <div class="form-text">El stock solo se puede aumentar produciendo más unidades.</div>
                        {% endif %}
                        {% if form.stock.errors %}
                            <div class="text-danger mt-1">{{ form.stock.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <label for="{{ form.stock_minimo.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-exclamation-triangle me-1"></i>{{ form.stock_minimo.label }}
                        </label>
                        {{ form.stock_minimo }}
                        <div class="form-text">{{ form.stock_minimo.help_text }}</div>
                        {% if form.stock_minimo.errors %}
                            <div class="text-danger mt-1">{{ form.stock_minimo.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                {% if form.instance.pk %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="{{ form.cantidad_a_producir.id_for_label }}" class="form-label fw-bold">
                                <i class="bi bi-plus-circle me-1"></i>{{ form.cantidad_a_producir.label }}
                            </label>
                            {{ form.cantidad_a_producir }}
                            <div class="form-text">{{ form.cantidad_a_producir.help_text }}</div>
                            {% if form.cantidad_a_producir.errors %}
                                <div class="text-danger mt-1">{{ form.cantidad_a_producir.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-speedometer2 me-1"></i>Estado del Stock
                            </label>
                            <div class="alert alert-{% if form.instance.get_estado_stock == 'agotado' %}danger{% elif form.instance.get_estado_stock == 'critico' %}warning{% elif form.instance.get_estado_stock == 'bajo' %}info{% else %}success{% endif %} mb-0">
                                <strong>{{ form.instance.get_estado_stock_display }}</strong>
                                {% if form.instance.get_estado_stock == 'agotado' %}
                                    <i class="bi bi-x-circle ms-2"></i>
                                {% elif form.instance.get_estado_stock == 'critico' %}
                                    <i class="bi bi-exclamation-triangle ms-2"></i>
                                {% elif form.instance.get_estado_stock == 'bajo' %}
                                    <i class="bi bi-info-circle ms-2"></i>
                                {% else %}
                                    <i class="bi bi-check-circle ms-2"></i>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Información Adicional -->
        <div class="card shadow mb-4">
            <div class="card-header bg-earth text-white d-flex align-items-center">
                <i class="bi bi-info-square me-2"></i>
                <h5 class="mb-0">Información Adicional</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="{{ form.marca.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-award me-1"></i>{{ form.marca.label }}
                        </label>
                        {{ form.marca }}
                        {% if form.marca.errors %}
                            <div class="text-danger mt-1">{{ form.marca.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <label for="{{ form.origen.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-geo me-1"></i>{{ form.origen.label }}
                        </label>
                        {{ form.origen }}
                        {% if form.origen.errors %}
                            <div class="text-danger mt-1">{{ form.origen.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="{{ form.atributos_dieteticos.id_for_label }}" class="form-label fw-bold">
                            <i class="bi bi-tags me-1"></i>{{ form.atributos_dieteticos.label }}
                        </label>
                        {{ form.atributos_dieteticos }}
                        <div class="form-text">{{ form.atributos_dieteticos.help_text }}</div>
                        {% if form.atributos_dieteticos.errors %}
                            <div class="text-danger mt-1">{{ form.atributos_dieteticos.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de Acción -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <a href="{% url 'gestion:lista_productos' %}" class="btn btn-action-earth">
                        <i class="bi bi-arrow-left me-2"></i>Volver a Productos
                    </a>
                    <button type="submit" class="btn btn-action-green">
                        <i class="bi bi-save me-2"></i>Actualizar Producto
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modal para Nueva Categoría -->
<div class="modal fade" id="nuevaCategoriaModal" tabindex="-1" aria-labelledby="nuevaCategoriaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-earth text-white">
                <h5 class="modal-title" id="nuevaCategoriaModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>Nueva Categoría
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="nuevaCategoriaInput" class="form-label fw-bold">Nombre de la Categoría</label>
                    <input type="text" class="form-control" id="nuevaCategoriaInput" placeholder="Ej: Bebidas, Snacks, etc.">
                    <div class="form-text">La categoría se agregará automáticamente a la lista</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="cancelarNuevaCategoria()">Cancelar</button>
                <button type="button" class="btn btn-action-green" id="agregarCategoriaBtn">
                    <i class="bi bi-plus me-2"></i>Agregar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const stockInput = document.getElementById('{{ form.stock.id_for_label }}');
    const stockMinimoInput = document.getElementById('{{ form.stock_minimo.id_for_label }}');
    const categoriaInput = document.getElementById('{{ form.categoria.id_for_label }}');
    const nuevaCategoriaInput = document.getElementById('nuevaCategoriaInput');
    const agregarCategoriaBtn = document.getElementById('agregarCategoriaBtn');

    // Función para actualizar colores del stock
    function actualizarEstadoStock() {
        if (!stockInput || !stockMinimoInput) return;
        
        const stock = parseInt(stockInput.value) || 0;
        const stockMinimo = parseInt(stockMinimoInput.value) || 5;

        stockInput.classList.remove('border-danger', 'border-warning', 'border-info', 'border-success');

        if (stock === 0) {
            stockInput.classList.add('border-danger');
        } else if (stock <= stockMinimo) {
            stockInput.classList.add('border-warning');
        } else if (stock <= stockMinimo * 1.5) {
            stockInput.classList.add('border-info');
        } else {
            stockInput.classList.add('border-success');
        }
    }

    // Función para manejar cambios en la categoría
    function manejarCambioCategoria() {
        const valorSeleccionado = categoriaInput.value;
        if (valorSeleccionado === 'nueva') {
            // Mostrar modal para nueva categoría
            const modal = new bootstrap.Modal(document.getElementById('nuevaCategoriaModal'));
            modal.show();
        }
    }

    // Función para agregar nueva categoría
    function agregarNuevaCategoria() {
        const nuevaCategoria = nuevaCategoriaInput.value.trim();
        if (nuevaCategoria) {
            // Capitalizar la nueva categoría
            const categoriaCapitalizada = nuevaCategoria.split(' ').map(palabra =>
                palabra.charAt(0).toUpperCase() + palabra.slice(1).toLowerCase()
            ).join(' ');
            
            // Crear slug para el valor
            const categoriaSlug = categoriaCapitalizada.toLowerCase().replace(/\s+/g, '_').replace(/ñ/g, 'n');
            
            // Agregar nueva opción al select
            const selectCategoria = categoriaInput;
            const nuevaOpcion = document.createElement('option');
            nuevaOpcion.value = categoriaSlug;
            nuevaOpcion.textContent = categoriaCapitalizada;
            nuevaOpcion.selected = true;
            
            // Insertar antes de la opción "nueva"
            const opcionNueva = selectCategoria.querySelector('option[value="nueva"]');
            selectCategoria.insertBefore(nuevaOpcion, opcionNueva);
            
            // Establecer el campo nueva_categoria para que sea procesado por el formulario
            const nuevaCategoriaField = document.getElementById('{{ form.nueva_categoria.id_for_label }}');
            if (nuevaCategoriaField) {
                nuevaCategoriaField.value = categoriaCapitalizada;
            }
            
            // Cambiar temporalmente el valor del select para que Django lo procese
            categoriaInput.value = 'nueva';
            
            // Limpiar y cerrar modal
            nuevaCategoriaInput.value = '';
            const modal = bootstrap.Modal.getInstance(document.getElementById('nuevaCategoriaModal'));
            modal.hide();
            
            // Mostrar confirmación
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed top-0 end-0 m-3';
            toast.setAttribute('role', 'alert');
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle me-2"></i>Categoría "${categoriaCapitalizada}" lista para agregar
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            document.body.appendChild(toast);
            const bootstrapToast = new bootstrap.Toast(toast);
            bootstrapToast.show();
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }
    }

    // Función para manejar el cierre del modal sin agregar categoría
    function cancelarNuevaCategoria() {
        // Restaurar la selección anterior
        const selectCategoria = categoriaInput;
        const valorAnterior = selectCategoria.getAttribute('data-valor-anterior') || 'otros';
        selectCategoria.value = valorAnterior;
        
        // Limpiar el input
        nuevaCategoriaInput.value = '';
    }

    // Event listeners
    if (stockInput && stockMinimoInput) {
        stockInput.addEventListener('input', actualizarEstadoStock);
        stockMinimoInput.addEventListener('input', actualizarEstadoStock);
        actualizarEstadoStock();
    }

    if (categoriaInput) {
        // Simplificar: solo manejar la lógica de nueva categoría
        categoriaInput.addEventListener('change', function() {
            if (this.value === 'nueva') {
                manejarCambioCategoria();
            }
        });
    }

    if (agregarCategoriaBtn) {
        agregarCategoriaBtn.addEventListener('click', agregarNuevaCategoria);
    }

    if (nuevaCategoriaInput) {
        nuevaCategoriaInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                agregarNuevaCategoria();
            }
        });
    }

    // Event listener para el modal cuando se cierra sin agregar
    const modal = document.getElementById('nuevaCategoriaModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            // Si el select sigue en "nueva", restaurar el valor anterior
            if (categoriaInput && categoriaInput.value === 'nueva') {
                cancelarNuevaCategoria();
            }
        });
    }

    // Validación del formulario
    const form = document.getElementById('productoForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            let isValid = true;
            const requiredFields = ['{{ form.nombre.id_for_label }}', '{{ form.precio.id_for_label }}'];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && !field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else if (field) {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert('Por favor, completa todos los campos obligatorios.');
            }
        });
    }
});
</script>
{% endblock %}