{% extends 'gestion/base.html' %}
{% load static %}
{% load dietetica_tags %}

{% block title %}{{ producto.nombre }} - LINO SYS{% endblock %}

{% block header %}
<div class="lino-page-header">
    <div class="lino-page-header__content">
        <div class="lino-page-header__title">
            <i class="bi bi-box-seam lino-me-3"></i>
            <span>{{ producto.nombre }}</span>
        </div>
        <div class="lino-page-header__subtitle">
            Información detallada del producto
        </div>
    </div>
    <div class="lino-page-header__actions">
        <a href="{% url 'gestion:lista_productos' %}" class="lino-btn lino-btn-secondary">
            <i class="bi bi-arrow-left lino-me-2"></i>Volver
        </a>
        <a href="{% url 'gestion:editar_producto' producto.pk %}" class="lino-btn lino-btn-warning">
            <i class="bi bi-pencil lino-me-2"></i>Editar
        </a>
    </div>
</div>
{% endblock %}

{% block content %}

<div class="row g-4">
    <!-- Columna Principal -->
    <div class="col-lg-8">
        <!-- Información Básica -->
        <div class="lino-card mb-4">
            <div class="lino-card__header">
                <h3 class="lino-card__title">
                    <i class="bi bi-info-circle"></i> Información del Producto
                </h3>
            </div>
            <div class="lino-card__body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="lino-label text-muted">Nombre</label>
                        <p class="mb-0"><strong>{{ producto.nombre }}</strong></p>
                    </div>

                    <div class="col-md-6">
                        <label class="lino-label text-muted">Categoría</label>
                        <p class="mb-0">
                            <span class="lino-badge lino-badge--secondary">
                                {{ producto.categoria|default:"Sin categoría" }}
                            </span>
                        </p>
                    </div>

                    {% if producto.marca %}
                    <div class="col-md-6">
                        <label class="lino-label text-muted">Marca</label>
                        <p class="mb-0">{{ producto.marca }}</p>
                    </div>
                    {% endif %}

                    {% if producto.codigo_barras %}
                    <div class="col-md-6">
                        <label class="lino-label text-muted">Código de Barras</label>
                        <p class="mb-0"><code>{{ producto.codigo_barras }}</code></p>
                    </div>
                    {% endif %}

                    {% if producto.descripcion %}
                    <div class="col-12">
                        <label class="lino-label text-muted">Descripción</label>
                        <p class="mb-0">{{ producto.descripcion }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Precios y Rentabilidad -->
        <div class="lino-card mb-4">
            <div class="lino-card__header">
                <h3 class="lino-card__title">
                    <i class="bi bi-cash-stack"></i> Precio
                </h3>
            </div>
            <div class="lino-card__body">
                <div class="row g-4">
                    <div class="col-md-12">
                        <div class="text-center p-3 bg-light rounded">
                            <label class="lino-label text-muted">Precio de Venta</label>
                            <h4 class="text-success mb-0">${{ producto.precio|floatformat:2 }}</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Últimas Ventas -->
        {% if ultimas_ventas %}
        <div class="lino-card">
            <div class="lino-card__header">
                <h3 class="lino-card__title">
                    <i class="bi bi-clock-history"></i> Últimas Ventas
                </h3>
            </div>
            <div class="lino-card__body p-0">
                <div class="lino-table-responsive">
                    <table class="lino-table">
                        <thead class="lino-table__header">
                            <tr>
                                <th>Fecha</th>
                                <th>Cantidad</th>
                                <th>Precio Unit.</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for detalle in ultimas_ventas %}
                            <tr>
                                <td>{{ detalle.venta.fecha|date:"d/m/Y H:i" }}</td>
                                <td>{{ detalle.cantidad }}</td>
                                <td>${{ detalle.precio_unitario|floatformat:2 }}</td>
                                <td><strong>${{ detalle.subtotal|floatformat:2 }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Columna Lateral -->
    <div class="col-lg-4">
        <!-- Estado de Stock -->
        <div class="lino-card mb-4">
            <div class="lino-card__header">
                <h3 class="lino-card__title">
                    <i class="bi bi-boxes"></i> Estado de Stock
                </h3>
            </div>
            <div class="lino-card__body">
                <div class="text-center mb-3">
                    {% if producto.stock == 0 %}
                        <div class="display-4 text-danger">{{ producto.stock }}</div>
                        <span class="lino-badge lino-badge--danger mt-2">
                            <i class="bi bi-x-circle"></i> Sin Stock
                        </span>
                    {% elif producto.stock <= producto.stock_minimo %}
                        <div class="display-4 text-warning">{{ producto.stock }}</div>
                        <span class="lino-badge lino-badge--warning mt-2">
                            <i class="bi bi-exclamation-triangle"></i> Stock Bajo
                        </span>
                    {% else %}
                        <div class="display-4 text-success">{{ producto.stock }}</div>
                        <span class="lino-badge lino-badge--success mt-2">
                            <i class="bi bi-check-circle"></i> Stock Normal
                        </span>
                    {% endif %}
                </div>

                <hr>

                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Stock Mínimo:</span>
                    <strong>{{ producto.stock_minimo }}</strong>
                </div>

                <!-- Barra de progreso de stock -->
                <div class="mt-3">
                    <label class="lino-label text-muted small">Nivel de Stock</label>
                    <div class="progress" style="height: 10px;">
                        {% widthratio producto.stock producto.stock_minimo 100 as porcentaje %}
                        {% if porcentaje <= 50 %}
                            <div class="progress-bar bg-danger" style="width: {{ porcentaje }}%"></div>
                        {% elif porcentaje <= 100 %}
                            <div class="progress-bar bg-warning" style="width: {{ porcentaje }}%"></div>
                        {% else %}
                            <div class="progress-bar bg-success" style="width: 100%"></div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas del Mes -->
        <div class="lino-card mb-4">
            <div class="lino-card__header">
                <h3 class="lino-card__title">
                    <i class="bi bi-graph-up"></i> Estadísticas del Mes
                </h3>
            </div>
            <div class="lino-card__body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <label class="lino-label text-muted">Ventas Realizadas</label>
                        <div class="h4 mb-0">{{ ventas_mes|default:0 }}</div>
                    </div>
                    <div class="text-end">
                        <i class="bi bi-cart-check" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <label class="lino-label text-muted">Unidades Vendidas</label>
                        <div class="h4 mb-0">{{ cantidad_vendida_mes|default:0 }}</div>
                    </div>
                    <div class="text-end">
                        <i class="bi bi-box" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información del Sistema -->
        <div class="lino-card">
            <div class="lino-card__header">
                <h3 class="lino-card__title">
                    <i class="bi bi-clock-history"></i> Información del Sistema
                </h3>
            </div>
            <div class="lino-card__body">
                <div class="mb-3">
                    <label class="lino-label text-muted small">ID del Producto</label>
                    <p class="mb-0"><code>#{{ producto.id }}</code></p>
                </div>

                <div class="mb-3">
                    <label class="lino-label text-muted small">Fecha de Creación</label>
                    <p class="mb-0">{{ producto.fecha_creacion|date:"d/m/Y H:i" }}</p>
                </div>

                <div>
                    <label class="lino-label text-muted small">Última Modificación</label>
                    <p class="mb-0">{{ producto.fecha_modificacion|date:"d/m/Y H:i" }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
