{% extends 'gestion/base.html' %}
{% load dietetica_tags %}
{% load static %}

{% block title %}GestiÃ³n de Compras - LINO SYS{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/lino-enterprise-components.css' %}?v=20241030">
{% endblock %}

{% block header %}
{% include 'modules/_shared/page_header.html' with title="GestiÃ³n de Compras" subtitle="Control de compras de materias primas y proveedores" icon="truck" create_url=create_url create_label="Nueva Compra" %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- KPIs ENTERPRISE -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="metric-card-enterprise" style="--metric-color: #4a5c3a; --metric-light: #5d7247;">
                <div class="metric-header">
                    <div class="metric-content">
                        <div class="metric-label">TOTAL COMPRAS</div>
                        <div class="metric-value" style="color: #4a5c3a;">
                            {{ compras.count }}
                        </div>
                        <div class="metric-subtitle">Registradas en el sistema</div>
                    </div>
                    <div class="metric-icon-wrapper" style="background: #f0f4f0; color: #4a5c3a;">
                        <i class="bi bi-truck"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="metric-card-enterprise" style="--metric-color: #059669; --metric-light: #10b981;">
                <div class="metric-header">
                    <div class="metric-content">
                        <div class="metric-label">TOTAL INVERTIDO</div>
                        <div class="metric-value" style="color: #059669;">
                            ${{ total_invertido|floatformat:0 }}
                        </div>
                        <div class="metric-subtitle">En compras realizadas</div>
                    </div>
                    <div class="metric-icon-wrapper" style="background: #ecfdf5; color: #059669;">
                        <i class="bi bi-currency-dollar"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="metric-card-enterprise" style="--metric-color: #f59e0b; --metric-light: #fbbf24;">
                <div class="metric-header">
                    <div class="metric-content">
                        <div class="metric-label">ESTE MES</div>
                        <div class="metric-value" style="color: #f59e0b;">
                            {{ compras_mes|default:"0" }}
                        </div>
                        <div class="metric-subtitle">Compras del mes actual</div>
                    </div>
                    <div class="metric-icon-wrapper" style="background: #fffbeb; color: #f59e0b;">
                        <i class="bi bi-calendar-month"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="metric-card-enterprise" style="--metric-color: #3b82f6; --metric-light: #60a5fa;">
                <div class="metric-header">
                    <div class="metric-content">
                        <div class="metric-label">PROVEEDORES</div>
                        <div class="metric-value" style="color: #3b82f6;">
                            {{ proveedores_activos|default:"0" }}
                        </div>
                        <div class="metric-subtitle">Con compras recientes</div>
                    </div>
                    <div class="metric-icon-wrapper" style="background: #eff6ff; color: #3b82f6;">
                        <i class="bi bi-people"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BÃºsqueda y acciones usando lino-chart-container -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="lino-chart-container">
                <div class="lino-chart-header">
                    <h6 class="lino-chart-title mb-0">
                        <i class="bi bi-search me-2"></i>Buscar y Filtrar
                    </h6>
                </div>
                <div class="lino-chart-body">
                    <form method="get" class="d-flex gap-3 align-items-end">
                        <div class="flex-grow-1">
                            <div class="position-relative">
                                <i class="bi bi-search position-absolute" style="left: 15px; top: 50%; transform: translateY(-50%); color: #6c757d; z-index: 10;"></i>
                                <input type="text" class="form-control form-control-lg border-2 ps-5" 
                                       name="q" value="{{ request.GET.q }}" 
                                       placeholder="Buscar compra..."
                                       style="background-color: #f8f9fa; border-color: #e9ecef;">
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <div class="dropdown">
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="dropdown">
                                    <i class="bi bi-funnel me-1"></i>Filtros
                                </button>
                                <div class="dropdown-menu p-3" style="min-width: 300px;">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label small fw-medium">Materia Prima</label>
                                            <select name="materia_prima" class="form-select">
                                                <option value="">Todas las materias primas</option>
                                                {% for mp in materias_primas %}
                                                    <option value="{{ mp.id }}" {% if mp.id|stringformat:"s" == request.GET.materia_prima %}selected{% endif %}>
                                                        {{ mp.nombre }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label small fw-medium">Fecha desde</label>
                                            <input type="date" name="fecha_desde" value="{{ request.GET.fecha_desde }}" 
                                                   class="form-control">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label small fw-medium">Fecha hasta</label>
                                            <input type="date" name="fecha_hasta" value="{{ request.GET.fecha_hasta }}" 
                                                   class="form-control">
                                        </div>
                                        <div class="col-12">
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="bi bi-search me-1"></i>Aplicar Filtros
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search me-1"></i>Buscar
                            </button>
                            {% if request.GET.q or request.GET.materia_prima or request.GET.fecha_desde or request.GET.fecha_hasta %}
                                <a href="{% url 'gestion:lista_compras' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-lg me-1"></i>Limpiar
                                </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="lino-chart-container">
                <div class="lino-chart-header">
                    <h6 class="lino-chart-title mb-0">
                        <i class="bi bi-lightning-charge me-2"></i>Acciones RÃ¡pidas
                    </h6>
                </div>
                <div class="lino-chart-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'gestion:crear_compra_migrado' %}" class="btn btn-primary btn-lg">
                            <i class="bi bi-plus-circle me-2"></i>Nueva Compra
                        </a>
                        <a href="#" class="btn btn-outline-secondary">
                            <i class="bi bi-file-text me-2"></i>Reporte Compras
                        </a>
                        <a href="#" class="btn btn-outline-secondary">
                            <i class="bi bi-download me-2"></i>Exportar Excel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de compras usando lino-chart-container -->
    <div class="lino-chart-container">
        <div class="lino-chart-header">
            <h6 class="lino-chart-title mb-0">
                <i class="bi bi-list-ul me-2"></i>Lista de Compras
            </h6>
        </div>
        <div class="lino-chart-body">
            {% if compras %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="small text-muted">
                        Mostrando {{ compras.count }} compra{{ compras.count|pluralize:"s" }}
                    </div>
                    <span class="badge bg-primary">{{ compras.count }}</span>
                </div>
                
                <div class="table-responsive">
                    <table class="table-enterprise">
                        <thead>
                            <tr>
                                <th><i class="bi bi-calendar me-1"></i>Fecha</th>
                                <th><i class="bi bi-box2 me-1"></i>Materia Prima</th>
                                <th><i class="bi bi-building me-1"></i>Proveedor</th>
                                <th><i class="bi bi-123 me-1"></i>Cantidad</th>
                                <th><i class="bi bi-currency-dollar me-1"></i>Precio/Unidad</th>
                                <th><i class="bi bi-calculator me-1"></i>Total</th>
                                <th><i class="bi bi-activity me-1"></i>Estado</th>
                                <th><i class="bi bi-gear me-1"></i>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for compra in compras %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge badge-enterprise neutral">ðŸ“…</span>
                                        <div class="fw-medium">{{ compra.fecha_compra|date:"d/m/Y" }}</div>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <div class="fw-medium">{{ compra.materia_prima.nombre }}</div>
                                        <div class="small text-muted">{{ compra.materia_prima.categoria|default:"Sin categorÃ­a" }}</div>
                                    </div>
                                </td>
                                <td>
                                    <span>{{ compra.proveedor|default:"Sin especificar" }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-1">
                                        <span class="fw-bold text-enterprise-primary">{{ compra.cantidad_mayoreo|floatformat:2 }}</span>
                                        <span class="small text-muted">{{ compra.materia_prima.unidad_medida }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="fw-medium">${{ compra.precio_unitario_mayoreo|floatformat:2 }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="fw-bold text-enterprise-success">${{ compra.precio_mayoreo|floatformat:2 }}</span>
                                        {% if compra.precio_mayoreo >= 1000 %}
                                            <span class="badge badge-enterprise warning">ðŸ’°</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if compra.fecha_compra == today %}
                                        <span class="badge badge-enterprise success">
                                            <i class="bi bi-check-circle"></i> HOY
                                        </span>
                                    {% elif compra.fecha_compra >= week_ago %}
                                        <span class="badge badge-enterprise primary">
                                            <i class="bi bi-clock"></i> RECIENTE
                                        </span>
                                    {% else %}
                                        <span class="badge badge-enterprise neutral">
                                            <i class="bi bi-check"></i> COMPLETADO
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex gap-1">
                                        <a href="#" class="btn btn-sm btn-outline-secondary" title="Ver detalles">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="#" class="btn btn-sm btn-outline-primary" title="Editar">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button type="button" class="btn btn-sm btn-outline-danger" title="Eliminar">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-truck display-1 text-muted mb-3"></i>
                    <h5 class="text-muted">No hay compras registradas</h5>
                    <p class="text-muted mb-4">Comienza registrando tu primera compra de materia prima</p>
                    <a href="{% url 'gestion:crear_compra_migrado' %}" class="btn btn-primary btn-lg">
                        <i class="bi bi-plus-circle me-2"></i>Registrar Compra
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Panel de estadÃ­sticas adicionales -->
    <div class="row g-4 mt-4">
        <div class="col-lg-6">
            <div class="lino-chart-container">
                <div class="lino-chart-header">
                    <h6 class="lino-chart-title mb-0">
                        <i class="bi bi-graph-up me-2"></i>Resumen de Compras
                    </h6>
                </div>
                <div class="lino-chart-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="ops-metric-card">
                                <div class="ops-metric-label">Hoy</div>
                                <div class="ops-metric-value" style="color: #059669;">{{ compras_hoy|default:"0" }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="ops-metric-card">
                                <div class="ops-metric-label">Esta Semana</div>
                                <div class="ops-metric-value" style="color: #4a5c3a;">{{ compras_semana|default:"0" }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="lino-chart-container">
                <div class="lino-chart-header">
                    <h6 class="lino-chart-title mb-0">
                        <i class="bi bi-currency-dollar me-2"></i>InversiÃ³n Mensual
                    </h6>
                </div>
                <div class="lino-chart-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="ops-metric-card">
                                <div class="ops-metric-label">Este Mes</div>
                                <div class="ops-metric-value" style="color: #f59e0b;">${{ inversion_mes|floatformat:0|default:0 }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="ops-metric-card">
                                <div class="ops-metric-label">Promedio</div>
                                <div class="ops-metric-value" style="color: #4a5c3a;">${{ promedio_compra|floatformat:0|default:0 }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}
