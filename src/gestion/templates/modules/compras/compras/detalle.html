{% extends 'gestion/base.html' %}
{% load static %}
{% load dietetica_tags %}

{% block title %}Compra #{{ compra.id }} - LINO SYS{% endblock %}

{% block header %}Compra #{{ compra.id }}{% endblock %}

{% block extra_head %}
<style>
    body {
        background-color: #fafaf9 !important;
    }
</style>
{% endblock %}

{% block content %}

<div class="container" style="max-width: 1200px;">
    <div class="lino-wizard-content" style="box-shadow: 0 2px 8px rgba(74, 92, 58, 0.1);">
        <div style="padding: 2rem 2.5rem; background: white; border-radius: 12px;">
            
            <!-- Header -->
            <div class="mb-4 pb-4" style="border-bottom: 2px solid var(--lino-gray-200);">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h2 style="color: var(--lino-primary); font-weight: 700;">
                            <span style="font-size: 2.5rem;"></span>
                            Compra #{{ compra.id }}
                        </h2>
                        <p style="color: var(--lino-gray-600); margin-bottom: 0;">
                            {{ compra.fecha_compra|date:"d/m/Y" }} - {{ compra.proveedor }}
                        </p>
                        {% if not es_legacy %}
                        <span class="badge" style="background: var(--lino-primary); color: white; font-size: 0.75rem; padding: 0.25rem 0.75rem;">
                            Multi-Producto ({{ detalles.count }} items)
                        </span>
                        {% endif %}
                    </div>
                    <div class="text-end">
                        <div style="font-size: 2.5rem; font-weight: 800; color: var(--lino-primary);">
                            {% if es_legacy %}
                                ${{ compra.precio_mayoreo|floatformat:2 }}
                            {% else %}
                                ${{ compra.total|floatformat:2 }}
                            {% endif %}
                        </div>
                        <small style="color: var(--lino-gray-600);">Total invertido</small>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button onclick="window.print()" class="lino-btn lino-btn-ghost">
                        <i class="bi bi-printer lino-me-2"></i>Imprimir
                    </button>
                    <a href="{% url 'gestion:eliminar_compra' compra.pk %}" class="lino-btn lino-btn-danger">
                        <i class="bi bi-trash lino-me-2"></i>Eliminar Compra
                    </a>
                </div>
            </div>

<div class="row g-4">
    <!-- Columna Principal: Informaci贸n -->
    <div class="col-lg-8">
        {% if es_legacy %}
        <!-- LEGACY: Una sola materia prima -->
        <!-- Informaci贸n de la Compra -->
        <h5 class="mb-3">
            <i class="bi bi-info-circle"></i> Informaci贸n de la Compra
        </h5>
        
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <label class="lino-label">Materia Prima</label>
                <div class="lino-input" style="background: var(--lino-light); color: var(--lino-gray-700); font-weight: 600;">
                    {{ compra.materia_prima.nombre }}
                </div>
                <small class="text-muted d-block mt-1">
                    Stock actual: {{ compra.materia_prima.stock_actual }} {{ compra.materia_prima.unidad_medida }}
                </small>
            </div>

            <div class="col-md-6">
                <label class="lino-label">Proveedor</label>
                <div class="lino-input" style="background: var(--lino-light); color: var(--lino-gray-700); font-weight: 600;">
                    {{ compra.proveedor }}
                </div>
            </div>

            <div class="col-md-6">
                <label class="lino-label">Fecha de Compra</label>
                <div class="lino-input" style="background: var(--lino-light); color: var(--lino-gray-700); font-weight: 600;">
                    {{ compra.fecha_compra|date:"d/m/Y" }}
                </div>
            </div>

            <div class="col-md-6">
                <label class="lino-label">Cantidad Comprada</label>
                <div class="lino-input" style="background: var(--lino-light); color: var(--lino-gray-700); font-weight: 600;">
                    {{ compra.cantidad_mayoreo }} {{ compra.materia_prima.unidad_medida }}
                </div>
            </div>
        </div>

        <hr class="my-4">

        <!-- Desglose Econ贸mico -->
        <h5 class="mb-3">
            <i class="bi bi-cash-stack"></i> Desglose Econ贸mico
        </h5>
        
        <div class="table-responsive mb-3">
            <table class="lino-table">
                <thead>
                    <tr>
                        <th>Concepto</th>
                        <th class="text-end">Valor</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <i class="bi bi-tag text-muted lino-me-2"></i>
                            Precio Total de Compra
                        </td>
                        <td class="text-end" style="font-weight: 600;">
                            ${{ compra.precio_mayoreo|floatformat:2 }}
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <i class="bi bi-calculator text-muted lino-me-2"></i>
                            Precio Unitario
                        </td>
                        <td class="text-end" style="font-weight: 600;">
                            ${{ compra.precio_unitario_mayoreo|floatformat:2 }}
                            <small class="text-muted ms-2">/ {{ compra.materia_prima.unidad_medida }}</small>
                        </td>
                    </tr>
                    <tr style="background: var(--lino-gray-50);">
                        <td>
                            <i class="bi bi-box text-muted lino-me-2"></i>
                            Cantidad
                        </td>
                        <td class="text-end" style="font-weight: 600;">
                            {{ compra.cantidad_mayoreo }} {{ compra.materia_prima.unidad_medida }}
                        </td>
                    </tr>
                    <tr style="background: var(--lino-primary); color: white;">
                        <th>
                            <i class="bi bi-cash-coin lino-me-2"></i>
                            TOTAL PAGADO
                        </th>
                        <th class="text-end">
                            <h4 class="mb-0" style="color: white;">
                                ${{ compra.precio_mayoreo|floatformat:2 }}
                            </h4>
                        </th>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- F贸rmula del Precio Unitario -->
        <div class="lino-alert lino-alert-info">
            <i class="bi bi-calculator-fill"></i>
            <div>
                <strong>C谩lculo del Precio Unitario</strong>
                <p class="mb-0 mt-1 font-monospace small">
                    Precio Unitario = Precio Total 梅 Cantidad<br>
                    <strong>
                        ${{ compra.precio_unitario_mayoreo|floatformat:2 }} = 
                        ${{ compra.precio_mayoreo|floatformat:2 }} 梅 {{ compra.cantidad_mayoreo }}
                    </strong>
                </p>
            </div>
        </div>
        
        {% else %}
        <!-- NUEVA: M煤ltiples materias primas (CompraDetalle) -->
        
        <!-- Informaci贸n General -->
        <h5 class="mb-3">
            <i class="bi bi-info-circle"></i> Informaci贸n General del Pedido
        </h5>
        
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <label class="lino-label">Proveedor</label>
                <div class="lino-input" style="background: var(--lino-light); color: var(--lino-gray-700); font-weight: 600;">
                    {{ compra.proveedor }}
                </div>
            </div>

            <div class="col-md-6">
                <label class="lino-label">Fecha de Compra</label>
                <div class="lino-input" style="background: var(--lino-light); color: var(--lino-gray-700); font-weight: 600;">
                    {{ compra.fecha_compra|date:"d/m/Y" }}
                </div>
            </div>

            {% if compra.observaciones %}
            <div class="col-12">
                <label class="lino-label">Observaciones</label>
                <div class="lino-input" style="background: var(--lino-light); color: var(--lino-gray-700);">
                    {{ compra.observaciones }}
                </div>
            </div>
            {% endif %}
        </div>

        <hr class="my-4">

        <!-- Productos del Pedido -->
        <h5 class="mb-3">
            <i class="bi bi-box-seam"></i> Productos del Pedido ({{ detalles.count }})
        </h5>
        
        <div class="table-responsive mb-3">
            <table class="lino-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Materia Prima</th>
                        <th class="text-center">Cantidad</th>
                        <th class="text-end">Precio Unit.</th>
                        <th class="text-end">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for detalle in detalles %}
                    <tr>
                        <td>
                            <strong>{{ detalle.materia_prima.nombre }}</strong>
                            <br>
                            <small class="text-muted">
                                Stock actual: {{ detalle.materia_prima.stock_actual }} {{ detalle.materia_prima.get_unidad_medida_display }}
                            </small>
                        </td>
                        <td class="text-center" style="font-weight: 600;">
                            {{ detalle.cantidad }} {{ detalle.materia_prima.get_unidad_medida_display }}
                        </td>
                        <td class="text-end" style="font-weight: 600;">
                            ${{ detalle.precio_unitario|floatformat:2 }}
                            <small class="text-muted d-block">/ {{ detalle.materia_prima.get_unidad_medida_display }}</small>
                        </td>
                        <td class="text-end" style="font-weight: 700; color: var(--lino-success);">
                            ${{ detalle.subtotal|floatformat:2 }}
                        </td>
                    </tr>
                    {% endfor %}
                    <tr style="background: var(--lino-primary); color: white;">
                        <th colspan="3" class="text-end">
                            <i class="bi bi-cash-coin lino-me-2"></i>
                            TOTAL DEL PEDIDO
                        </th>
                        <th class="text-end">
                            <h4 class="mb-0" style="color: white;">
                                ${{ compra.total|floatformat:2 }}
                            </h4>
                        </th>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="lino-alert lino-alert-info">
            <i class="bi bi-info-circle-fill"></i>
            <div>
                <strong>Compra Multi-Producto</strong>
                <p class="mb-0 mt-1">
                    Este pedido incluye {{ detalles.count }} producto(s) diferente(s). 
                    El stock y costo unitario de cada materia prima se actualiz贸 autom谩ticamente 
                    aplicando promedio ponderado.
                </p>
            </div>
        </div>
        
        {% endif %}
    </div>

    <!-- Columna Lateral: Resumen -->
    <div class="col-lg-4">
        <!-- Resumen R谩pido -->
        <div style="background: linear-gradient(135deg, var(--lino-primary) 0%, #3d4a2f 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
            <h5 class="mb-4" style="color: white; font-weight: 700;">
                <i class="bi bi-pie-chart"></i> Resumen R谩pido
            </h5>
            
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="opacity: 0.9; font-size: 0.875rem;">Total Invertido</span>
                    <span style="font-size: 1.5rem; font-weight: 700;">
                        {% if es_legacy %}
                            ${{ compra.precio_mayoreo|floatformat:2 }}
                        {% else %}
                            ${{ compra.total|floatformat:2 }}
                        {% endif %}
                    </span>
                </div>
                <div style="background: rgba(255, 255, 255, 0.2); height: 4px; border-radius: 2px;">
                    <div style="background: white; height: 4px; border-radius: 2px; width: 100%;"></div>
                </div>
            </div>

            {% if es_legacy %}
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="opacity: 0.9; font-size: 0.875rem;">Precio Unitario</span>
                    <span style="font-size: 1.25rem; font-weight: 700;">${{ compra.precio_unitario_mayoreo|floatformat:2 }}</span>
                </div>
                <small style="opacity: 0.8; display: block; text-align: right;">por {{ compra.materia_prima.unidad_medida }}</small>
            </div>

            <div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="opacity: 0.9; font-size: 0.875rem;">Cantidad</span>
                    <span style="font-size: 1.25rem; font-weight: 700;">{{ compra.cantidad_mayoreo }} {{ compra.materia_prima.unidad_medida }}</span>
                </div>
            </div>
            {% else %}
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="opacity: 0.9; font-size: 0.875rem;">Productos Distintos</span>
                    <span style="font-size: 1.25rem; font-weight: 700;">{{ detalles.count }}</span>
                </div>
            </div>

            <div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span style="opacity: 0.9; font-size: 0.875rem;">Promedio por Item</span>
                    <span style="font-size: 1.25rem; font-weight: 700;">
                        ${% widthratio compra.total detalles.count 1 %}
                    </span>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Informaci贸n del Sistema -->
        <div style="background: var(--lino-gray-100); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--lino-gray-200);">
            <h6 class="mb-3" style="color: var(--lino-gray-700); font-weight: 700;">
                <i class="bi bi-info-circle"></i> Informaci贸n
            </h6>
            
            <ul class="mb-0" style="list-style: none; padding: 0; font-size: 0.875rem; color: var(--lino-gray-600);">
                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--lino-gray-200);">
                    <i class="bi bi-check-circle" style="color: var(--lino-success);"></i>
                    Stock actualizado autom谩ticamente
                </li>
                <li style="padding: 0.5rem 0; border-bottom: 1px solid var(--lino-gray-200);">
                    <i class="bi bi-calculator" style="color: var(--lino-info);"></i>
                    Precio promedio ponderado aplicado
                </li>
                <li style="padding: 0.5rem 0;">
                    <i class="bi bi-database" style="color: var(--lino-warning);"></i>
                    Inventario actualizado en tiempo real
                </li>
            </ul>
        </div>
    </div>
</div>

        </div>
    </div>
</div>

<div class="mt-4 text-center">
    <a href="{% url 'gestion:lista_compras' %}" class="lino-btn lino-btn-ghost">
        <i class="bi bi-arrow-left lino-me-2"></i>Volver al Listado
    </a>
</div>

{% endblock %}