{% extends 'gestion/base.html' %}
{% load dietetica_tags %}
{% load static %}

{% block title %}Nueva Compra - LINO SYS{% endblock %}

{% block extra_head %}
<!-- No external CSS needed - using inline styles -->
<style>
body {
    background-color: #fafaf9 !important;
}

.container-fluid {
    padding: 2rem 1rem;
}

/* Loading spinner */
.lino-loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: lino-spin 1s linear infinite;
    display: inline-block;
    margin-right: 8px;
}

@keyframes lino-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block header %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1"><i class="bi bi-truck me-2"></i>Nueva Compra</h1>
        <p class="text-muted mb-0">Registra una compra de materia prima</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <!-- Main Form -->
        <div class="col-lg-8">
            <div style="background: white !important; border-radius: 12px; box-shadow: 0 4px 20px rgba(74, 92, 58, 0.1); overflow: hidden;">
                <div style="padding: 2.5rem; background: white !important;">
                    <!-- 游 Header con Emoji Grande -->
                    <div class="mb-4">
                        <h2 style="color: var(--lino-primary); font-weight: 700; margin-bottom: 0.5rem;">
                            <span style="font-size: 2.5rem; margin-right: 0.75rem;">游</span>
                            Informaci칩n de la Compra
                        </h2>
                        <p class="text-muted" style="font-size: 0.95rem; margin-left: 3.5rem;">
                            Complete los datos de la compra de materia prima
                        </p>
                    </div>

                    <form method="post" id="formCompra" novalidate>
                        {% csrf_token %}
                        
                        <div class="row g-4">
                            <!-- Materia Prima -->
                            <div class="col-12">
                                <label for="{{ form.materia_prima.id_for_label }}" class="lino-label">
                                    {{ form.materia_prima.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.materia_prima }}
                                {% if form.materia_prima.help_text %}
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i> {{ form.materia_prima.help_text }}
                                    </small>
                                {% endif %}
                                {% if form.materia_prima.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.materia_prima.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Proveedor -->
                            <div class="col-md-6">
                                <label for="{{ form.proveedor.id_for_label }}" class="lino-label">
                                    {{ form.proveedor.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.proveedor }}
                                {% if form.proveedor.help_text %}
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i> {{ form.proveedor.help_text }}
                                    </small>
                                {% endif %}
                                {% if form.proveedor.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.proveedor.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Cantidad -->
                            <div class="col-md-6">
                                <label for="{{ form.cantidad_mayoreo.id_for_label }}" class="lino-label">
                                    {{ form.cantidad_mayoreo.label }}
                                    <span class="text-danger">*</span>
                                    <span id="unidad_label" style="color: var(--lino-primary); font-weight: 600;"></span>
                                </label>
                                {{ form.cantidad_mayoreo }}
                                <small class="text-muted" id="helper_cantidad">
                                    <i class="bi bi-info-circle"></i> Cantidad comprada de la materia prima
                                </small>
                                {% if form.cantidad_mayoreo.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.cantidad_mayoreo.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Precio Total -->
                            <div class="col-md-6">
                                <label for="{{ form.precio_mayoreo.id_for_label }}" class="lino-label">
                                    {{ form.precio_mayoreo.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text" style="background-color: var(--lino-primary); color: white; border: none;">
                                        <i class="bi bi-currency-dollar"></i>
                                    </span>
                                    {{ form.precio_mayoreo }}
                                </div>
                                {% if form.precio_mayoreo.help_text %}
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle"></i> {{ form.precio_mayoreo.help_text }}
                                    </small>
                                {% endif %}
                                {% if form.precio_mayoreo.errors %}
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle"></i> {{ form.precio_mayoreo.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Precio Unitario Calculado -->
                            <div class="col-md-6">
                                <label class="lino-label">
                                    游눯 Precio Unitario (Calculado)
                                </label>
                                <div class="lino-input" style="background-color: #f8f9fa; cursor: not-allowed; font-weight: 600; font-size: 1.1rem;" id="precio_unitario_display">
                                    <em class="text-muted" style="font-weight: 400;">Se calcular치 autom치ticamente</em>
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Precio Total 칭 Cantidad
                                </small>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="lino-wizard-actions" style="margin-top: 2.5rem; padding-top: 2rem; border-top: 2px solid var(--lino-gray-200);">
                            <a href="{% url 'gestion:lista_compras_migrado' %}" class="lino-btn lino-btn-ghost">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                            <button type="submit" class="lino-btn lino-btn-primary lino-btn-lg" id="btnSubmit">
                                <i class="bi bi-check-circle"></i> Guardar Compra
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Tips Card -->
            <div style="background: white !important; border-radius: 12px; box-shadow: 0 2px 12px rgba(74, 92, 58, 0.08); position: sticky; top: 20px;">
                <div style="padding: 1.5rem; background: white !important;">
                    <h6 style="color: var(--lino-primary); font-weight: 600; margin-bottom: 1rem;">
                        <i class="bi bi-lightbulb-fill" style="color: #f59e0b;"></i> Informaci칩n Importante
                    </h6>
                    <ul class="small text-muted mb-0" style="padding-left: 20px; line-height: 1.8;">
                        <li><strong>Actualizaci칩n autom치tica:</strong> El stock de la materia prima se actualiza al guardar</li>
                        <li><strong>Precio unitario:</strong> Se calcula dividiendo el precio total entre la cantidad</li>
                        <li><strong>Costos de producci칩n:</strong> El nuevo precio unitario afecta los costos de recetas y productos</li>
                        <li><strong>Verificaci칩n:</strong> Revisa el precio unitario calculado antes de confirmar</li>
                    </ul>
                </div>
            </div>

            <!-- Quick Actions -->
            <div style="background: white !important; border-radius: 12px; box-shadow: 0 2px 12px rgba(74, 92, 58, 0.08); margin-top: 1rem;">
                <div style="padding: 1.5rem; background: white !important;">
                    <h6 style="color: var(--lino-primary); font-weight: 600; margin-bottom: 1rem;">
                        <i class="bi bi-lightning-fill" style="color: #f59e0b;"></i> Acciones R치pidas
                    </h6>
                    <div class="d-grid gap-2">
                        <a href="{% url 'gestion:lista_compras_migrado' %}" class="lino-btn lino-btn-ghost" style="justify-content: flex-start;">
                            <i class="bi bi-list-ul"></i> Ver Compras
                        </a>
                        <a href="{% url 'gestion:lista_materias_primas_migrado' %}" class="lino-btn lino-btn-ghost" style="justify-content: flex-start;">
                            <i class="bi bi-box-seam"></i> Materias Primas
                        </a>
                        <a href="{% url 'gestion:crear_materia_prima_migrado' %}" class="lino-btn lino-btn-ghost" style="justify-content: flex-start;">
                            <i class="bi bi-plus-circle"></i> Nueva Materia Prima
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para c치lculos en tiempo real -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('formCompra');
    const materiaPrimaSelect = document.getElementById('{{ form.materia_prima.id_for_label }}');
    const cantidadInput = document.getElementById('{{ form.cantidad_mayoreo.id_for_label }}');
    const precioTotalInput = document.getElementById('{{ form.precio_mayoreo.id_for_label }}');
    const unidadLabel = document.getElementById('unidad_label');
    const helperCantidad = document.getElementById('helper_cantidad');
    const precioUnitarioDisplay = document.getElementById('precio_unitario_display');
    const btnSubmit = document.getElementById('btnSubmit');

    // Datos de materias primas para JavaScript
    const materiasPrimasData = {
        {% for mp in form.materia_prima.queryset %}
        '{{ mp.id }}': {
            'nombre': '{{ mp.nombre|escapejs }}',
            'unidad': '{{ mp.get_unidad_medida_display|escapejs }}',
            'unidad_code': '{{ mp.unidad_medida|escapejs }}',
            'proveedor': '{{ mp.proveedor.id|default:"" }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    console.log('Materias Primas cargadas:', materiasPrimasData);

    // Actualizar unidad de medida cuando cambia la materia prima
    materiaPrimaSelect.addEventListener('change', function() {
        const mpId = this.value;
        if (mpId && materiasPrimasData[mpId]) {
            const mp = materiasPrimasData[mpId];
            unidadLabel.textContent = `(${mp.unidad})`;
            helperCantidad.innerHTML = `<i class="bi bi-info-circle"></i> Cantidad en <strong>${mp.unidad}</strong> comprada`;
            
            // Actualizar proveedor si est치 disponible
            const proveedorSelect = document.getElementById('{{ form.proveedor.id_for_label }}');
            if (mp.proveedor && proveedorSelect) {
                proveedorSelect.value = mp.proveedor;
            }
        } else {
            unidadLabel.textContent = '';
            helperCantidad.innerHTML = '<i class="bi bi-info-circle"></i> Cantidad comprada de la materia prima';
        }
        calcularPrecioUnitario();
    });

    // Calcular precio unitario en tiempo real
    function calcularPrecioUnitario() {
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const precioTotal = parseFloat(precioTotalInput.value) || 0;
        
        if (cantidad > 0 && precioTotal > 0) {
            const precioUnitario = precioTotal / cantidad;
            precioUnitarioDisplay.textContent = `$${precioUnitario.toFixed(2)}`;
            precioUnitarioDisplay.style.fontWeight = '700';
            precioUnitarioDisplay.style.color = 'var(--lino-success)';
            console.log('Precio Unitario:', { precioTotal, cantidad, precioUnitario });
        } else {
            precioUnitarioDisplay.innerHTML = '<em class="text-muted" style="font-weight: 400;">Se calcular치 autom치ticamente</em>';
        }
    }

    // Escuchar cambios en cantidad y precio total
    cantidadInput.addEventListener('input', calcularPrecioUnitario);
    precioTotalInput.addEventListener('input', calcularPrecioUnitario);

    // Submit handler with loading state
    if (form) {
        form.addEventListener('submit', function() {
            if (btnSubmit) {
                btnSubmit.innerHTML = '<span class="lino-loading-spinner"></span> Guardando...';
                btnSubmit.disabled = true;
            }
        });
    }

    // Inicializar
    if (materiaPrimaSelect.value) {
        materiaPrimaSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}
