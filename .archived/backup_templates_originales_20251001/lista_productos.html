{% extends 'gestion/base.html' %}
{% load dietetica_tags %}

{% block title %}Inventario - LINO SYS{% endblock %}

{% block header %}
<div class="page-header">Inventario</div>
{% endblock %}

{% block content %}

<!-- KPIs de Inventario estilo moderno -->
<div class="row g-4 mb-5">
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100 modern-kpi-card">
            <div class="card-body p-4 position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-muted small mb-2">Total Productos</div>
                        <div class="h3 mb-1 fw-bold text-dark">{{ productos|length }}</div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-box-seam text-primary me-1"></i>
                            <span class="text-primary small fw-medium">Activos en inventario</span>
                        </div>
                    </div>
                    <div class="kpi-icon-corner bg-primary">
                        <i class="bi bi-box-seam text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100 modern-kpi-card">
            <div class="card-body p-4 position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-muted small mb-2">Stock Cr√≠tico</div>
                        <div class="h3 mb-1 fw-bold text-dark" id="stock-critico-count">0</div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                            <span class="text-warning small fw-medium">Requieren atenci√≥n</span>
                        </div>
                    </div>
                    <div class="kpi-icon-corner bg-warning">
                        <i class="bi bi-exclamation-triangle text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100 modern-kpi-card">
            <div class="card-body p-4 position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-muted small mb-2">Productos Agotados</div>
                        <div class="h3 mb-1 fw-bold text-dark" id="agotados-count">0</div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-x-circle text-danger me-1"></i>
                            <span class="text-danger small fw-medium">Sin stock disponible</span>
                        </div>
                    </div>
                    <div class="kpi-icon-corner bg-danger">
                        <i class="bi bi-x-circle text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100 modern-kpi-card">
            <div class="card-body p-4 position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-muted small mb-2">Valor del Inventario</div>
                        <div class="h3 mb-1 fw-bold text-dark" id="valor-inventario">$0</div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-currency-dollar text-success me-1"></i>
                            <span class="text-success small fw-medium">Valor total en stock</span>
                        </div>
                    </div>
                    <div class="kpi-icon-corner bg-success">
                        <i class="bi bi-currency-dollar text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros modernos y acciones -->
<div class="row g-4 mb-5">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm modern-filters-card">
            <div class="card-body p-4">
                <form method="get" id="filtrosForm">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="q" class="form-label fw-medium">Buscar producto</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="bi bi-search text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-start-0" id="q" name="q" 
                                       value="{{ query|default:'' }}" placeholder="Nombre del producto...">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="categoria" class="form-label fw-medium">Categor√≠a</label>
                            <select class="form-select" id="categoria" name="categoria">
                                <option value="">Todas las categor√≠as</option>
                                <option value="suplementos" {% if categoria_seleccionada == 'suplementos' %}selected{% endif %}>Suplementos Nutricionales</option>
                                <option value="cereales" {% if categoria_seleccionada == 'cereales' %}selected{% endif %}>Cereales y Granos</option>
                                <option value="frutos_secos" {% if categoria_seleccionada == 'frutos_secos' %}selected{% endif %}>Frutos Secos y Semillas</option>
                                <option value="tes_infusiones" {% if categoria_seleccionada == 'tes_infusiones' %}selected{% endif %}>T√©s e Infusiones</option>
                                <option value="harinas_especiales" {% if categoria_seleccionada == 'harinas_especiales' %}selected{% endif %}>Harinas Especiales</option>
                                <option value="endulzantes" {% if categoria_seleccionada == 'endulzantes' %}selected{% endif %}>Endulzantes Naturales</option>
                                <option value="aceites_vinagres" {% if categoria_seleccionada == 'aceites_vinagres' %}selected{% endif %}>Aceites y Vinagres</option>
                                <option value="conservas" {% if categoria_seleccionada == 'conservas' %}selected{% endif %}>Conservas y Preservados</option>
                                <option value="productos_veganos" {% if categoria_seleccionada == 'productos_veganos' %}selected{% endif %}>Productos Veganos</option>
                                <option value="sin_tacc" {% if categoria_seleccionada == 'sin_tacc' %}selected{% endif %}>Sin TACC</option>
                                <option value="organicos" {% if categoria_seleccionada == 'organicos' %}selected{% endif %}>Productos Org√°nicos</option>
                                <option value="especias" {% if categoria_seleccionada == 'especias' %}selected{% endif %}>Especias y Condimentos</option>
                                <option value="bebidas" {% if categoria_seleccionada == 'bebidas' %}selected{% endif %}>Bebidas Naturales</option>
                                <option value="otros" {% if categoria_seleccionada == 'otros' %}selected{% endif %}>Otros</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="estado_stock" class="form-label fw-medium">Estado del Stock</label>
                            <select class="form-select" id="estado_stock" name="estado_stock">
                                <option value="">Todos los estados</option>
                                <option value="agotado" {% if estado_stock == 'agotado' %}selected{% endif %}>üî¥ Agotado</option>
                                <option value="critico" {% if estado_stock == 'critico' %}selected{% endif %}>üü° Cr√≠tico</option>
                                <option value="bajo" {% if estado_stock == 'bajo' %}selected{% endif %}>üîµ Bajo</option>
                                <option value="normal" {% if estado_stock == 'normal' %}selected{% endif %}>üü¢ Normal</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="bi bi-funnel me-2"></i>Aplicar Filtros
                                </button>
                                <a href="{% url 'gestion:lista_productos' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise me-2"></i>Limpiar
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm modern-actions-card">
            <div class="card-body p-4">
                <h6 class="card-title mb-3 fw-bold">Acciones R√°pidas</h6>
                <div class="d-grid gap-2">
                    <a href="{% url 'gestion:crear_producto' %}" class="btn btn-action-green">
                        <i class="bi bi-plus-circle me-2"></i>Nuevo Producto
                    </a>
                    <a href="{% url 'gestion:exportar_productos' %}" class="btn btn-action-earth">
                        <i class="bi bi-download me-2"></i>Exportar Excel
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Informaci√≥n de filtros activos -->
{% if query or categoria_seleccionada or estado_stock %}
<div class="alert alert-info border-0 shadow-sm mb-4">
    <div class="d-flex align-items-center">
        <i class="bi bi-funnel-fill me-2"></i>
        <div>
            <strong>Filtros activos:</strong>
            {% if query %}Texto: "{{ query }}"{% endif %}
            {% if categoria_seleccionada %}{% if query %} ‚Ä¢ {% endif %}Categor√≠a: "{{ categoria_seleccionada|title }}"{% endif %}
            {% if estado_stock %}{% if query or categoria_seleccionada %} ‚Ä¢ {% endif %}Estado: "{{ estado_stock|title }}"{% endif %}
            <span class="badge bg-info ms-2">{{ productos|length }} resultado{{ productos|length|pluralize }}</span>
        </div>
    </div>
</div>
{% endif %}

<!-- Productos en formato de tarjetas modernas -->
<div class="row g-4 mb-4" id="productos-container">
    {% for producto in productos %}
    <div class="col-lg-4 col-md-6">
        <div class="card h-100 border-0 shadow-sm modern-product-card hover-card">
            <div class="card-body p-4">
                <!-- Header del producto -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="flex-grow-1">
                        <h6 class="card-title mb-1 fw-bold">{{ producto.nombre }}</h6>
                        {% if producto.descripcion %}
                            <p class="text-muted small mb-2">{{ producto.descripcion|truncatechars:60 }}</p>
                        {% endif %}
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'gestion:editar_producto' producto.id %}">
                                <i class="bi bi-pencil me-2"></i>Editar
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="confirmarEliminacion({{ producto.id }}, '{{ producto.nombre|escapejs }}', {{ producto.precio|default:0 }}, {{ producto.stock|default:0 }}, '{{ producto.get_categoria_display|escapejs }}'); return false;">
                                <i class="bi bi-trash me-2"></i>Eliminar
                            </a></li>
                        </ul>
                    </div>
                </div>
                
                <!-- Informaci√≥n principal -->
                <div class="mb-3">
                    <div class="row g-2 align-items-center">
                        <div class="col-6">
                            <div class="text-muted small">Precio</div>
                            <div class="h5 mb-0 text-success fw-bold">${{ producto.precio }}</div>
                        </div>
                        <div class="col-6">
                            <div class="text-muted small">Stock actual</div>
                            <div class="h5 mb-0 fw-bold">{{ producto.stock }}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Estado del stock -->
                <div class="mb-3">
                    <span class="badge {{ producto.get_estado_stock_badge_class }} w-100 py-2">
                        <i class="{{ producto.get_estado_stock_icon }} me-1"></i>{{ producto.get_estado_stock_display }}
                        {% if producto.get_estado_stock == 'critico' %}(M√≠n: {{ producto.stock_minimo }}){% endif %}
                    </span>
                </div>
                
                <!-- Categor√≠a -->
                <div class="mb-3">
                    <div class="text-muted small mb-1">Categor√≠a</div>
                    <span class="badge bg-primary">
                        <i class="bi bi-tag me-1"></i>{{ producto.get_categoria_display }}
                    </span>
                </div>
                
                <!-- Atributos diet√©ticos -->
                {% if producto.atributos_dieteticos %}
                <div class="mb-3">
                    <div class="text-muted small mb-1">Atributos</div>
                    <div class="d-flex flex-wrap gap-1">
                        {% for attr in producto.atributos_dieteticos|split:',' %}
                            {% if attr.strip %}
                                <span class="badge bg-success small">
                                    {% if attr.strip == 'organico' %}<i class="bi bi-flower1 me-1"></i>Org√°nico{% endif %}
                                    {% if attr.strip == 'vegano' %}<i class="bi bi-leaf me-1"></i>Vegano{% endif %}
                                    {% if attr.strip == 'sin_tacc' %}<i class="bi bi-shield-check me-1"></i>Sin TACC{% endif %}
                                    {% if attr.strip == 'sin_azucar' %}<i class="bi bi-droplet-half me-1"></i>Sin Az√∫car{% endif %}
                                    {% if attr.strip == 'integral' %}<i class="bi bi-grain me-1"></i>Integral{% endif %}
                                    {% if attr.strip == 'natural' %}<i class="bi bi-flower2 me-1"></i>Natural{% endif %}
                                    {% if attr.strip not in 'organico,vegano,sin_tacc,sin_azucar,integral,natural' %}{{ attr.strip|title }}{% endif %}
                                </span>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Marca y origen -->
                {% if producto.marca or producto.origen %}
                <div class="border-top pt-3 mt-3">
                    {% if producto.marca %}
                        <div class="text-muted small">Marca: <span class="text-dark fw-medium">{{ producto.marca }}</span></div>
                    {% endif %}
                    {% if producto.origen %}
                        <div class="text-muted small">Origen: <span class="text-dark fw-medium">{{ producto.origen }}</span></div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center py-5">
                {% if query or categoria_seleccionada or estado_stock %}
                    <i class="bi bi-search display-4 text-muted opacity-50 mb-3"></i>
                    <h5 class="text-muted">No se encontraron productos</h5>
                    <p class="text-muted mb-4">No hay productos que coincidan con los filtros aplicados</p>
                    <a href="{% url 'gestion:lista_productos' %}" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-clockwise me-2"></i>Ver todos los productos
                    </a>
                {% else %}
                    <i class="bi bi-box-seam display-4 text-muted opacity-50 mb-3"></i>
                    <h5 class="text-muted">No hay productos registrados</h5>
                    <p class="text-muted mb-4">Comienza agregando tu primer producto al inventario</p>
                    <a href="{% url 'gestion:crear_producto' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-2"></i>Agregar Primer Producto
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Calcular KPIs de inventario en tiempo real
    const productos = document.querySelectorAll('.modern-product-card');
    let totalProductos = productos.length;
    let stockCritico = 0;
    let agotados = 0;
    let valorInventario = 0;
    
    productos.forEach(card => {
        // Detectar estado del stock por el badge
        const estadoBadge = card.querySelector('.badge.w-100');
        if (estadoBadge) {
            const texto = estadoBadge.textContent.trim();
            if (texto.includes('Agotado')) {
                agotados++;
            } else if (texto.includes('Cr√≠tico')) {
                stockCritico++;
            }
        }
        
        // Calcular valor del inventario
        const precioElement = card.querySelector('.text-success.fw-bold');
        const stockElement = card.querySelector('.h5.mb-0.fw-bold');
        
        if (precioElement && stockElement) {
            const precio = parseFloat(precioElement.textContent.replace('$', '').replace(',', ''));
            const stock = parseInt(stockElement.textContent);
            if (!isNaN(precio) && !isNaN(stock)) {
                valorInventario += precio * stock;
            }
        }
    });
    
    // Actualizar KPIs en la interfaz
    document.getElementById('stock-critico-count').textContent = stockCritico;
    document.getElementById('agotados-count').textContent = agotados;
    document.getElementById('valor-inventario').textContent = '$' + valorInventario.toLocaleString('es-AR', {maximumFractionDigits: 0});
    
    // Auto-submit filtros cuando cambian los selects
    const categoriaSelect = document.getElementById('categoria');
    const estadoSelect = document.getElementById('estado_stock');
    
    [categoriaSelect, estadoSelect].forEach(select => {
        if (select) {
            select.addEventListener('change', function() {
                if (this.value !== '') {
                    document.getElementById('filtrosForm').submit();
                }
            });
        }
    });
    
    // Limpiar filtros con Ctrl+K
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'k') {
            e.preventDefault();
            window.location.href = '{% url "gestion:lista_productos" %}';
        }
    });
    
    // Efecto hover en las tarjetas
    productos.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
    
    // Variables globales para el modal
    let productoAEliminar = null;

    // Funci√≥n para abrir modal de eliminaci√≥n
    window.confirmarEliminacion = function(id, nombre, precio, stock, categoria) {
        productoAEliminar = id;
        
        // Actualizar contenido del modal
        document.getElementById('productoNombre').textContent = nombre;
        
        let info = [];
        if (precio) info.push(`$${parseFloat(precio).toFixed(2)}`);
        if (stock !== undefined) info.push(`${stock} unidades`);
        if (categoria) info.push(categoria);
        
        document.getElementById('productoInfo').textContent = info.join(' ‚Ä¢ ');
        document.getElementById('eliminarForm').action = `/gestion/productos/${id}/eliminar/`;
        
        // Resetear checkbox
        document.getElementById('confirmarEliminacion').checked = false;
        document.getElementById('btnEliminar').disabled = true;
        
        // Mostrar modal
        new bootstrap.Modal(document.getElementById('eliminarModal')).show();
    };

    // Manejar checkbox de confirmaci√≥n
    document.getElementById('confirmarEliminacion').addEventListener('change', function() {
        document.getElementById('btnEliminar').disabled = !this.checked;
    });

    // Manejar env√≠o del formulario
    document.getElementById('eliminarForm').addEventListener('submit', function(e) {
        if (!confirm('¬øEst√°s absolutamente seguro? Esta acci√≥n no se puede deshacer.')) {
            e.preventDefault();
        }
    });
});
</script>

<!-- Modal de Confirmaci√≥n de Eliminaci√≥n -->
<div class="modal fade" id="eliminarModal" tabindex="-1" aria-labelledby="eliminarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="eliminarModalLabel">
                    <i class="bi bi-trash3"></i> Confirmar Eliminaci√≥n
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                </div>
                
                <h5 class="text-danger mb-2" id="productoNombre"></h5>
                <p class="text-muted mb-3" id="productoInfo"></p>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    Esta acci√≥n no se puede deshacer
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmarEliminacion">
                    <label class="form-check-label" for="confirmarEliminacion">
                        Confirmo que deseo eliminar este producto
                    </label>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <form id="eliminarForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" id="btnEliminar" disabled>
                        <i class="bi bi-trash3"></i> Eliminar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}