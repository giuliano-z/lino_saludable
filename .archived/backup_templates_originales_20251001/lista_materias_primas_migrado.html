{% extends 'gestion/base.html' %}
{% load dietetica_tags %}

{% block title %}Materias Primas - LINO SYS{% endblock %}

{% block header %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1">Materias Primas</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="{% url 'gestion:panel_control' %}" class="text-decoration-none">
                        {% lino_icon "bi-house-door" "me-1" %}Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    {% lino_icon "bi-box2" "me-1" %}Materias Primas
                </li>
            </ol>
        </nav>
    </div>
    {% lino_badge "MIGRADO - COMPONENTES LINO" "success" "lg" "bi-check-circle" %}
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- KPIs usando lino_kpi_card -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            {% lino_kpi_card "Total Materias" materias_primas.count "primary" "bi-box2" "lg" %}
            <div class="lino-kpi-card__trend">
                {% lino_icon "bi-archive" "text-primary me-1" %}
                <span class="text-primary small fw-medium">En inventario</span>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            {% lino_kpi_card "Con Stock" stats.con_stock|default:"0" "success" "bi-check-circle" "lg" %}
            <div class="lino-kpi-card__trend">
                {% lino_icon "bi-check2" "text-success me-1" %}
                <span class="text-success small fw-medium">Disponibles</span>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            {% lino_kpi_card "Stock Bajo" stats.stock_bajo|default:"0" "danger" "bi-exclamation-triangle" "lg" %}
            <div class="lino-kpi-card__trend">
                {% lino_icon "bi-arrow-down" "text-danger me-1" %}
                <span class="text-danger small fw-medium">Requieren reposición</span>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            {% lino_kpi_card "Valor Total" stats.valor_total|floatformat:0|default:"0"|add:"$" "earth" "bi-currency-dollar" "lg" %}
            <div class="lino-kpi-card__trend">
                {% lino_icon "bi-graph-up" "text-success me-1" %}
                <span class="text-success small fw-medium">Inventario valorizado</span>
            </div>
        </div>
    </div>

    <!-- Búsqueda y acciones usando lino_card -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="lino-card">
                {% lino_card_header "Buscar y Filtrar" "bi-search" "olive" %}
                <div class="lino-card-content">
                    <form method="get" class="d-flex gap-3 align-items-end">
                        <div class="flex-grow-1">
                            <div class="position-relative">
                                {% lino_icon "bi-search" "position-absolute" "style='left: 15px; top: 50%; transform: translateY(-50%); color: #6c757d; z-index: 10;'" %}
                                <input type="text" class="form-control form-control-lg border-2 ps-5" 
                                       name="q" value="{{ request.GET.q }}" 
                                       placeholder="Buscar materia prima..."
                                       style="background-color: #f8f9fa; border-color: #e9ecef;">
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <div class="dropdown">
                                {% lino_btn "Filtros" "#" "outline" "md" "bi-funnel" "data-bs-toggle='dropdown'" %}
                                <div class="dropdown-menu p-3" style="min-width: 300px; z-index: 1050;">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label small fw-medium">Proveedor</label>
                                            <select name="proveedor" class="form-select">
                                                <option value="">Todos los proveedores</option>
                                                {% for proveedor in proveedores %}
                                                    <option value="{{ proveedor }}" {% if proveedor == request.GET.proveedor %}selected{% endif %}>
                                                        {{ proveedor|title }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label small fw-medium">Estado de Stock</label>
                                            <select name="estado_stock" class="form-select">
                                                <option value="">Todos los estados</option>
                                                <option value="agotado" {% if request.GET.estado_stock == 'agotado' %}selected{% endif %}>
                                                    Agotadas
                                                </option>
                                                <option value="bajo" {% if request.GET.estado_stock == 'bajo' %}selected{% endif %}>
                                                    Stock Bajo
                                                </option>
                                                <option value="normal" {% if request.GET.estado_stock == 'normal' %}selected{% endif %}>
                                                    Stock Normal
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            {% lino_btn "Aplicar Filtros" "#" "primary" "md" "bi-search" "type='submit' class='w-100'" %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% lino_btn "Buscar" "#" "primary" "md" "bi-search" "type='submit'" %}
                            {% if request.GET.q or request.GET.proveedor or request.GET.estado_stock %}
                                {% lino_btn "Limpiar" "{% url 'gestion:lista_materias_primas' %}" "outline" "md" "bi-x-lg" %}
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="lino-card">
                {% lino_card_header "Acciones Rápidas" "bi-lightning-charge" "warning" %}
                <div class="lino-card-content">
                    <div class="d-grid gap-2">
                        {% lino_btn "Nueva Materia Prima" "{% url 'gestion:crear_materia_prima_migrado' %}" "primary" "lg" "bi-plus-circle" %}
                        {% lino_btn "Reporte de Stock" "{% url 'gestion:reporte_stock_materias_primas' %}" "earth" "md" "bi-file-text" %}
                        {% lino_btn "Exportar Excel" "{% url 'gestion:exportar_materias_primas_excel' %}" "olive" "md" "bi-download" %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de materias primas usando lino_card -->
    <div class="lino-card">
        {% lino_card_header "Lista de Materias Primas" "bi-box2" "brown" %}
        <div class="lino-card-content">
            {% if materias_primas %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="small text-muted">
                        Mostrando {{ materias_primas.count }} materia{{ materias_primas.count|pluralize:"s" }} prima{{ materias_primas.count|pluralize:"s" }}
                    </div>
                    {% lino_badge materias_primas.count "primary" "md" "bi-list" %}
                </div>
                
                <div class="table-responsive">
                    <table class="lino-table">
                        <thead>
                            <tr>
                                <th>{% lino_icon "bi-box2" "me-1" %}Materia Prima</th>
                                <th>{% lino_icon "bi-building" "me-1" %}Proveedor</th>
                                <th>{% lino_icon "bi-123" "me-1" %}Stock Actual</th>
                                <th>{% lino_icon "bi-exclamation-triangle" "me-1" %}Stock Mínimo</th>
                                <th>{% lino_icon "bi-currency-dollar" "me-1" %}Costo/Unidad</th>
                                <th>{% lino_icon "bi-calculator" "me-1" %}Valor Total</th>
                                <th>{% lino_icon "bi-activity" "me-1" %}Estado</th>
                                <th>{% lino_icon "bi-gear" "me-1" %}Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for materia in materias_primas %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="me-2">
                                            {% if materia.stock_actual <= 0 %}
                                                {% lino_badge "!" "danger" "sm" "bi-x-circle" %}
                                            {% elif materia.stock_actual <= materia.stock_minimo %}
                                                {% lino_badge "!" "warning" "sm" "bi-exclamation-triangle" %}
                                            {% else %}
                                                {% lino_badge "✓" "success" "sm" "bi-check-circle" %}
                                            {% endif %}
                                        </div>
                                        <div>
                                            <div class="fw-medium">{{ materia.nombre }}</div>
                                            <div class="small text-muted">{{ materia.descripcion|truncatechars:30 }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="fw-medium">{{ materia.proveedor|default:"Sin proveedor" }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="fw-bold {% if materia.stock_actual <= 0 %}text-danger{% elif materia.stock_actual <= materia.stock_minimo %}text-warning{% else %}text-success{% endif %}">
                                            {{ materia.stock_actual|floatformat:2 }}
                                        </span>
                                        <span class="small text-muted ms-1">{{ materia.unidad_medida }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="text-muted">{{ materia.stock_minimo|floatformat:2 }} {{ materia.unidad_medida }}</span>
                                </td>
                                <td>
                                    <span class="fw-medium">${{ materia.costo_unitario|floatformat:2 }}</span>
                                </td>
                                <td>
                                    {% with valor_total=materia.stock_actual|mul:materia.costo_unitario %}
                                    <span class="fw-bold text-success">${{ valor_total|floatformat:2 }}</span>
                                    {% endwith %}
                                </td>
                                <td>
                                    {% if materia.stock_actual <= 0 %}
                                        {% lino_badge "AGOTADO" "danger" "sm" "bi-x-circle" %}
                                    {% elif materia.stock_actual <= materia.stock_minimo %}
                                        {% lino_badge "STOCK BAJO" "warning" "sm" "bi-exclamation-triangle" %}
                                    {% else %}
                                        {% lino_badge "DISPONIBLE" "success" "sm" "bi-check-circle" %}
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex gap-1">
                                        {% lino_btn "Ver" "{% url 'gestion:detalle_materia_prima' materia.pk %}" "outline" "sm" "bi-eye" %}
                                        {% lino_btn "Editar" "{% url 'gestion:editar_materia_prima' materia.pk %}" "earth" "sm" "bi-pencil" %}
                                        {% lino_btn "Movimiento" "{% url 'gestion:movimiento_materia_prima' materia.pk %}" "olive" "sm" "bi-arrow-up-down" %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    {% lino_icon "bi-box2" "display-1 text-muted mb-3" %}
                    <h5 class="text-muted">No hay materias primas registradas</h5>
                    <p class="text-muted mb-4">Comienza agregando tu primera materia prima</p>
                    {% lino_btn "Agregar Materia Prima" "{% url 'gestion:crear_materia_prima_migrado' %}" "primary" "lg" "bi-plus-circle" %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Panel de estadísticas adicionales -->
    <div class="row g-4 mt-4">
        <div class="col-lg-6">
            <div class="lino-card">
                {% lino_card_header "Estadísticas de Stock" "bi-graph-up" "earth" %}
                <div class="lino-card-content">
                    <div class="row g-3">
                        <div class="col-6">
                            {% lino_value_box stats.agotadas|default:"0" "Agotadas" "danger" "md" %}
                        </div>
                        <div class="col-6">
                            {% lino_value_box stats.stock_normal|default:"0" "Stock Normal" "success" "md" %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="lino-card">
                {% lino_card_header "Valor del Inventario" "bi-currency-dollar" "olive" %}
                <div class="lino-card-content">
                    <div class="row g-3">
                        <div class="col-6">
                            {% lino_value_box stats.valor_promedio|floatformat:0|default:"0"|add:"$" "Valor Promedio" "earth" "md" %}
                        </div>
                        <div class="col-6">
                            {% lino_value_box stats.costo_reposicion|floatformat:0|default:"0"|add:"$" "Costo Reposición" "warning" "md" %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}
