{% extends 'gestion/base.html' %}
{% block title %}Lista de Recetas - LINO SYS{% endblock %}
{%                         <div class="text-muted small mb-2">Materias Primas Usadas</div>
                        <div class="h3 mb-1 fw-bold text-dark">{{ materias_en_recetas.count|default:"0" }}</div>
                        <div class="text-warning small fw-medium">En recetas activas</div>header %}Recetas{% endblock %}
{% block content %}
<!-- Breadcrumb oculto
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb bg-white px-3 py-2 rounded shadow-sm">
        <li class="breadcrumb-item"><a href="{% url 'gestion:panel_control' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">Recetas</li>
    </ol>
</nav>
-->

<!-- Header Section con Filtros y Acciones -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-4">
        <div class="row align-items-center">
            <div class="col-lg-4">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="kpi-icon-corner bg-success">
                            <i class="bi bi-journal-text text-white"></i>
                        </div>
                    </div>
                    <div>
                        <h4 class="mb-1 fw-bold text-dark">Gestión de Recetas</h4>
                        <p class="text-muted mb-0">Administra las recetas de tu dietética</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="d-flex gap-3 align-items-center justify-content-end">
                    <div class="input-group" style="max-width: 300px;">
                        <span class="input-group-text bg-light border-end-0">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-start-0" placeholder="Buscar receta..." id="buscarReceta">
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-filter me-2"></i>Filtros
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-filter="todas">Todas las recetas</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="activas">Recetas activas</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="sin-productos">Sin productos</a></li>
                        </ul>
                    </div>
                    <a href="{% url 'gestion:crear_receta' %}" class="btn btn-action-green">
                        <i class="bi bi-plus-circle me-2"></i>Nueva Receta
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards Mejoradas -->
<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100 modern-kpi-card">
            <div class="card-body p-4 position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-muted small mb-2">Total Recetas</div>
                        <div class="h3 mb-1 fw-bold text-dark">{{ recetas.count }}</div>
                        <div class="text-success small fw-medium">Activos en inventario</div>
                    </div>
                    <div class="kpi-icon-corner bg-success">
                        <i class="bi bi-journal-text text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100 modern-kpi-card">
            <div class="card-body p-4 position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-muted small mb-2">Productos con Receta</div>
                        <div class="h3 mb-1 fw-bold text-dark">{{ productos_en_recetas.count|default:"0" }}</div>
                        <div class="text-primary small fw-medium">Con receta definida</div>
                    </div>
                    <div class="kpi-icon-corner bg-primary">
                        <i class="bi bi-box-seam text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100 modern-kpi-card">
            <div class="card-body p-4 position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-muted small mb-2">Materias Usadas</div>
                        <div class="h3 mb-1 fw-bold text-dark">{{ materias_en_recetas.count|default:"0" }}</div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-egg-fried text-warning me-1"></i>
                            <span class="text-warning small fw-medium">En recetas activas</span>
                        </div>
                    </div>
                    <div class="kpi-icon-corner bg-warning">
                        <i class="bi bi-egg-fried text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm h-100 modern-kpi-card">
            <div class="card-body p-4 position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="text-muted small mb-2">Recetas Activas</div>
                        <div class="h3 mb-1 fw-bold text-dark">{{ recetas_activas.count|default:"0" }}</div>
                        <div class="text-success small fw-medium">En uso</div>
                    </div>
                    <div class="kpi-icon-corner bg-info">
                        <i class="bi bi-check-circle text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Recetas Cards Mejoradas -->
<div class="card border-0 shadow-sm">
    <div class="card-body p-4">
        <div class="row" id="recetasContainer">
            {% for receta in recetas %}
            <div class="col-md-6 col-lg-4 mb-4 receta-item" data-receta-nombre="{{ receta.nombre|lower }}">
                <div class="card h-100 shadow-sm border-0 hover-card position-relative">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="recipe-icon-modern">
                                <div class="kpi-icon-corner bg-success">
                                    <i class="bi bi-journal-text text-white"></i>
                                </div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-light text-muted dropdown-toggle border-0" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow">
                                    <li>
                                        <a class="dropdown-item" href="{% url 'gestion:detalle_receta' receta.id %}">
                                            <i class="bi bi-eye me-2 text-primary"></i>Ver Detalles
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'gestion:editar_receta' receta.id %}">
                                            <i class="bi bi-pencil me-2 text-warning"></i>Editar
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#">
                                            <i class="bi bi-files me-2 text-info"></i>Duplicar
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="{% url 'gestion:eliminar_receta' receta.id %}">
                                            <i class="bi bi-trash me-2"></i>Eliminar
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <h5 class="card-title mb-2 fw-bold">
                            <a href="{% url 'gestion:detalle_receta' receta.id %}" class="text-dark text-decoration-none">
                                {{ receta.nombre }}
                            </a>
                        </h5>
                        <p class="card-text text-muted small mb-3" style="min-height: 40px;">
                            {{ receta.descripcion|truncatechars:80|default:"Sin descripción disponible" }}
                        </p>
                        
                        <!-- Productos Section -->
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-box-seam text-primary me-2"></i>
                                <h6 class="small fw-bold mb-0 text-dark">Productos ({{ receta.productos.count }})</h6>
                            </div>
                            <div class="productos-tags">
                                {% for producto in receta.productos.all|slice:":3" %}
                                    <span class="badge bg-light text-primary border me-1 mb-1">
                                        {{ producto.nombre }}
                                    </span>
                                {% empty %}
                                    <span class="text-muted small">Sin productos asignados</span>
                                {% endfor %}
                                {% if receta.productos.count > 3 %}
                                    <span class="badge bg-primary text-white">+{{ receta.productos.count|add:"-3" }}</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Materias Primas Section -->
                        <div class="mb-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-egg-fried text-warning me-2"></i>
                                <h6 class="small fw-bold mb-0 text-dark">Materias Primas ({{ receta.materias_primas.count }})</h6>
                            </div>
                            <div class="materias-tags">
                                {% for mp in receta.materias_primas.all|slice:":3" %}
                                    <span class="badge bg-light text-warning border me-1 mb-1">
                                        {{ mp.nombre }}
                                    </span>
                                {% empty %}
                                    <span class="text-muted small">Sin materias primas</span>
                                {% endfor %}
                                {% if receta.materias_primas.count > 3 %}
                                    <span class="badge bg-warning text-dark">+{{ receta.materias_primas.count|add:"-3" }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card Footer con acciones -->
                    <div class="card-footer bg-transparent border-0 pt-0 px-4 pb-4">
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-success flex-fill" onclick="verDetallesReceta('{{ receta.id }}')">
                                <i class="bi bi-eye me-1"></i>Ver
                            </button>
                            <button class="btn btn-sm btn-action-earth flex-fill" onclick="editarReceta('{{ receta.id }}')">
                                <i class="bi bi-pencil me-1"></i>Editar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="bi bi-journal-text display-1 text-muted opacity-50"></i>
                    </div>
                    <h4 class="text-muted mb-3">No hay recetas registradas</h4>
                    <p class="text-muted mb-4">Comienza creando tu primera receta para tus productos de la dietética</p>
                    <a href="{% url 'gestion:crear_receta' %}" class="btn btn-action-green btn-lg">
                        <i class="bi bi-plus-circle me-2"></i>Crear Primera Receta
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Funcionalidad de búsqueda en tiempo real
document.getElementById('buscarReceta').addEventListener('input', function() {
    const filtro = this.value.toLowerCase();
    const recetas = document.querySelectorAll('.receta-item');
    
    recetas.forEach(receta => {
        const nombre = receta.getAttribute('data-receta-nombre');
        if (nombre.includes(filtro)) {
            receta.style.display = 'block';
        } else {
            receta.style.display = 'none';
        }
    });
    
    // Mostrar mensaje si no hay resultados
    const recetasVisibles = document.querySelectorAll('.receta-item[style="display: block"], .receta-item:not([style*="display: none"])');
    const container = document.getElementById('recetasContainer');
    
    if (filtro && recetasVisibles.length === 0) {
        if (!document.getElementById('noResultados')) {
            const noResultados = document.createElement('div');
            noResultados.id = 'noResultados';
            noResultados.className = 'col-12 text-center py-5';
            noResultados.innerHTML = `
                <i class="bi bi-search text-muted mb-3" style="font-size: 3rem;"></i>
                <h5 class="text-muted">No se encontraron recetas</h5>
                <p class="text-muted">Intenta con otro término de búsqueda</p>
            `;
            container.appendChild(noResultados);
        }
    } else {
        const noResultados = document.getElementById('noResultados');
        if (noResultados) {
            noResultados.remove();
        }
    }
});

// Filtros por categoría
document.querySelectorAll('[data-filter]').forEach(filtro => {
    filtro.addEventListener('click', function(e) {
        e.preventDefault();
        const tipo = this.getAttribute('data-filter');
        const recetas = document.querySelectorAll('.receta-item');
        
        recetas.forEach(receta => {
            receta.style.display = 'block';
        });
        
        // Aquí puedes agregar lógica específica para cada filtro
        console.log('Filtrar por:', tipo);
    });
});

// Funciones para las acciones de las recetas
function verDetallesReceta(id) {
    // Aquí implementarías la lógica para ver detalles
    console.log('Ver detalles de receta:', id);
    // window.location.href = `/recetas/${id}/`;
}

function editarReceta(id) {
    // Aquí implementarías la lógica para editar
    console.log('Editar receta:', id);
    // window.location.href = `/recetas/${id}/editar/`;
}

function confirmarEliminacion(id, nombre) {
    if (confirm(`¿Estás seguro de que deseas eliminar la receta "${nombre}"?`)) {
        // Aquí implementarías la lógica de eliminación
        console.log('Eliminar receta:', id);
        // Podrías usar fetch para hacer la petición AJAX
    }
}

// Animación para las cards al cargar
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.receta-item .card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'all 0.5s ease';
            
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 50);
        }, index * 100);
    });
});
</script>
{% endblock %}
