{% extends 'gestion/base.html' %}
{% load dietetica_tags %}

{% block title %}Nueva Compra - LINO SYS{% endblock %}

{% block header %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1 class="h3 mb-1">Nueva Compra de Materia Prima</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="{% url 'gestion:panel_control' %}" class="text-decoration-none">
                        {% lino_icon "bi-house-door" "me-1" %}Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'gestion:lista_compras_migrado' %}" class="text-decoration-none">
                        {% lino_icon "bi-truck" "me-1" %}Compras
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    {% lino_icon "bi-plus-circle" "me-1" %}Nueva Compra
                </li>
            </ol>
        </nav>
    </div>
    {% lino_badge "MÓDULO MIGRADO - LINO" "success" "lg" "bi-check-circle" %}
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Panel de información -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            {% lino_info_section "Información sobre Compras" %}
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-start">
                            {% lino_icon "bi-lightbulb" "text-warning me-2 mt-1" %}
                            <div>
                                <div class="fw-medium">Registro Automático</div>
                                <div class="small text-muted">El precio unitario se calcula automáticamente al guardar la compra</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-start">
                            {% lino_icon "bi-arrow-repeat" "text-success me-2 mt-1" %}
                            <div>
                                <div class="fw-medium">Actualización de Stock</div>
                                <div class="small text-muted">El stock de la materia prima se actualiza automáticamente</div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endlino_info_section %}
        </div>
    </div>

    <!-- Formulario principal -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="lino-card">
                {% lino_card_header "Datos de la Compra" "bi-truck" "earth" %}
                <div class="lino-card-content">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        <div class="row g-4">
                            <!-- Materia Prima -->
                            <div class="col-12">
                                <label for="{{ form.materia_prima.id_for_label }}" class="form-label fw-medium">
                                    {% lino_icon "bi-box2" "me-2 text-brown" %}
                                    {{ form.materia_prima.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.materia_prima }}
                                {% if form.materia_prima.help_text %}
                                    <div class="form-text">
                                        {% lino_icon "bi-info-circle" "me-1" %}
                                        {{ form.materia_prima.help_text }}
                                    </div>
                                {% endif %}
                                {% if form.materia_prima.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.materia_prima.errors %}
                                            {% lino_icon "bi-exclamation-triangle" "me-1" %}{{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Proveedor -->
                            <div class="col-md-6">
                                <label for="{{ form.proveedor.id_for_label }}" class="form-label fw-medium">
                                    {% lino_icon "bi-building" "me-2 text-olive" %}
                                    {{ form.proveedor.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.proveedor }}
                                {% if form.proveedor.help_text %}
                                    <div class="form-text">
                                        {% lino_icon "bi-info-circle" "me-1" %}
                                        {{ form.proveedor.help_text }}
                                    </div>
                                {% endif %}
                                {% if form.proveedor.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.proveedor.errors %}
                                            {% lino_icon "bi-exclamation-triangle" "me-1" %}{{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Cantidad -->
                            <div class="col-md-6">
                                <label for="{{ form.cantidad_mayoreo.id_for_label }}" class="form-label fw-medium">
                                    {% lino_icon "bi-123" "me-2 text-primary" %}
                                    {{ form.cantidad_mayoreo.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    {{ form.cantidad_mayoreo }}
                                    <span class="input-group-text">
                                        {% lino_icon "bi-rulers" "me-1" %}
                                        <span id="unidad-medida">Unidad</span>
                                    </span>
                                </div>
                                {% if form.cantidad_mayoreo.help_text %}
                                    <div class="form-text">
                                        {% lino_icon "bi-info-circle" "me-1" %}
                                        {{ form.cantidad_mayoreo.help_text }}
                                    </div>
                                {% endif %}
                                {% if form.cantidad_mayoreo.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.cantidad_mayoreo.errors %}
                                            {% lino_icon "bi-exclamation-triangle" "me-1" %}{{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Precio Total -->
                            <div class="col-md-6">
                                <label for="{{ form.precio_mayoreo.id_for_label }}" class="form-label fw-medium">
                                    {% lino_icon "bi-currency-dollar" "me-2 text-success" %}
                                    {{ form.precio_mayoreo.label }}
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.precio_mayoreo }}
                                </div>
                                {% if form.precio_mayoreo.help_text %}
                                    <div class="form-text">
                                        {% lino_icon "bi-info-circle" "me-1" %}
                                        {{ form.precio_mayoreo.help_text }}
                                    </div>
                                {% endif %}
                                {% if form.precio_mayoreo.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.precio_mayoreo.errors %}
                                            {% lino_icon "bi-exclamation-triangle" "me-1" %}{{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Precio Unitario Calculado -->
                            <div class="col-md-6">
                                <label class="form-label fw-medium text-muted">
                                    {% lino_icon "bi-calculator" "me-2" %}
                                    Precio Unitario (Calculado)
                                </label>
                                <div class="form-control-plaintext bg-light p-3 rounded">
                                    <div class="d-flex align-items-center">
                                        <span id="precio-unitario" class="fw-bold text-primary fs-5">$0.00</span>
                                        <span class="text-muted ms-2">por unidad</span>
                                    </div>
                                    <div class="small text-muted mt-1">Se calcula automáticamente: Precio Total ÷ Cantidad</div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-flex gap-3 mt-4 pt-3 border-top">
                            {% lino_btn "Guardar Compra" "#" "primary" "lg" "bi-check2-circle" "type='submit'" %}
                            {% lino_btn "Cancelar" "{% url 'gestion:lista_compras_migrado' %}" "outline" "lg" "bi-arrow-left" %}
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Panel de ayuda -->
        <div class="col-lg-4">
            <div class="lino-card">
                {% lino_card_header "Ayuda" "bi-question-circle" "brown" %}
                <div class="lino-card-content">
                    <div class="d-grid gap-3">
                        
                        <!-- Consejos -->
                        <div class="p-3 bg-light rounded">
                            <div class="d-flex align-items-start">
                                {% lino_icon "bi-lightbulb" "text-warning me-2 mt-1" %}
                                <div>
                                    <div class="fw-medium small">Consejo</div>
                                    <div class="small text-muted">Verifica el precio unitario calculado antes de guardar</div>
                                </div>
                            </div>
                        </div>

                        <div class="p-3 bg-light rounded">
                            <div class="d-flex align-items-start">
                                {% lino_icon "bi-shield-check" "text-success me-2 mt-1" %}
                                <div>
                                    <div class="fw-medium small">Automático</div>
                                    <div class="small text-muted">El stock se actualiza automáticamente al guardar</div>
                                </div>
                            </div>
                        </div>

                        <div class="p-3 bg-light rounded">
                            <div class="d-flex align-items-start">
                                {% lino_icon "bi-graph-up" "text-earth me-2 mt-1" %}
                                <div>
                                    <div class="fw-medium small">Control de Costos</div>
                                    <div class="small text-muted">El precio unitario actualiza los costos de producción</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Acciones rápidas -->
                    <div class="border-top pt-3 mt-3">
                        <div class="fw-medium small mb-2">Acciones Rápidas</div>
                        <div class="d-grid gap-2">
                            {% lino_btn "Ver Compras" "{% url 'gestion:lista_compras_migrado' %}" "earth" "sm" "bi-list-ul" %}
                            {% lino_btn "Materias Primas" "{% url 'gestion:lista_materias_primas_migrado' %}" "olive" "sm" "bi-box2" %}
                            {% lino_btn "Nueva Materia Prima" "{% url 'gestion:crear_materia_prima_migrado' %}" "brown" "sm" "bi-plus-circle" %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estadísticas recientes -->
            <div class="lino-card mt-4">
                {% lino_card_header "Últimas Compras" "bi-clock-history" "warning" %}
                <div class="lino-card-content">
                    <div class="row g-2">
                        <div class="col-6">
                            {% lino_value_box "12" "Este Mes" "success" "sm" %}
                        </div>
                        <div class="col-6">
                            {% lino_value_box "$2,450" "Invertido" "earth" "sm" %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para cálculos en tiempo real -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const materiaPrimaSelect = document.getElementById('{{ form.materia_prima.id_for_label }}');
    const cantidadInput = document.getElementById('{{ form.cantidad_mayoreo.id_for_label }}');
    const precioTotalInput = document.getElementById('{{ form.precio_mayoreo.id_for_label }}');
    const unidadMedidaSpan = document.getElementById('unidad-medida');
    const precioUnitarioSpan = document.getElementById('precio-unitario');

    // Datos de materias primas para JavaScript
    const materiasPrimas = {
        {% for mp in form.materia_prima.queryset %}
        '{{ mp.id }}': {
            'unidad_medida': '{{ mp.unidad_medida }}',
            'proveedor': '{{ mp.proveedor|default:"" }}'
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    // Actualizar unidad de medida cuando cambia la materia prima
    materiaPrimaSelect.addEventListener('change', function() {
        const mpId = this.value;
        if (mpId && materiasPrimas[mpId]) {
            unidadMedidaSpan.textContent = materiasPrimas[mpId].unidad_medida;
            // Actualizar proveedor si está disponible
            const proveedorInput = document.getElementById('{{ form.proveedor.id_for_label }}');
            if (materiasPrimas[mpId].proveedor) {
                proveedorInput.value = materiasPrimas[mpId].proveedor;
            }
        } else {
            unidadMedidaSpan.textContent = 'Unidad';
        }
        calcularPrecioUnitario();
    });

    // Calcular precio unitario en tiempo real
    function calcularPrecioUnitario() {
        const cantidad = parseFloat(cantidadInput.value) || 0;
        const precioTotal = parseFloat(precioTotalInput.value) || 0;
        
        if (cantidad > 0 && precioTotal > 0) {
            const precioUnitario = precioTotal / cantidad;
            precioUnitarioSpan.textContent = '$' + precioUnitario.toFixed(2);
        } else {
            precioUnitarioSpan.textContent = '$0.00';
        }
    }

    // Escuchar cambios en cantidad y precio total
    cantidadInput.addEventListener('input', calcularPrecioUnitario);
    precioTotalInput.addEventListener('input', calcularPrecioUnitario);

    // Inicializar
    if (materiaPrimaSelect.value) {
        materiaPrimaSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}
